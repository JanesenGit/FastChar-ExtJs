<!DOCTYPE html>
<!--suppress ALL -->
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <meta name="google" content="notranslate"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <base href="${http}">
    <script src="js/jquery.js"></script>
    <script src="base/lottie/lottie.min.js"></script>
    ${head}

    <style type="text/css">
        html {
            overflow: hidden !important;
        }
        body {
            margin: 0px;
            padding: 0px;
        }
        .progress {
            height: 3px;
            position: fixed;
            top: 0px;
            width: 100%;
        }

        .progress > svg {
            height: 100%;
            display: block;
        }

        #loading {
            height: 100%;
            width: 100%;
            position: fixed;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: ${color};
            overflow: hidden;
        }

        #loading-center {
            width: 30%;
            height: 30%;
            overflow: hidden;
        }
    </style>
</head>

<body style="width: 100%;height: 100%;overflow: hidden;">
<div id="loading">
    <div id="loading-center">
    </div>
</div>
</body>
<script>
    console.log("%cFastChar-ExtJs框架提供技术支持！http://www.fastchar.com", "color: #8d9294;");
</script>
<script>
    let data = null, powerValue = "${power}", loadIndex = [], fontSize = "${fontSize}";
    $(function () {
        let lottie = bodymovin.loadAnimation({
            container: document.getElementById("loading-center"),
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: "waiting_anim.json"
        });

        lottie.addEventListener("data_ready", function () {
            if (checkBroswer()) {
                $.post("loadApp", function (result) {
                    if (result.success) {
                        data = result.data;
                        load(0);
                    } else {
                        alert(result.message);
                    }
                });
            }
        });
    });

    function removeLoading() {
        $("#loading").remove();
    }

    function load(index) {
        try {
            if (index >= data.length) {
                return;
            }
            if (loadIndex.indexOf(index) > -1) {
                return;
            }
            loadIndex.push(index);
            let head = data[index];
            if (head == null) {
                load(index + 1);
                return;
            }
            if (head.tag == "link") {
                addLink(head, function () {
                    load(index + 1);
                });
            } else if (head.tag == "script") {
                addScript(head, function () {
                    load(index + 1);
                });
            } else if (head.tag == "style") {
                addStyle(head, function () {
                    load(index + 1);
                });
            } else {
                load(index + 1);
            }
        } catch (e) {
            console.error(e);
            alert("系统加载失败，请您稍后重试！" + e);
        }
    }


    function addScript(script, callBack) {
        if (script == null) return;
        let oHead = document.getElementsByTagName('head').item(0);
        let oScript = document.createElement("script");
        let isCode = false;
        oScript.type = "text/javascript";
        if (script.src != null && script.src.length > 0) {
            oScript.src = script.src + "?v=" + getExt("version").value;
        } else if (script.href != null && script.href.length > 0) {
            oScript.src = script.href + "?v=" + getExt("version").value;
        } else if (script.text) {
            try {
                oScript.appendChild(document.createTextNode(script.text));
            } catch (ex) {
                oScript.text = script.text;
            }
            isCode = true;
        } else {
            if (callBack != null) {
                callBack();
            }
            return;
        }
        oHead.appendChild(oScript);
        if (isCode) {
            if (callBack != null) {
                callBack();
            }
            return;
        }
        oScript.onload = oScript.readystatechange = function () {
            if (callBack != null) {
                callBack();
            }
        };
        oScript.onerror = function () {
            alert("脚本文件" + script.src + "加载失败，请您稍后重试！");
        };
    }

    function addLink(link, callBack) {
        if (link == null) return;
        let oHead = document.getElementsByTagName('head').item(0);
        let oLink = document.createElement("link");
        oLink.rel = link.rel;
        oLink.href = link.href + "?v=" + getExt("version").value;
        oHead.appendChild(oLink);
        if (link.rel != "stylesheet") {
            if (callBack != null) {
                callBack();
            }
            return;
        }
        oLink.onload = oLink.readystatechange = function () {
            if (callBack != null) {
                callBack();
            }
        };
        oLink.onerror = function () {
            alert("系统文件" + link.href + "加载失败，请您稍后重试！");
        };
    }

    function addStyle(style, callBack) {
        let oHead = document.getElementsByTagName('head').item(0);
        let oStyle = document.createElement("style");
        oStyle.type = "text/css";
        if (oStyle.styleSheet) {
            oStyle.styleSheet.cssText = style.text;
        } else {
            oStyle.innerHTML = style.text;
        }
        if (callBack != null) {
            callBack();
        }
        oHead.appendChild(oStyle);
    }

    function getExt(name) {
        for (let i = 0; i < data.length; i++) {
            let head = data[i];
            if (head.tag == "ext" && head.name == name) {
                return head;
            }
        }
        return null;
    }

    function getAllExt() {
        let exts = [];
        for (let i = 0; i < data.length; i++) {
            let head = data[i];
            if (head.tag == "ext") {
                exts.push(head);
            }
        }
        return exts;
    }

    function isPower() {
        try {
            return eval(powerValue);
        } catch (e) {
        }
        return false;
    }


    function getScrollBarWidth() {
        let el = document.createElement("p"),
            styles = {
                width: "100px",
                height: "100px",
                overflowY: "scroll"
            },
            i;

        for (i in styles) {
            el.style[i] = styles[i];
        }
        document.body.appendChild(el);
        let scrollBarWidth = el.offsetWidth - el.clientWidth;
        el.remove();
        return scrollBarWidth;
    }


    function checkBroswer() {
        let browser = navigator.appName
        let version = parseFloat(navigator.appVersion)
        if (browser == "Microsoft Internet Explorer") {
            if (version < 11) {
                alert("您当前的IE版本太低，至少在IE11以上才能使用本系统！");
                return false;
            }
        }
        return true;
    }

</script>
</html>