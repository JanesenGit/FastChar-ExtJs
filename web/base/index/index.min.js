const system={lastTabId:-1,dateFormat:"Y-m-d H:i:s",init:!1,manager:null,menus:null,http:null,baseUrl:null,regByImage:/\.(jpg|png|gif|jpeg)$/i,regByMP4:/\.(mp4)$/i,regByExcel:/\.(xls|xlsx)$/i,regByWord:/\.(doc)$/i,regByText:/\.(txt)$/i,tabPanelContainer:null,fullscreen:!1,inFullScreen:function(){try{let e=document.documentElement;e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(),this.fullscreen=!0}catch(e){console.error(e)}},validOperate:function(i,a,l){if(i){var s=$.cookie("ValidOperate"+$.md5(i));if(l=l||86400,s)a();else{let e="normal"===getExt("login-type").value;s=5*getNumberValue(fontSize)+8;let t=function(){let e=n.form;var t;e.isValid()&&(t=n.form.findField("loginPassword").getValue(),e.submit({params:{loginPassword:$.md5(t),operate:i,timeout:l},waitMsg:"正在为您验证中……",success:function(e,t){r.close(),a()},failure:function(e,t){o(),Ext.Msg.alert("验证失败",t.result.message,function(){-3===t.result.code&&n.form.findField("validateCode").focus()})}}))},n=Ext.create("Ext.form.FormPanel",{url:server.validOperateUrl(),method:"POST",fileUpload:!0,border:0,width:"100%",layout:"anchor",region:"center",bodyStyle:{},padding:"10 10 0 10",items:[{xtype:"textfield",fieldLabel:"登录账号",labelAlign:"right",labelWidth:s,margin:"10 10 0 0",name:"loginName",allowBlank:!1,blankText:"请输入当前登录名",emptyText:"请输入当前登录名",anchor:"100%"},{xtype:"textfield",fieldLabel:"登录密码",labelAlign:"right",labelWidth:s,inputType:"password",margin:"10 10 0 0",allowBlank:!1,blankText:"请输入登录密码",emptyText:"请输入登录密码",submitValue:!1,name:"loginPassword",anchor:"100%"},{xtype:"fieldcontainer",labelWidth:0,anchor:"100%",layout:{type:"hbox",align:"stretch"},hidden:e,items:[{xtype:"textfield",fieldLabel:"验证码",labelAlign:"right",labelWidth:s,margin:"10 10 0 0",allowBlank:e,flex:1,name:"validateCode",emptyText:"请输入验证码",blankText:"请输入验证码"},{xtype:"image",margin:"10 10 0 0",width:70,id:"imgCode",height:32}]},{xtype:"fieldcontainer",labelWidth:0,anchor:"100%",layout:{type:"hbox",align:"stretch"},items:[{xtype:"button",text:"取消",iconCls:"extIcon extReset",flex:1,tipText:"取消验证",margin:"10 5 10 10",handler:function(){r.close()}},{xtype:"button",text:"确定",tipText:"确定验证",margin:"10 10 10 5",iconCls:"extIcon extOk",flex:1,handler:function(){t()}}]}],listeners:{render:function(e){try{new Ext.util.KeyMap({target:e.getEl(),key:13,fn:t,scope:Ext.getBody()})}catch(e){console.error(e)}}}}),o=function(){try{n.form.findField("validateCode").reset(),Ext.getCmp("imgCode").setSrc("showCaptcha?t="+Math.random())}catch(e){}};s=Ext.create("Ext.panel.Panel",{region:"south",layout:"fit",width:"100%",border:0,html:"<div align='center' style='font-size: small;color:red;text-decoration:none; padding-left: 40px;padding-right: 40px;padding-bottom: 10px;'>完成验证后将自动继续《"+i+"》操作</div>"});let r=Ext.create("Ext.window.Window",{title:"当前操作需要安全验证",iconCls:"extIcon extPower",width:380,resizable:!1,layout:"vbox",toFrontOnShow:!0,modal:!0,constrain:!0,items:[n,s]});r.show(null,function(){try{e||(o(),Ext.get("imgCode").on({click:function(){o()}}))}catch(e){}})}}},outFullscreen:function(){try{document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),this.fullscreen=!1}catch(e){console.error(e)}},formatUrl:function(e,t){return e.startWith("http://")||e.startWith("https://")?e:this.formatUrlVersion(this.http+e,t)},formatUrlVersion:function(e,t){let n=e;if(e.indexOf("v=")<0&&(n=0<e.indexOf("?")?e+"&v="+this.version.value:e+"?v="+this.version.value),t)for(var o in t)t.hasOwnProperty(o)&&(n=n+"&"+o+"="+t[o]);return n},isSuperRole:function(){var e=this;return!(!e.manager||!e.manager.role||0!==e.manager.role.roleType)},initConfig:function(){let a=this;a.baseUrl=window.location.href,0<a.baseUrl.indexOf("#")&&(a.baseUrl=a.baseUrl.split("#")[0]),a.baseUrl.toString().endWith("/")||(a.baseUrl=a.baseUrl+"/");let e={};isPower()&&window.parent&&Ext.isFunction(window.parent.getMenuPower)&&(e={menuPower:window.parent.getMenuPower()}),Ext.Ajax.request({url:server.showConfigUrl(),params:e,success:function(e,t){let n=jsonToObject(e.responseText).data;for(var o in n)n.hasOwnProperty(o)&&(a[o]=n[o]);var r=getAllExt();for(let e=0;e<r.length;e++){var i=r[e];a[i.name]=i}a.loadAppJs()},failure:function(e,t){showException(e.responseText,"获取系统配置！[system.initConfig]")}})},loadAppJs:function(e){let t=this;if((e=e||0)>=t.app.length)return Ext.MessageBox.updateProgress(1,"已加载成功，正在显示中"),void addScript({src:t.formatUrlVersion(getExt("welcomeUrl").value)},function(){addStyle({text:t.menusCss},function(){t.globalConfig()})});Ext.MessageBox.updateProgress(parseFloat(e+1)/parseFloat(t.length),"正在加载中，请耐心等待"),addScript({src:t.app[e]},function(){t.loadAppJs(e+1)})},globalConfig:function(){let me=this,entities=me.entities;for(let i=0;i<entities.length;i++){let entity=entities[i];for(var key in entity)if(entity.hasOwnProperty(key))try{let pro=eval(entity.entityCode+".prototype");pro[key]=entity[key],entity.js=!0}catch(e){entity.js=!1;break}}if(isPower()&&window.parent&&Ext.isFunction(window.parent.getExtPower)){if(power.config=!0,power.powers=jsonToObject(window.parent.getExtPower()),power.powers||(power.powers={}),system.managerPowers=jsonToObject(window.parent.getParentExtPower()),system.managerPowers)for(var code in power.powers)if(system.managerPowers.hasOwnProperty(code)){let managerPower=system.managerPowers[code];for(var managerPowerKey in managerPower)managerPower[managerPowerKey]||(power.powers[code][managerPowerKey]=!1)}window.getExtPower=function(){return power.savePower()}}Ext.Ajax.on("beforerequest",function(e,t,n){try{if(server.isSilenceRequest())return;getProgressLine(toColor(getExt("front-color").value)).set(0),getProgressLine(toColor(getExt("front-color").value)).animate(.7)}catch(e){}}),Ext.Ajax.on("requestcomplete",function(conn,response,options){try{if(203===response.status)me.sessionOut(),me.callback=null,me.success=null;else try{let jsonData=eval("("+response.responseText+")");203===jsonData.code&&me.sessionOut()}catch(e){}getProgressLine(toColor(getExt("front-color").value)).animate(1)}catch(e){}}),Ext.Ajax.on("requestexception",function(e,t,n,o){try{if(server.isSilenceRequest())return;showException(t.responseText,"请求异常！")}catch(e){}}),$(document).ajaxStart(function(e){try{if(server.isSilenceRequest())return;getProgressLine(toColor(getExt("front-color").value)).set(0),getProgressLine(toColor(getExt("front-color").value)).animate(.7)}catch(e){}}),$(document).ajaxComplete(function(event,xhr,options){try{if(203===xhr.status)me.sessionOut();else try{let jsonData=eval("("+xhr.responseText+")");203===jsonData.code&&me.sessionOut()}catch(e){}getProgressLine(toColor(getExt("front-color").value)).animate(1)}catch(e){}}),$(document).ajaxError(function(e,t,n){try{if(server.isSilenceRequest())return;showException(t.responseText,"请求异常")}catch(e){}}),window.addEventListener("popstate",function(e){me.selectTab(me.selectTabFromHref())},!1),me.init=!0,me.initSystem()},selectTabFromHref:function(){let e=window.location.href;return 0<e.indexOf("#")?e.substring(e.lastIndexOf("/")+1):null},initSystem:function(){removeLoading();let n=this,e=getBodyContainer();e.removeAll();var t=toColor(n["theme-color"].value),o=toColor(n["front-color"].value);let r=n["system-logo"].value;var i=n.version.desc,a=$("title").text()+i;Ext.isEmpty(r)&&(r="icons/icon_head_system.svg");var l=Ext.create("Ext.toolbar.Toolbar",{height:60,padding:"0 0 0 0",border:0,flex:1,power:!1,cls:"headContainer",style:{background:t},items:[{xtype:"image",src:r,height:40,width:40,cls:"headLogo",margin:"10 5 5 5",style:{borderRadius:"10px"}},{xtype:"label",margin:"0 0 0 5",html:"<div class='headTitle' style='color: "+o+";' >"+a+"</div>"},"->",{xtype:"button",iconCls:"extIcon extRole",text:n.manager.managerName,minWidth:135,cls:"headButton",menu:[{text:"修改登录密码",iconCls:"extIcon extResetPassword",handler:function(){n.modifyPassword(this)}}]},{xtype:"button",iconCls:"extIcon extExits",text:"退出登录",cls:"headButton",handler:function(){n.logout()}}]}),i=Ext.create("Ext.toolbar.Toolbar",{border:0,padding:"0 0 0 0",flex:1,height:3,style:{background:t},html:'<div class="progress" id="progress"></div>'}),o=Ext.create("Ext.panel.Panel",{layout:"absolute",region:"north",height:60,border:0,hidden:power.config,items:[l,i],listeners:{afterlayout:function(){this.getEl().on("dblclick",function(){system.fullscreen?system.outFullscreen():system.inFullScreen()})}}}),a=parseInt((.25*document.body.clientWidth).toFixed(0)),l=Ext.create("Ext.panel.Panel",{border:0,region:"center",cls:"treelist-with-nav",scrollable:"y",items:[{xtype:"treelist",id:"leftTreeList",reference:"treelist",expanderOnly:!1,singleExpand:!0,ui:"nav",scrollable:"y",expanderFirst:!1,selectOnExpander:!0,highlightPath:!0,store:{type:"tree",root:{expanded:!0,children:n.menus}},viewModel:{formulas:{selectionItem:function(e){try{var t=e("treelist.selection");return t&&t.data.leaf&&n.showTab(t.data.method,t.data.id,t.data.text,t.data.icon),t}catch(e){showException(e)}}}}}],listeners:{resize:function(e,t,n,o,r,i){var a=t<=128;let l=Ext.getCmp("leftTreeList"),s=l.ownerCt.ownerCt;l.setMicro(a),a?s.setWidth(44):s.setWidth(t)}}});n.tabPanelContainer=Ext.create("Ext.tab.Panel",{region:"center",id:"tabs",plain:!0,style:{marginTop:"-8px"},items:[],recordTab:function(){system.recordTab()},plugins:["tabreorderer",{ptype:"tabclosemenu"}]});i=Ext.create("Ext.panel.Panel",{layout:"border",region:"center",border:0,style:{background:"#eeeeee"},items:[n.tabPanelContainer]});let s=Ext.create("Ext.panel.Panel",{layout:"border",region:"west",border:0,width:a,minWidth:44,maxWidth:500,subtitle:"左侧菜单",split:!0,style:{background:"#32404e"},items:[{xtype:"image",height:35,border:0,padding:"5 5 5 5",region:"south",src:server.getIcon("icon_v_menu.svg"),cls:"leftBottom",listeners:{el:{click:function(){s.getWidth()<=44?null!=s.oldWidth?s.setWidth(Math.max(200,s.oldWidth)):s.setWidth(200):(s.oldWidth=s.getWidth(),s.setWidth(44))}}}},l]});n.tabPanelContainer.add({title:"首页",xtype:"panel",id:"tabWelcome",reorderable:!1,closable:!1,layout:"fit",iconCls:"extIcon extIndex",justFixed:!0,items:[getWelcomePanel()],listeners:{beforeactivate:function(e){try{n.selectMenu(n.lastTabId,!0)}catch(e){}},activate:function(e){var t;n.restoredTab&&(t={title:e.title,url:n.baseUrl},window.history.pushState(t,e.title,n.baseUrl))}}});i=Ext.create("Ext.panel.Panel",{layout:"border",border:0,bodyStyle:{background:t},items:[o,s,i]});e.add(i);let c=n.selectTabFromHref(!1);toBool(n["tab-record"].value,!0)?(Ext.MessageBox.updateProgress(1,"即将完成操作，请耐心等待","系统初始化成功！获取菜单中…"),n.restoreTab().then(function(e){Ext.MessageBox.isVisible()&&Ext.MessageBox.hide();e=jsonToObject(e);n.restoredTab=!0,e&&(Ext.each(e,function(e){c===e.id&&(e.active=!0),n.showTab(e.method,e.id,e.title,e.icon,e.active,!0,e.where,e.closable,e.reorderable)}),0!==e.length&&n.tabPanelContainer.getActiveTab()||n.tabPanelContainer.setActiveTab(Ext.getCmp("tabWelcome")))})):(Ext.MessageBox.isVisible()&&Ext.MessageBox.hide(),n.tabPanelContainer.setActiveTab(Ext.getCmp("tabWelcome")))},asyncMethod:function(method){return new Ext.Promise(function(resolve,reject){try{let itemValue=eval(method);resolve(itemValue)}catch(e){resolve(null),console.error(e)}})},showTab:function(i,a,t,n,o,l,s,c,d){let u=this,x=Ext.getCmp("tabs");if(!x.getActiveTab()||a!==x.getActiveTab().getId()){n&&0!==n.length||(n=server.getIcon("icon_function.svg")),Ext.isEmpty(l)&&(l=!0),Ext.isEmpty(o)&&(o=!0);let r=function(e,n){if(e){var o=u.getMenu(e.getId());if(o){let t=Ext.get(e.tabBtnId+"-btnIconEl");if(t){let e=o.color;n&&(e=toColor(u["theme-color"].value)),t.setStyle("background-image","url("+server.getIcon(o.iconName,e)+")")}}}},e=Ext.getCmp(a);e=e||x.add({xtype:"panel",id:a,code:a,icon:n,layout:"fit",title:t,border:0,tabContainer:!0,closable:toBool(c,!0),reorderable:toBool(d,!0),methodInvoked:!1,method:i,where:s,items:[],tabBtnId:null,doFixed:function(){var e,t=this;t.tab.setClosable(!t.tab.closable),t.tab.closable?(t.reorderable=t.tab.reorderable=!0,(e=system.findLastTag())&&x.moveAfter(t,e)):((e=system.findLastTag())&&x.moveAfter(t,e),t.reorderable=t.tab.reorderable=!1),Ext.isFunction(x.recordTab)&&x.recordTab()},doCopyUrl:function(){copyToBoard(system.baseUrl+"#/"+this.title+"/"+this.id),toast("复制成功！")},listeners:{deactivate:function(t){try{r(t,!1);let e=t.down("[entityList=true]");e&&e.onTabDeactivate&&e.onTabDeactivate(t)}catch(e){console.error(e)}},activate:function(n){if(n){if(u.lastTabId=n.id,u.existMenu(n.id)&&u.selectMenu(n.id,!1),r(n,!0),n.methodInvoked){let e=n.down("[entityList=true]");e&&e.onTabActivate&&e.onTabActivate(n)}else u.asyncMethod(i).then(function(t){try{if(!t)return;n.methodInvoked=!0;let e=t.down("[entityList=true]");e&&(e.where=mergeJson(n.where,e.where),e.code=$.md5(a)),n.add(t)}catch(e){console.error(e)}});try{let e=window.location.href;if(0<e.indexOf("#")){var t=e.substring(e.lastIndexOf("/")+1);if(n.id===t)return}var o={title:n.title,url:u.baseUrl+"#/"+n.title+"/"+n.id};window.history.pushState(o,n.title,u.baseUrl+"#/"+n.title+"/"+n.id)}catch(e){console.error(e)}u.recordTab()}},afterlayout:function(e,t,n){try{Ext.get(this.tabBtnId).dom.ondblclick=function(){let n=e.getId();x.items.each(function(e,t){0!==t&&e.id===n&&e.closable&&e.close()})},x.getActiveTab()&&x.getActiveTab().getId()===e.getId()&&r(e,!0)}catch(e){}},destroy:function(e,t){u.recordTab()}},initEvents:function(){this.tabBtnId=this.getEl().getAttribute("aria-labelledby")}}),o&&(x.getActiveTab()&&x.getActiveTab().getId()===e.getId()||(!l||(l=u.findLastTag())&&Ext.getCmp("tabs").moveAfter(e,l),x.setActiveTab(e)))}},findLastTag:function(){var t=Ext.getCmp("tabs");for(let e=t.items.items.length-1;0<=e;e--){var n=t.items.items[e];if(n&&!toBool(n.tab.closable,!0)&&!toBool(n.tab.reorderable,!0))return n}return null},recordTab:function(){return new Ext.Promise(function(n,t){try{let o=[],r=Ext.getCmp("tabs");r.items.each(function(e,t){let n={};Ext.isEmpty(e.method)||(n.method=e.method,n.where=e.where,n.title=e.title,n.icon=e.icon,n.id=e.id,n.closable=e.closable,n.reorderable=e.reorderable,n.active=e===r.getActiveTab(),o.push(n))}),server.saveExtConfig("SystemTabs","TabRecord",objectToJson(o),function(e,t){n(e)})}catch(e){t(e)}})},restoreTab:function(){return new Ext.Promise(function(n,t){try{server.showExtConfig("SystemTabs","TabRecord",function(e,t){n(t)})}catch(e){t(e)}})},selectTab:function(e){let t=Ext.getCmp(e);return t?(this.tabPanelContainer.setActiveTab(t),t.focus(),!0):this.selectMenu(e,!1)},addTab:function(e,t,n,o){let r=Ext.getCmp(t);r=r||this.tabPanelContainer.add({title:n,xtype:"panel",id:t,code:t,icon:o,border:0,tabContainer:!0,closable:!0,reorderable:!0,layout:"fit",items:[e]}),this.tabPanelContainer.setActiveTab(r)},selectMenu:function(n,o){try{Ext.isEmpty(o)&&(o=!1);let t=Ext.getCmp("leftTreeList"),e=t.getStore().getNodeById(n);if(!e)return!1;var r=e.get("parentId");if(!Ext.isEmpty(r)){let e=t.getStore().getNodeById(r);if(o)return t.setSelection(e),void e.collapse();"root"!==r&&(e.expand(!1,!0),this.selectMenu(r,o))}return t.setSelection(e),!0}catch(e){showException(e,"选择菜单！[system.selectMenu]")}},existMenu:function(e){let t=Ext.getCmp("leftTreeList");return null!=t.getStore().getNodeById(e)},getMenu:function(t){let e=Ext.getCmp("leftTreeList");t=e.getStore().getNodeById(t);if(t){let e=t.data;return e&&e.parentId&&"root"!==e.parentId&&(e.parent=this.getMenu(e.parentId)),e}return null},logout:function(){Ext.Msg.confirm("系统提示","<br/>您是否确定退出登录吗？",function(e){"yes"===e&&server.logout()})},sessionOut:function(){if(!this.sessionOutAlert){Ext.MessageBox.hide(),this.sessionOutAlert=!0;let e=Ext.create("Ext.window.Window",{title:"系统提醒",height:150,width:250,layout:"fit",resizable:!1,maximizable:!1,sessionWin:!0,fixed:!0,draggable:!1,iconCls:"extIcon extSessionOut",html:"<div  style='padding:15px;background: #fff;'>会话失效，请您重新登录！</div>",modal:!0,alwaysOnTop:!0,toFrontOnShow:!0,buttons:[{text:"重新登录",iconCls:"extIcon extLogin",flex:1,handler:function(){e.close()}}],listeners:{destroy:function(e,t){isPower()?window.parent.close():location.reload()}}});e.show()}},modifyPassword:function(e){let t=Ext.create("Ext.form.FormPanel",{url:"controller/modifyPassword",method:"POST",fileUpload:!0,border:0,width:"100%",layout:"anchor",region:"center",bodyStyle:{},items:[{xtype:"textfield",fieldLabel:"当前密码",labelAlign:"right",labelWidth:60,margin:"10 10 10 10",name:"managerPassword",allowBlank:!1,inputType:"password",blankText:"请输入用户当前密码",anchor:"100%"},{xtype:"textfield",fieldLabel:"新密码",labelAlign:"right",labelWidth:60,margin:"10 10 10 10",name:"newPassword",allowBlank:!1,inputType:"password",blankText:"请输入用户新密码",anchor:"100%"},{xtype:"textfield",fieldLabel:"确认密码",labelAlign:"right",labelWidth:60,margin:"10 10 10 10",name:"reNewPassword",allowBlank:!1,inputType:"password",blankText:"请确认密码",anchor:"100%"},{xtype:"hiddenfield",name:"managerId",value:this.manager.managerId},{xtype:"fieldcontainer",labelWidth:0,layout:"column",items:[{xtype:"button",text:"立即修改",margin:"10 10 10 5",iconCls:"extIcon extOk",columnWidth:1,handler:function(){n()}}]}],listeners:{render:function(e){try{new Ext.util.KeyMap({target:e.getEl(),key:13,fn:n,scope:Ext.getBody()})}catch(e){console.error(e)}}}}),n=function(){let e=t.form;e.isValid()&&e.submit({waitMsg:"正在修改中……",success:function(e,t){toast(t.result.message),o.close(),t.result.success&&Ext.Msg.alert("系统提醒","您当前的密码已被修改，请您重新登录！",function(){server.logout()})},failure:function(e,t){Ext.Msg.alert("系统提醒",t.result.message)}})},o=Ext.create("Ext.window.Window",{title:"修改登录密码",height:250,icon:e.icon,iconCls:e.iconCls,width:400,layout:"border",resizable:!1,maximizable:!1,animateTarget:e,constrain:!0,items:[t],modal:!0});o.show()},getEntity:function(t){var n=this.entities;for(let e=0;e<n.length;e++){var o=n[e];if(o.entityCode===t)return o}return null},showPowerMenus:function(obj,checked,parent){return new Ext.Promise(function(resolve,reject){let dataStore=Ext.create("Ext.data.TreeStore",{proxy:{type:"ajax",url:"showPowerMenus",actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(obj,request,operation,eOpts){let data=eval("("+request.responseText+")");data.success||Ext.Msg.alert("数据获取失败",data.message)}},reader:{type:"json"}},root:{expanded:!0},listeners:{load:function(e,t,n){},beforeload:function(e,t){Ext.apply(e.proxy.extraParams,{checked:checked,parent:parent})}}}),treePanel=Ext.create("Ext.tree.Panel",{store:dataStore,rootVisible:!1,bufferedRenderer:!1,animate:!0,containerScroll:!0,autoScroll:!0,viewConfig:{loadMask:{msg:"加载功能菜单中，请稍后……"}},listeners:{checkchange:function(e,t,n,o){t?(e.bubble(function(e){e.set("checked",!0)}),e.cascadeBy(function(e){e.set("checked",!0)})):e.cascadeBy(function(e){e.set("checked",!1)})}}}),winWidth=parseInt((.4*document.body.clientWidth).toFixed(0)),winHeight=parseInt((.5*document.body.clientHeight).toFixed(0)),win=Ext.create("Ext.window.Window",{title:"权限配置（选择功能菜单）",height:winHeight,width:winWidth,minHeight:400,minWidth:470,layout:"fit",iconCls:"extIcon extSelect",resizable:!0,animateTarget:obj,maximizable:!0,constrain:!0,items:[treePanel],modal:!0,buttons:[{text:"重置",iconCls:"extIcon extReset",handler:function(){dataStore.reload()}},{text:"确定",iconCls:"extIcon extOk",handler:function(){var e=treePanel.getChecked();let t="";for(i=0;i<e.length;i++)t+=","+e[i].data.id;resolve(t),win.close()}}]});win.show()})},showPowerExt:function(e,o,r,i){return new Ext.Promise(function(e,t){window.getMenuPower=function(){return o},window.getExtPower=function(){return r},window.getParentExtPower=function(){return i},window.close=function(){Ext.getCmp("ExtPowerWindow").close()};let n=Ext.create("Ext.window.Window",{title:"配置界面权限（在组件上右击鼠标进行编辑权限）",id:"ExtPowerWindow",iconCls:"extIcon extPower",layout:"border",resizable:!1,maximized:!0,fixed:!0,draggable:!1,listeners:{show:function(e){e.update("<iframe name='extPowerFrame'  src='power?managerId=0' width='100%' height='100%' frameborder='0' scrolling='no' />")}},buttons:[{text:"保存权限配置",handler:function(){e(extPowerFrame.window.getExtPower()),n.close()}}]});n.show()})},showMenuColumns:function(obj,checked){return new Ext.Promise(function(resolve,reject){let dataStore=Ext.create("Ext.data.TreeStore",{proxy:{type:"ajax",url:"showMenuColumn",actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(obj,request,operation,eOpts){let data=eval("("+request.responseText+")");data.success||Ext.Msg.alert("数据获取失败",data.message)}},reader:{type:"json"}},root:{expanded:!0},listeners:{load:function(e,t,n){},beforeload:function(e,t){Ext.apply(e.proxy.extraParams,{checked:checked})}}}),treePanel=Ext.create("Ext.tree.Panel",{store:dataStore,rootVisible:!1,bufferedRenderer:!1,animate:!0,containerScroll:!0,autoScroll:!0,lastCheckNode:null,viewConfig:{loadMask:{msg:"加载功能菜单中，请稍后……"}},listeners:{checkchange:function(e,t,n,o){t?(e.bubble(function(e){e.set("checked",!0)}),e.cascadeBy(function(e){e.set("checked",!0)})):e.cascadeBy(function(e){e.set("checked",!1)})}}}),win=Ext.create("Ext.window.Window",{title:"搜索链配置",width:400,height:470,layout:"fit",iconCls:"extIcon extLink",resizable:!0,animateTarget:obj,maximizable:!0,constrain:!0,items:[treePanel],modal:!0,buttons:[{text:"重置",iconCls:"extIcon extReset",handler:function(){dataStore.reload()}},{text:"确定",iconCls:"extIcon extOk",handler:function(){let e=treePanel.getChecked(),n=[],t="";for(i=0;i<e.length;i++){if(e[i].isLeaf()){let t={};t.text=e[i].data.text,t.id=e[i].data.id,t.dataIndex=e[i].data.dataIndex,t.parentId=e[i].data.parentId;var o=treePanel.getStore().findNode("id",t.parentId,0,!1,!1,!0);if(o){let e={};o=o.data;e.text=o.text,e.id=o.id,e.method=o.method,e.icon=o.icon,t.parent=e,n.push(t)}}t+=","+e[i].data.id}resolve({checked:t,columns:n}),win.close()}}]});win.show()})}};function showList(menuId,entityCode,where){let entity=system.getEntity(entityCode);if(!entity)throw"操作失败！未获取到 '"+entityCode+"' 实体类！请检查实体类关联的表格是否存在！";if(!entity.js)throw"操作失败！未获取到 '"+entityCode+"' JS对象！";where=where||{};let entityJsObj=eval("new "+entityCode+"()");return entityJsObj.menu=system.getMenu(menuId),entityJsObj.getList(where)}Ext.onReady(function(){checkBrowserVersion()&&(Ext.MessageBox.show({alwaysOnTop:!0,modal:!0,title:"系统提醒",msg:"初始化系统中，请稍后……",progressText:"请耐心等待，即将完成操作",progress:!0,closable:!1}),system.initConfig())});