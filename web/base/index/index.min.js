const system={currTabId:-1,currTab:null,dateFormat:"Y-m-d H:i:s",init:false,manager:null,menus:null,http:null,regByImage:/\.(jpg|png|gif|jpeg)$/i,regByMP4:/\.(mp4)$/i,regByExcel:/\.(xls|xlsx)$/i,regByWord:/\.(doc)$/i,regByText:/\.(txt)$/i,tabPanelContainer:null,formatUrl:function(a,b){if(a.startWith("http://")||a.startWith("https://")){return a}return this.formatUrlVersion(this.http+a,b)},formatUrlVersion:function(a,b){let newUrl=a;if(a.indexOf("v=")<0){if(a.indexOf("?")>0){newUrl=a+"&v="+this.version.value}else{newUrl=a+"?v="+this.version.value}}if(b){for(let key in b){if(b.hasOwnProperty(key)){newUrl=newUrl+"&"+key+"="+b[key]}}}return newUrl},isSuperRole:function(){let me=this;if(me.manager&&me.manager.role){if(me.manager.role.roleType===0){return true}}return false},initConfig:function(){let me=this;let params={};if(isPower()){if(window.parent&&Ext.isFunction(window.parent.getMenuPower)){params={menuPower:window.parent.getMenuPower()}}}Ext.Ajax.request({url:server.showConfigUrl(),params:params,success:function(a,b){let data=jsonToObject(a.responseText).data;for(let key in data){if(data.hasOwnProperty(key)){me[key]=data[key]}}let allExt=getAllExt();for(let i=0;i<allExt.length;i++){let head=allExt[i];me[head.name]=head}me.loadAppJs()},failure:function(a,b){showException(a.responseText,"获取系统配置！[system.initConfig]")}})},loadAppJs:function(a){let me=this;if(!a){a=0}if(a>=me.app.length){Ext.MessageBox.updateProgress(1,"已加载成功，正在显示中");addScript({src:me.formatUrlVersion(getExt("welcomeUrl").value)},function(){addStyle({text:me.menusCss},function(){me.globalConfig()})});return}Ext.MessageBox.updateProgress(parseFloat(a+1)/parseFloat(me.length),"正在加载中，请耐心等待");addScript({src:me.app[a]},function(){me.loadAppJs(a+1)})},globalConfig:function(){let me=this;let entities=me.entities;for(let i=0;i<entities.length;i++){let entity=entities[i];for(let key in entity){if(entity.hasOwnProperty(key)){try{let pro=eval(entity.entityCode+".prototype");pro[key]=entity[key];entity.js=true}catch(e){entity.js=false;break}}}}if(isPower()){if(window.parent&&Ext.isFunction(window.parent.getExtPower)){power.config=true;power.powers=jsonToObject(window.parent.getExtPower());if(!power.powers){power.powers={}}system.managerPowers=jsonToObject(window.parent.getParentExtPower());if(system.managerPowers){for(let code in power.powers){if(system.managerPowers.hasOwnProperty(code)){let managerPower=system.managerPowers[code];for(let managerPowerKey in managerPower){if(!managerPower[managerPowerKey]){power.powers[code][managerPowerKey]=false}}}}}window.getExtPower=function(){return power.savePower()}}}Ext.Ajax.on("beforerequest",function(conn,options,eObj){try{if(server.isSilenceRequest()){return}getProgressLine(toColor(getExt("front-color").value)).set(0);getProgressLine(toColor(getExt("front-color").value)).animate(0.7)}catch(e){}});Ext.Ajax.on("requestcomplete",function(conn,response,options){try{if(response.status===203){me.sessionOut();me.callback=null;me.success=null}else{try{let jsonData=eval("("+response.responseText+")");if(jsonData.code===203){me.sessionOut()}}catch(e){}}getProgressLine(toColor(getExt("front-color").value)).animate(1)}catch(e){}});Ext.Ajax.on("requestexception",function(conn,response,options,eOpts){try{if(server.isSilenceRequest()){return}showException(response.responseText,"请求异常！")}catch(e){}});$(document).ajaxStart(function(obj){try{if(server.isSilenceRequest()){return}getProgressLine(toColor(getExt("front-color").value)).set(0);getProgressLine(toColor(getExt("front-color").value)).animate(0.7)}catch(e){}});$(document).ajaxComplete(function(event,xhr,options){try{if(xhr.status===203){me.sessionOut()}else{try{let jsonData=eval("("+xhr.responseText+")");if(jsonData.code===203){me.sessionOut()}}catch(e){}}getProgressLine(toColor(getExt("front-color").value)).animate(1)}catch(e){}});$(document).ajaxError(function(event,xhr,settings){try{if(server.isSilenceRequest()){return}showException(xhr.responseText,"请求异常")}catch(e){}});me.init=true;me.initSystem()},initSystem:function(){removeLoading();let me=this;let container=getBodyContainer();container.removeAll();let systemBgColor=toColor(me["theme-color"].value);let systemTlColor=toColor(me["front-color"].value);let systemLogo=me["system-logo"].value;let versionName=me.version.desc;let systemTitle=$("title").text()+versionName;if(Ext.isEmpty(systemLogo)){systemLogo="icons/icon_head_system.svg"}let headerInfo=Ext.create("Ext.toolbar.Toolbar",{height:60,padding:"0 0 0 0",border:0,flex:1,power:false,cls:"headContainer",style:{background:systemBgColor},items:[{xtype:"image",src:systemLogo,height:40,width:40,cls:"headLogo",margin:"10 5 5 5",style:{borderRadius:"10px"}},{xtype:"label",margin:"0 0 0 5",html:"<div class='headTitle' style='color: "+systemTlColor+";font-size: 20px;line-height: 20px;font-weight: 700;' >"+systemTitle+"</div>"},"->",{xtype:"button",iconCls:"extIcon extRole",text:me.manager.managerName,minWidth:135,cls:"headButton",menu:[{text:"修改登录密码",iconCls:"extIcon extResetPassword",handler:function(){me.modifyPassword(this)}}]},{xtype:"button",iconCls:"extIcon extExits",text:"退出登录",cls:"headButton",handler:function(){me.logout()}}]});let headerTip=Ext.create("Ext.toolbar.Toolbar",{border:0,padding:"0 0 0 0",flex:1,height:3,style:{background:systemBgColor},html:'<div class="progress" id="progress"></div>'});let headerPanel=Ext.create("Ext.panel.Panel",{layout:"absolute",region:"north",height:60,border:0,hidden:power.config,items:[headerInfo,headerTip]});let leftTreeWidth=200;let leftTreePanel=Ext.create("Ext.panel.Panel",{border:0,region:"center",cls:"treelist-with-nav",scrollable:"y",items:[{xtype:"treelist",id:"leftTreeList",reference:"treelist",expanderOnly:false,singleExpand:true,ui:"nav",scrollable:"y",expanderFirst:false,selectOnExpander:true,highlightPath:true,store:{type:"tree",root:{expanded:true,children:me.menus}},viewModel:{formulas:{selectionItem:function(a){try{let selection=a("treelist.selection");if(selection){if(selection.data.leaf){me.showTab(selection.data.method,selection.data.id,selection.data.text,selection.data.icon)}}return selection}catch(b){showException(b)}}}}}],listeners:{resize:function(e,d,a,b,f,c){let pressed=d<=128;let treelist=Ext.getCmp("leftTreeList");let ct=treelist.ownerCt.ownerCt;treelist.setMicro(pressed);if(pressed){ct.setWidth(44)}else{ct.setWidth(d)}}}});me.tabPanelContainer=Ext.create("Ext.tab.Panel",{region:"center",id:"tabs",plain:true,style:{marginTop:"-8px"},items:[],recordTab:function(){system.recordTab()},plugins:["tabreorderer",{ptype:"tabclosemenu"}]});let rightContainer=Ext.create("Ext.panel.Panel",{layout:"border",region:"center",border:0,style:{background:"#eeeeee"},items:[me.tabPanelContainer]});let leftContainer=Ext.create("Ext.panel.Panel",{layout:"border",region:"west",border:0,width:leftTreeWidth,minWidth:44,maxWidth:500,subtitle:"左侧菜单",split:true,style:{background:"#32404e"},items:[{xtype:"image",height:35,border:0,padding:"5 5 5 5",region:"south",src:server.getIcon("icon_v_menu.svg"),cls:"leftBottom",listeners:{el:{click:function(){if(leftContainer.getWidth()<=44){if(leftContainer.oldWidth!=null){leftContainer.setWidth(Math.max(200,leftContainer.oldWidth))}else{leftContainer.setWidth(200)}}else{leftContainer.oldWidth=leftContainer.getWidth();leftContainer.setWidth(44)}}}}},leftTreePanel]});me.tabPanelContainer.add({title:"首页",xtype:"panel",id:"tabWelcome",reorderable:false,closable:false,layout:"fit",iconCls:"extIcon extIndex",justFixed:true,items:[getWelcomePanel()],listeners:{activate:function(a){try{if(me.currTab){me.selectMenu(me.currTab.getId(),true);me.currTab=null}}catch(b){me.tabPanelContainer.setActiveTab(a)}}}});let containerPanel=Ext.create("Ext.panel.Panel",{layout:"border",border:0,bodyStyle:{background:systemBgColor},items:[headerPanel,leftContainer,rightContainer]});container.add(containerPanel);if(toBool(me["tab-record"].value,true)){Ext.MessageBox.updateProgress(1,"即将完成操作，请耐心等待","系统初始化成功！获取菜单中…");me.restoreTab().then(function(a){let tabs=jsonToObject(a);Ext.each(tabs,function(b){me.showTab(b.method,b.id,b.title,b.icon,b.active,true,b.where,b.closable,b.reorderable)});if(Ext.MessageBox.isVisible()){Ext.MessageBox.hide()}if(tabs.length===0||!me.tabPanelContainer.getActiveTab()){me.tabPanelContainer.setActiveTab(Ext.getCmp("tabWelcome"))}})}else{if(Ext.MessageBox.isVisible()){Ext.MessageBox.hide()}me.tabPanelContainer.setActiveTab(Ext.getCmp("tabWelcome"))}},asyncMethod:function(method){return new Ext.Promise(function(resolve,reject){try{let itemValue=eval(method);resolve(itemValue)}catch(e){resolve(null);console.error(e)}})},showTab:function(a,b,h,g,c,e,d,j,f){let me=this;if(me.currTab&&b===me.currTab.getId()){return}if(!g||g.length===0){g=server.getIcon("icon_function.svg")}if(Ext.isEmpty(e)){e=true}if(Ext.isEmpty(c)){c=true}let changeIcon=function(k,l){if(k){let menu=me.getMenu(k.getId());if(menu){let btnIconEl=Ext.get(k.tabBtnId+"-btnIconEl");if(btnIconEl){let color=menu.color;if(l){color=toColor(me["theme-color"].value)}btnIconEl.setStyle("background-image","url("+server.getIcon(menu.iconName,color)+")")}}}};let tabs=Ext.getCmp("tabs");me.currTab=Ext.getCmp(b);if(!me.currTab){me.currTab=tabs.add({xtype:"panel",id:b,code:b,icon:g,layout:"fit",title:h,border:0,tabContainer:true,closable:toBool(j,true),reorderable:toBool(f,true),methodInvoked:false,method:a,where:d,items:[],tabBtnId:null,doFixed:function(){let me=this;me.tab.setClosable(!me.tab.closable);if(!me.tab.closable){let cmp=system.findLastTag();if(cmp){tabs.moveAfter(me,cmp)}me.reorderable=me.tab.reorderable=false}else{me.reorderable=me.tab.reorderable=true;let cmp=system.findLastTag();if(cmp){tabs.moveAfter(me,cmp)}}if(Ext.isFunction(tabs.recordTab)){tabs.recordTab()}},listeners:{deactivate:function(k){changeIcon(k,false)},activate:function(k){if(!k){return}if(me.existMenu(k.id)){me.selectMenu(k.id,false)}changeIcon(k,true);if(!k.methodInvoked){me.asyncMethod(a).then(function(m){try{if(!m){return}k.methodInvoked=true;let entityOwner=m.down("[entityList=true]");if(entityOwner){entityOwner.where=mergeJson(k.where,entityOwner.where);entityOwner.code=$.md5(b)}k.add(m);me.recordTab()}catch(l){}})}},afterlayout:function(m,k,n){try{Ext.get(this.tabBtnId).dom.ondblclick=function(){let currShowTabId=me.currTab.getId();tabs.items.each(function(p,o){if(o!=0&&p.id===currShowTabId){if(p.closable){p.close()}}})};if(tabs.getActiveTab()===me.currTab){changeIcon(me.currTab,true)}}catch(l){}},destroy:function(l,k){me.recordTab()}},initEvents:function(){this.tabBtnId=this.getEl().getAttribute("aria-labelledby")}})}if(c){if(!tabs.getActiveTab()||tabs.getActiveTab()!=me.currTab){if(e){let cmp=me.findLastTag();if(cmp){Ext.getCmp("tabs").moveAfter(me.currTab,cmp)}}tabs.setActiveTab(me.currTab)}}},findLastTag:function(){let tabs=Ext.getCmp("tabs");for(let i=tabs.items.items.length-1;i>=0;i--){let item=tabs.items.items[i];if(item){if(!toBool(item.tab.closable,true)&&!toBool(item.tab.reorderable,true)){return item}}}return null},recordTab:function(){return new Ext.Promise(function(b,a){try{let tabArray=[];let tabs=Ext.getCmp("tabs");tabs.items.each(function(e,d){let tab={};if(Ext.isEmpty(e.method)){return}tab.method=e.method;tab.where=e.where;tab.title=e.title;tab.icon=e.icon;tab.id=e.id;tab.closable=e.closable;tab.reorderable=e.reorderable;tab.active=e===tabs.getActiveTab();tabArray.push(tab)});server.saveExtConfig("SystemTabs","TabRecord",objectToJson(tabArray),function(e,d){b(e)})}catch(c){a(c)}})},restoreTab:function(){return new Ext.Promise(function(b,a){try{server.showExtConfig("SystemTabs","TabRecord",function(e,d){b(d)})}catch(c){a(c)}})},addTab:function(a,d,c,b){let me=this;me.currTab=Ext.getCmp(d);if(!me.currTab){me.currTab=me.tabPanelContainer.add({title:c,xtype:"panel",id:d,code:d,icon:b,border:0,tabContainer:true,closable:true,reorderable:true,layout:"fit",items:[a]})}me.tabPanelContainer.setActiveTab(me.currTab)},selectMenu:function(c,b){try{let me=this;if(Ext.isEmpty(b)){b=false}let treelist=Ext.getCmp("leftTreeList");let record=treelist.getStore().getNodeById(c);if(!record){return}let parentId=record.get("parentId");if(!Ext.isEmpty(parentId)){let parent=treelist.getStore().getNodeById(parentId);if(b){treelist.setSelection(parent);parent.collapse();me.currTab=null;return}else{if(parentId!="root"){parent.expand(false,true);me.selectMenu(parentId,b)}}}treelist.setSelection(record)}catch(a){showException(a,"选择菜单！[system.selectMenu]")}},existMenu:function(a){let treelist=Ext.getCmp("leftTreeList");let record=treelist.getStore().getNodeById(a);return record!=null},getMenu:function(a){let treelist=Ext.getCmp("leftTreeList");let record=treelist.getStore().getNodeById(a);if(record){return record.data}return null},logout:function(){Ext.Msg.confirm("系统提示","<br/>您是否确定退出登录吗？",function(a){if(a==="yes"){server.logout()}})},sessionOut:function(){let me=this;if(me.sessionOutAlert){return}Ext.MessageBox.hide();me.sessionOutAlert=true;let win=Ext.create("Ext.window.Window",{title:"系统提醒",height:150,width:250,layout:"fit",resizable:false,maximizable:false,sessionWin:true,fixed:true,draggable:false,iconCls:"extIcon extSessionOut",html:"<div  style='padding:15px;background: #fff;'>会话失效，请您重新登录！</div>",modal:true,alwaysOnTop:true,toFrontOnShow:true,buttons:[{text:"重新登录",iconCls:"extIcon extLogin",flex:1,handler:function(){win.close()}}],listeners:{destroy:function(a,b){if(isPower()){window.parent.close()}else{location.reload()}}}});win.show()},modifyPassword:function(a){let me=this;let loginPanel=Ext.create("Ext.form.FormPanel",{url:"controller/modifyPassword",method:"POST",fileUpload:true,border:0,width:"100%",layout:"anchor",region:"center",bodyStyle:{},items:[{xtype:"textfield",fieldLabel:"当前密码",labelAlign:"right",labelWidth:60,margin:"10 10 10 10",name:"managerPassword",allowBlank:false,inputType:"password",blankText:"请输入用户当前密码",anchor:"100%"},{xtype:"textfield",fieldLabel:"新密码",labelAlign:"right",labelWidth:60,margin:"10 10 10 10",name:"newPassword",allowBlank:false,inputType:"password",blankText:"请输入用户新密码",anchor:"100%"},{xtype:"textfield",fieldLabel:"确认密码",labelAlign:"right",labelWidth:60,margin:"10 10 10 10",name:"reNewPassword",allowBlank:false,inputType:"password",blankText:"请确认密码",anchor:"100%"},{xtype:"hiddenfield",name:"managerId",value:me.manager.managerId},{xtype:"fieldcontainer",labelWidth:0,layout:"column",items:[{xtype:"button",text:"立即修改",margin:"10 10 10 5",iconCls:"extIcon extOk",columnWidth:1,handler:function(){doSubmit()}}]}],listeners:{render:function(c){try{new Ext.util.KeyMap({target:c.getEl(),key:13,fn:doSubmit,scope:Ext.getBody()})}catch(b){console.error(b)}}}});let doSubmit=function(){let form=loginPanel.form;if(form.isValid()){form.submit({waitMsg:"正在修改中……",success:function(b,c){toast(c.result.message);win.close();if(c.result.success){Ext.Msg.alert("系统提醒","您当前的密码已被修改，请您重新登录！",function(){server.logout()})}},failure:function(b,c){Ext.Msg.alert("系统提醒",c.result.message)}})}};let win=Ext.create("Ext.window.Window",{title:"修改登录密码",height:250,icon:a.icon,iconCls:a.iconCls,width:400,layout:"border",resizable:false,maximizable:false,animateTarget:a,constrain:true,items:[loginPanel],modal:true});win.show()},getEntity:function(a){let me=this;let entities=me.entities;for(let i=0;i<entities.length;i++){let entity=entities[i];if(entity.entityCode===a){return entity}}return null},showPowerMenus:function(obj,checked,parent){return new Ext.Promise(function(resolve,reject){let dataStore=Ext.create("Ext.data.TreeStore",{proxy:{type:"ajax",url:"showPowerMenus",actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(obj,request,operation,eOpts){let data=eval("("+request.responseText+")");if(!data.success){Ext.Msg.alert("数据获取失败",data.message)}}},reader:{type:"json"}},root:{expanded:true},listeners:{load:function(obj,records,successful){},beforeload:function(store,operation){Ext.apply(store.proxy.extraParams,{checked:checked,parent:parent})}}});let treePanel=Ext.create("Ext.tree.Panel",{store:dataStore,rootVisible:false,bufferedRenderer:false,animate:true,containerScroll:true,autoScroll:true,viewConfig:{loadMask:{msg:"加载功能菜单中，请稍后……"}},listeners:{checkchange:function(currNode,checked,e,eOpts){if(checked){currNode.bubble(function(parentNode){parentNode.set("checked",true)});currNode.cascadeBy(function(node){node.set("checked",true)})}else{currNode.cascadeBy(function(node){node.set("checked",false)})}}}});let win=Ext.create("Ext.window.Window",{title:"权限配置（选择功能菜单）",width:400,height:470,layout:"fit",iconCls:"extIcon extSelect",resizable:true,animateTarget:obj,maximizable:true,constrain:true,items:[treePanel],modal:true,buttons:[{text:"重置",iconCls:"extIcon extReset",handler:function(){dataStore.reload()}},{text:"确定",iconCls:"extIcon extOk",handler:function(){let checkedArray=treePanel.getChecked();let menuIds="";for(i=0;i<checkedArray.length;i++){menuIds+=","+checkedArray[i].data.id}resolve(menuIds);win.close()}}]});win.show()})},showPowerExt:function(c,b,a,d){return new Ext.Promise(function(f,e){window.getMenuPower=function(){return b};window.getExtPower=function(){return a};window.getParentExtPower=function(){return d};window.close=function(){Ext.getCmp("ExtPowerWindow").close()};let win=Ext.create("Ext.window.Window",{title:"配置界面权限（在组件上右击鼠标进行编辑权限）",id:"ExtPowerWindow",iconCls:"extIcon extPower",layout:"border",resizable:false,maximized:true,fixed:true,draggable:false,listeners:{show:function(g){g.update("<iframe name='extPowerFrame'  src='power?managerId=0' width='100%' height='100%' frameborder='0' scrolling='no' />")}},buttons:[{text:"保存权限配置",handler:function(){f(extPowerFrame.window.getExtPower());win.close()}}]});win.show()})},showMenuColumns:function(obj,checked){return new Ext.Promise(function(resolve,reject){let dataStore=Ext.create("Ext.data.TreeStore",{proxy:{type:"ajax",url:"showMenuColumn",actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(obj,request,operation,eOpts){let data=eval("("+request.responseText+")");if(!data.success){Ext.Msg.alert("数据获取失败",data.message)}}},reader:{type:"json"}},root:{expanded:true},listeners:{load:function(obj,records,successful){},beforeload:function(store,operation){Ext.apply(store.proxy.extraParams,{checked:checked})}}});let treePanel=Ext.create("Ext.tree.Panel",{store:dataStore,rootVisible:false,bufferedRenderer:false,animate:true,containerScroll:true,autoScroll:true,lastCheckNode:null,viewConfig:{loadMask:{msg:"加载功能菜单中，请稍后……"}},listeners:{checkchange:function(currNode,checked,e,eOpts){if(checked){currNode.bubble(function(parentNode){parentNode.set("checked",true)});currNode.cascadeBy(function(node){node.set("checked",true)})}else{currNode.cascadeBy(function(node){node.set("checked",false)})}}}});let win=Ext.create("Ext.window.Window",{title:"搜索链配置",width:400,height:470,layout:"fit",iconCls:"extIcon extLink",resizable:true,animateTarget:obj,maximizable:true,constrain:true,items:[treePanel],modal:true,buttons:[{text:"重置",iconCls:"extIcon extReset",handler:function(){dataStore.reload()}},{text:"确定",iconCls:"extIcon extOk",handler:function(){let checkedArray=treePanel.getChecked();let treeData=[];let menuIds="";for(i=0;i<checkedArray.length;i++){if(checkedArray[i].isLeaf()){let data={};data.text=checkedArray[i].data.text;data.id=checkedArray[i].data.id;data.dataIndex=checkedArray[i].data.dataIndex;data.parentId=checkedArray[i].data.parentId;let findRecord=treePanel.getStore().findNode("id",data.parentId,0,false,false,true);if(findRecord){let parent={};let parentData=findRecord.data;parent.text=parentData.text;parent.id=parentData.id;parent.method=parentData.method;parent.icon=parentData.icon;data.parent=parent;treeData.push(data)}}menuIds+=","+checkedArray[i].data.id}resolve({checked:menuIds,columns:treeData});win.close()}}]});win.show()})}};function showList(menuId,entityCode,where){let entity=system.getEntity(entityCode);if(!entity){throw"操作失败！未获取到 '"+entityCode+"' 实体类！"}if(!entity.js){throw"操作失败！未获取到 '"+entityCode+"' JS对象！"}if(!where){where={}}let entityJsObj=eval("new "+entityCode+"()");entityJsObj.menu=system.getMenu(menuId);return entityJsObj.getList(where)}Ext.onReady(function(){if(checkBrowserVersion()){Ext.MessageBox.show({alwaysOnTop:true,modal:true,title:"系统提醒",msg:"初始化系统中，请稍后……",progressText:"请耐心等待，即将完成操作",progress:true,closable:false});system.initConfig()}});