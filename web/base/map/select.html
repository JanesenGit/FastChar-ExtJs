<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>地图选址</title>
    <style>
        #container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body onload="onPageLoad();">
<div id="container"></div>
</body>

<script type="text/javascript">
    var map = null, geolocation = null, marker = null, geocoder, currPosition;

    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]);
        return null;
    }

    function addScript(script, callBack) {
        if (script == null) return;
        var oHead = document.getElementsByTagName('head').item(0);
        var oScript = document.createElement("script");
        oScript.type = "text/javascript";
        if (script.src != null && script.src.length > 0) {
            oScript.src = script.src;
        } else if (script.href != null && script.href.length > 0) {
            oScript.src = script.href;
        } else {
            try {
                oScript.appendChild(document.createTextNode(script.text));
            } catch (ex) {
                oScript.text = script.text;
            }
        }
        oHead.appendChild(oScript);
        oScript.onload = oScript.readystatechange = function () {
            if (callBack != null) {
                callBack();
            }
        };
        oScript.onerror = function () {
            alert("脚本文件" + script.src + "加载失败，请您稍后重试！");
        };
    }

    function onPageLoad() {
        var mapVersion = "1.4.14";
        var mapKey = "33eafcd2e5c636e3d527f14e0f3b8cb1";

        if (getQueryString("mapVersion")) {
            mapVersion = getQueryString("mapVersion");
        }
        if (getQueryString("mapKey")) {
            mapKey = getQueryString("mapKey");
        }
        var srcUrl = "https://webapi.amap.com/maps?v=" + mapVersion + "&key=" + mapKey + "&plugin=AMap.Autocomplete,AMap.Geocoder,AMap.PlaceSearch";
        addScript({src: srcUrl}, function () {
            initMap();
        });
    }

    function initMap() {
        try {
            map = new AMap.Map("container", {
                resizeEnable: true
            });

            map.plugin(["AMap.ToolBar", "AMap.OverView", "AMap.Scale"], function () {
                //加载工具条
                tool = new AMap.ToolBar({
                    autoPosition: false
                });
                map.addControl(tool);
                //加载鹰眼
                view = new AMap.OverView();
                map.addControl(view);
                //加载比例尺
                scale = new AMap.Scale();
                map.addControl(scale);
                window.parent.onMapLoadDone();
            });
        } catch (e) {
            console.error(e);
            alert("高德地图初始化失败！请检查您配置的key和version是否正确！");
        }
    }


    //开始定位
    function startLocation() {
        AMap.plugin('AMap.Geolocation', function () {//异步加载插件
            geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,//是否使用高精度定位，默认:true
                timeout: 10000,          //超过10秒后停止定位，默认：无穷大
                buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
                zoomToAccuracy: true,      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
                buttonPosition: 'RB'
            });
            geolocation.getCityInfo(function (status, result) {
                if (status == "complete") {
                    var position = new AMap.LngLat(result.center[0], result.center[1], true);
                    marker = new AMap.Marker({
                        position: position,
                        draggable: true,
                        cursor: 'move',
                        raiseOnDrag: true
                    });
                    window.parent.closeMapMask();
                    AMap.event.addListener(marker, 'dragend', onMarkDragEnd);
                    marker.setMap(map);

                    searchPosition(position);
                    map.setZoomAndCenter(14, position);
                } else {
                    console.log(result);
                    alert("定位失败！" + result.message);
                }
            });
        });
    }

    function onMarkDragEnd() {
        searchPosition(marker.getPosition());
    }

    //搜索坐标位置
    function searchPosition(position) {
        window.parent.closeMapMask();
        window.parent.setMarkCurrPos("", "检索位置中…");
        if (!geocoder) {
            geocoder = new AMap.Geocoder({
                radius: 1000,
                extensions: "all"
            });
        }
        geocoder.getAddress(position, function (status, result) {
            if (status === 'complete' && result.info === 'OK') {
                window.parent.setMarkCurrPos(position, result.regeocode.formattedAddress);
            }
        });
    }

    //搜索地址
    function searchAddress(address) {
        geocoder.getLocation(address, function (status, result) {
            if (status === 'complete' && result.info === 'OK') {
                var position = result.geocodes[0].location;
                var fAddress = result.geocodes[0].formattedAddress;
                marker.setPosition(position);
                map.setZoomAndCenter(14, position);
                window.parent.setMarkCurrPos(position, fAddress);
            }
        });
    }


    //设置默认的位置
    function setLngLatAddress(lnglat) {
        currPosition = new AMap.LngLat(lnglat.split(",")[0], lnglat.split(",")[1]);
        onError(null);
        marker.setPosition(currPosition);
        map.setZoomAndCenter(14, currPosition);
        searchPosition(currPosition);
    }
</script>
</html>