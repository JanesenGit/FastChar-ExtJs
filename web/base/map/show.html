<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>地图查看位置</title>
    <style>
        #container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body onload="onPageLoad();">
<div id="container"></div>
</body>

<script type="text/javascript">
    let lngLat;
    let marker;
    let infoWindow;
    let position;
    let map;


    function getQueryString(name) {
        let reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        let r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]);
        return null;
    }

    function addScript(script, callBack) {
        if (script == null) return;
        let oHead = document.getElementsByTagName('head').item(0);
        let oScript = document.createElement("script");
        oScript.type = "text/javascript";
        oScript.src = script.src;
        oHead.appendChild(oScript);
        oScript.onload = oScript.readystatechange = function () {
            if (callBack != null) {
                callBack();
            }
        };
        oScript.onerror = function () {
            alert("脚本文件" + script.src + "加载失败，请您稍后重试！");
        };
    }

    function onPageLoad() {
        let mapVersion = "1.4.14";
        let mapKey = "33eafcd2e5c636e3d527f14e0f3b8cb1";

        if (getQueryString("mapVersion")) {
            mapVersion = getQueryString("mapVersion");
        }
        if (getQueryString("mapKey")) {
            mapKey = getQueryString("mapKey");
        }
        let srcUrl = "https://webapi.amap.com/maps?v=" + mapVersion + "&key=" + mapKey + "&plugin=AMap.Autocomplete,AMap.Geocoder,AMap.PlaceSearch";
        addScript({src: srcUrl}, function () {
            initMap();
        });
    }

    function initMap() {
        try {
            lngLat = getQueryString("lnglat");
            position = new AMap.LngLat(lngLat.split(",")[0], lngLat.split(",")[1]);
            map = new AMap.Map("container", {
                resizeEnable: true
            });
            map.plugin(["AMap.ToolBar", "AMap.OverView", "AMap.Scale", "AMap.Geocoder", "AMap.PlaceSearch"], function () {
                //加载工具条
                tool = new AMap.ToolBar({
                    autoPosition: false
                });
                map.addControl(tool);
                //加载鹰眼
                view = new AMap.OverView();
                map.addControl(view);
                //加载比例尺
                scale = new AMap.Scale();
                map.addControl(scale);

                regeocoder();
            });
        } catch (e) {
            console.error(e);
            alert("高德地图初始化失败！请检查您配置的key和version是否正确！");
        }
    }


    function regeocoder() {  //逆地理编码
        marker = new AMap.Marker({  //加点
            map: map,
            position: position
        });
        AMap.event.addListener(marker, 'click', function () { //鼠标点击marker弹出自定义的信息窗体
            infoWindow.open(map, marker.getPosition());
        });

        let geocoder = new AMap.Geocoder({
            radius: 1000,
            extensions: "all"
        });
        geocoder.getAddress(position, function (status, result) {
            // console.log(status, result);
            if (status === 'complete' && result.info === 'OK') {
                geocoder_CallBack(result);
            } else {
                alert("获取位置失败！请检查您配置的key和version是否正确！");
            }
        });
        map.setFitView();
    }

    function geocoder_CallBack(data) {
        window.parent.closeMapMask();
        let address = data.regeocode.formattedAddress; //返回地址描述

        infoWindow = new AMap.InfoWindow({
            content: address,
            size: new AMap.Size(300, 0),
            offset: new AMap.Pixel(0, -30)
        });
        infoWindow.open(map, marker.getPosition());
        map.setZoomAndCenter(12, position);
    }

</script>
</html>