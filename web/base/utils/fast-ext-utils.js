let MemoryCache={},progressLine;String.prototype.endWith=function(b){if(b==null||b==""||this.length==0||b.length>this.length){return false}return this.substring(this.length-b.length)==b};String.prototype.startWith=function(b){if(b==null||b==""||this.length==0||b.length>this.length){return false}return this.substr(0,b.length)==b};String.prototype.firstUpperCase=function(){return this.replace(/^\S/,function(b){return b.toUpperCase()})};Array.prototype.exists=function(b){for(let i=0;i<this.length;i++){if(this[i]==b){return true}}return false};function toBool(e,b){if(Ext.isEmpty(b)){b=false}if(Ext.isEmpty(e)){return b}if(Ext.isString(e)){if(e=="0"){return false}if(e=="1"){return true}}if(Ext.isNumber(e)){if(e==0){return false}if(e==1){return true}}return Boolean(e)}function toColor(e,b){if(Ext.isEmpty(b)){b="#FFFFFF"}if(Ext.isEmpty(e)){return b}if(e.toString().startWith("#")){return e.toString()}return"#"+e}function jsonToObject(b){try{return Ext.decode(b)}catch(f){}return null}function objectToJson(f){try{return Ext.encode(f)}catch(b){}return null}function copyToBoard(b){let oInput=document.createElement("input");oInput.value=b;document.body.appendChild(oInput);oInput.select();document.execCommand("Copy");oInput.style.display="none";$(oInput).remove()}function copy(b){let newObj={};if(b instanceof Array){newObj=b.concat()}else{if(b instanceof Function){newObj=b}else{for(let key in b){newObj[key]=b[key]}}}return newObj}function isSystem(){try{if(system&&system.init){return true}}catch(b){}return false}function checkBrowserVersion(){if(Ext.isIE&&Ext.ieVersion<11){let win=Ext.create("Ext.window.Window",{title:"系统提醒",width:250,height:100,layout:"fit",icon:"icons/icon_error.svg",resizable:false,closable:false,html:"<div style='background:#eeeeee; padding:10px;'>您当前的IE版本太低，至少在11.0以上的IE才能使用本系统！</div>",modal:true});win.show();return false}return true}function getBodyContainer(){let container=Ext.getCmp("bodyContainer");if(container==null){Ext.getDoc().on("contextmenu",function(b){b.stopEvent()});Ext.tip.QuickTipManager.init();Ext.QuickTips.init();container=Ext.create("Ext.container.Viewport",{id:"bodyContainer",layout:"fit",border:0,renderTo:Ext.getBody()})}return container}let setCache=function(b,f){try{localStorage.setItem(b,JSON.stringify(f))}catch(g){}};let getCache=function(b){try{return JSON.parse(localStorage.getItem(b))}catch(f){}return null};let removeCache=function(b){localStorage.removeItem(b)};function getProgressLine(b){if(Ext.isEmpty(b)){b="#f8c633"}if(progressLine==null){progressLine=new ProgressBar.Line("#progress",{color:b,duration:1000,easing:"easeInOut",from:{color:"#9c58b6"},to:{color:b},step:function(f,e,g){e.path.setAttribute("stroke",f.color)}})}return progressLine}function shakeComment(f){try{let interval,t=0,z=3,del=function(){clearInterval(interval);f.setX(currX);f.setY(currY)};let currX=f.getX();let currY=f.getY();interval=setInterval(function(){try{let i=t/180*Math.PI,x=Math.sin(i)*z,y=Math.cos(i)*z;f.setX(currX+x);f.setY(currY+y);if((t+=90)>1080){del()}}catch(g){del()}},30)}catch(b){}}function mergeJson(e,b){let newJsonData={};if(!Ext.isEmpty(e)){for(let property in e){newJsonData[property]=e[property]}}if(!Ext.isEmpty(b)){for(let property in b){newJsonData[property]=b[property]}}return newJsonData}function buildForm(b,e){let form=$("<form></form>");form.attr("action",b);form.attr("method","post");for(let n in e){let my_input=$("<input type='text' name='"+n+"' />");my_input.attr("value",e[n]);form.append(my_input)}$(document.body).append(form);return form}function loadFunction(functionStr){if(functionStr.toString().trim().startsWith("function")){let functionKey="do"+$.md5(functionStr);if(Ext.isEmpty(MemoryCache[functionKey])){let myScript=document.createElement("script");myScript.type="text/javascript";let code="let "+functionKey+"="+functionStr;try{myScript.appendChild(document.createTextNode(code))}catch(ex){myScript.text=code}document.body.appendChild(myScript);MemoryCache[functionKey]=true}return eval(functionKey)}return null}function download(b){b=b.split("?")[0];let name=b.substring(b.lastIndexOf("/"));let a=document.createElement("a");let event=new MouseEvent("click");a.download="file"+name;a.href=b;a.dispatchEvent(event)}function runCallBack(b,e){if(!Ext.isFunction(b)){return}if(b.callBacked){return}let callBackParams=[];for(let i=1;i<arguments.length;i++){callBackParams[i-1]=arguments[i]}b.apply(this,callBackParams);b.callBacked=true}function setRecordValue(b,e,f){f.dataIndex=e;if(Ext.isFunction(f.setRecordValue)){f.setRecordValue(b)}else{let value=f.getValue();if(Ext.isDate(f.getValue())){b.set(e,Ext.Date.format(value,f.format))}else{b.set(e,value)}}if(toBool(f.autoUpdate,false)){commitStoreUpdate(b.store)}}function buildOnlyCode(b){let key=b+Ext.now();return $.md5(key)}const power={types:["gridcolumn","button","menuitem"],config:false,menuShowing:false,powers:{},defaultPower:{show:true,edit:true},hasPower:function(e,b){let me=this;if(e.managerPower){if(e.managerPower.hasOwnProperty(b)){return e.managerPower[b]}}return true},checkPower:function(b){let me=this;if(!me.powers[b]){me.powers[b]=copy(me.defaultPower)}let powerConfig=me.powers[b];if(!Ext.isEmpty(powerConfig)){for(let defaultPowerKey in me.defaultPower){if(!powerConfig.hasOwnProperty(defaultPowerKey)){powerConfig[defaultPowerKey]=me.defaultPower[defaultPowerKey]}}}return powerConfig},checkManagerPower:function(b){if(!system.manager){return null}if(!system.managerPowers){if(Ext.isEmpty(system.manager.managerExtPower)||system.manager.role.roleType==0){return null}}if(!system.managerPowers){system.managerPowers=jsonToObject(system.manager.managerExtPower)}if(!system.managerPowers){system.managerPowers={}}let powerConfig=system.managerPowers[b.code];if(!powerConfig){powerConfig=copy(power.defaultPower)}for(let defaultPowerKey in power.defaultPower){if(!powerConfig.hasOwnProperty(defaultPowerKey)){powerConfig[defaultPowerKey]=power.defaultPower[defaultPowerKey]}}return powerConfig},pushPower:function(e,b){let me=this;me.powers[e]=b},setPower:function(e,b){let me=this;if(!me.powers[e]){me.powers[e]=b}},savePower:function(){let me=this;let data=me.powers;return Ext.encode(data)}};Ext.override(Ext.Component,{afterRender:Ext.Function.createSequence(Ext.Component.prototype.afterRender,function(){if(!isSystem()){return}let me=this;me.power=toBool(me.power,true);if(!me.power){return}if(me.up("[power=false]")){return}if(me.power&&(me.getXTypes().indexOf("field/")>0||Ext.Array.contains(power.types,me.getXType()))){me.code=getPowerCode(me);if(me.code){me.managerPower=power.checkManagerPower(me);power.setPower(me.code,copy(me.managerPower));if(!power.hasPower(me,"show")){me.hideable=false;me.setHidden(true);me.setDisabled(true);me.clearListeners();if(Ext.isFunction(me.collapse)){me.collapse()}}else{if(!power.hasPower(me,"edit")){me.editable=false;if(Ext.isFunction(me.setReadOnly)){me.setReadOnly(true)}}}if(power.config){me.powerConfig=power.checkPower(me.code);setPowerStyle(me);me.getEl().on("contextmenu",function(g,f,b){g.stopEvent();showPowerConfig(me,g)})}}}})});Ext.override(Ext.Component,{setDisabled:function(b){if(power.config){return this["enable"]()}return this[b?"disable":"enable"]()}});Ext.override(Ext.form.field.Base,{markInvalid:function(b){if(power.config){return}let me=this,ariaDom=me.ariaEl.dom,oldMsg=me.getActiveError(),active;me.setActiveErrors(Ext.Array.from(b));active=me.getActiveError();if(oldMsg!==active){me.setError(active);if(!me.ariaStaticRoles[me.ariaRole]&&ariaDom){ariaDom.setAttribute("aria-invalid",true)}}}});function getPowerCode(b){if(b!=null){let buildText=null;if(Ext.isFunction(b.up)){let window=b.up("window");if(window){buildText=window.getTitle()}}if(b.name){buildText+=b.name}if(b.title){buildText+=b.title}if(b.text){buildText+=b.text}if(b.subtext){buildText+=b.subtext}if(b.dataIndex){buildText+=b.dataIndex}if(Ext.isFunction(b.getFieldLabel)&&Ext.isEmpty(b.getFieldLabel())){buildText+=b.getFieldLabel()}if(buildText){return $.md5(buildText)}}return null}function showPowerConfig(f,b){if(!isSystem()){return}let powerConfig=power.checkPower(f.code);power.menuShowing=true;let panel=Ext.create("Ext.panel.Panel",{layout:{type:"vbox",pack:"center"},border:0,defaults:{height:20,power:false},items:[{xtype:"checkbox",name:"updateAlert",checked:true,boxLabel:"允许显示",value:powerConfig.show,listeners:{change:function(k,h,e,g){powerConfig.show=h;setPowerStyle(f)}}},{xtype:"checkbox",name:"updateAlert",checked:true,boxLabel:"允许编辑",hidden:!isColumnType(f),value:powerConfig.edit,listeners:{change:function(k,h,e,g){powerConfig.edit=h;setPowerStyle(f)}}}]});let contextMenu=new Ext.menu.Menu({padding:"0 0 0 10",powerMenu:true,style:{background:"#ffffff"},items:[panel],listeners:{beforehide:function(g,e){power.menuShowing=false;power.pushPower(f.code,powerConfig)}}});contextMenu.showAt(b.getXY())}function setPowerStyle(b){let query=Ext.all("[code="+b.code+"]");Ext.each(query,function(f,e){let powerConfig=power.checkPower(b.code);if(powerConfig){if(!powerConfig.show){f.addCls("no-show-power")}else{f.removeCls("no-show-power");if(!powerConfig.edit){f.addCls("no-edit-power")}else{f.removeCls("no-edit-power")}}}})}Ext.override(Ext.button.Button,{afterRender:Ext.Function.createSequence(Ext.button.Button.prototype.afterRender,function(){let me=this;if(me.tipText){me.tip=new Ext.ToolTip({target:me.el,trackMouse:true,renderTo:Ext.getBody(),html:me.tipText})}if(!Ext.isEmpty(me.text)){let grid=me.up("grid,treepanel");if(grid){addGridContextMenu(grid,buttonToMenuItem(me));if(me.checkSelect){if(!grid.selectButtons){grid.selectButtons=[]}me.setDisabled(true);grid.selectButtons.push(me)}if(me.checkUpdate){if(!grid.updateButtons){grid.updateButtons=[]}me.setDisabled(true);grid.updateButtons.push(me)}}}})});function buttonToMenuItem(b){let child={icon:b.icon,iconCls:b.iconCls,text:b.text,subtext:b.subtext,handler:b.handler};if(b.getMenu()!=null){let menus=[];b.getMenu().items.each(function(f,e){menus.push(buttonToMenuItem(f))});child.menu=menus}return child}Ext.override(Ext.Component,{initComponent:Ext.Function.createSequence(Ext.Component.prototype.initComponent,function(){let me=this;try{me.closeToolText="关闭";if((me.getXType()=="window"||me.getXType()=="panel")&&(!Ext.isEmpty(me.getTitle())||!Ext.isEmpty(me.subtitle))&&(me.resizable||me.split)){let fastOnlyCode=$.md5(me.getTitle()+me.subtitle+$("title").text());try{fastOnlyCode=$.md5(fastOnlyCode+me.width+me.height)}catch(b){}let width=getCache(fastOnlyCode+"Width");let height=getCache(fastOnlyCode+"Height");let collapse=toBool(getCache(fastOnlyCode+"Collapse"),false);if(width!=null){me.setWidth(width)}if(height!=null){me.setHeight(height)}me.collapsed=collapse;me.setCollapsed(collapse);me.on("resize",function(h,g,e,f){if(g!=Ext.getBody().getWidth()){setCache(fastOnlyCode+"Width",g)}if(e!=Ext.getBody().getHeight()){setCache(fastOnlyCode+"Height",e)}});me.on("collapse",function(h,g,e,f){setCache(fastOnlyCode+"Collapse",true)});me.on("expand",function(h,g,e,f){setCache(fastOnlyCode+"Collapse",false)})}if(me.getXType()=="menuitem"){me.on("focus",function(g,f,e){let icon=g.icon;let regStr=/([^/]*.svg)/;if(icon&&regStr.test(icon)){let newIcon=server.getIcon(regStr.exec(icon)[1].trim(),"#ffffff");let iconEl=Ext.get(g.getId()+"-iconEl");if(iconEl){iconEl.setStyle("background-image","url("+newIcon+")")}}});me.on("blur",function(g,f,e){let icon=g.icon;let regStr=/([^/]*.svg)/;if(icon&&regStr.test(icon)){let iconEl=Ext.get(g.getId()+"-iconEl");if(iconEl){iconEl.setStyle("background-image","url("+icon+")")}}})}}catch(b){console.error(b)}})});Ext.override(Ext.Component,{show:function(){if(isSystem()){if(this.getXType()=="window"||this.getXType()=="messagebox"){if(!toBool(this.sessionWin,false)){if(system.sessionOutAlert){this.hide();return null}}}}let me=this,rendered=me.rendered;if(me.hierarchicallyHidden||(me.floating&&!rendered&&me.isHierarchicallyHidden())){if(!rendered){me.initHierarchyEvents()}if(arguments.length>1){arguments[0]=null;me.pendingShow=arguments}else{me.pendingShow=true}}else{if(rendered&&me.isVisible()){if(me.floating){me.onFloatShow()}}else{if(me.fireEvent("beforeshow",me)!==false){me.hidden=false;delete this.getInherited().hidden;Ext.suspendLayouts();if(!rendered&&(me.autoRender||me.floating)){me.doAutoRender();rendered=me.rendered}if(rendered){me.beforeShow();Ext.resumeLayouts();me.onShow.apply(me,arguments);me.afterShow.apply(me,arguments)}else{Ext.resumeLayouts(true)}}else{me.onShowVeto()}}}return me}});Ext.override(Ext.grid.CellContext,{setRow:function(b){let me=this,dataSource=me.view.dataSource;if(b){if(typeof b==="number"){me.rowIdx=Math.max(Math.min(b,dataSource.getCount()-1),0);me.record=dataSource.getAt(b)}else{if(b.isModel){me.record=b;me.rowIdx=dataSource.indexOf(b)}else{if(b.tagName||b.isElement){me.record=me.view.getRecord(b);me.rowIdx=dataSource.indexOf(me.record)}}}}return me}});Ext.override(Ext.layout.container.Accordion,{nextCmp:function(b){let next=b.next();if(next&&next.isHidden()){return this.nextCmp(next)}return next},prevCmp:function(b){let prev=b.prev();if(prev&&prev.isHidden()){return this.prevCmp(prev)}return prev},onBeforeComponentCollapse:function(b){let me=this,owner=me.owner,toExpand,expanded,previousValue;if(me.owner.items.getCount()===1){return false}if(!me.processing){me.processing=true;previousValue=owner.deferLayouts;owner.deferLayouts=true;toExpand=me.nextCmp(b)||me.prevCmp(b);if(toExpand.isHidden()){owner.deferLayouts=previousValue;me.processing=false;me.onBeforeComponentCollapse(toExpand);return}if(me.multi){expanded=me.getExpanded();if(expanded.length===1){toExpand.expand()}}else{if(toExpand){toExpand.expand()}}owner.deferLayouts=previousValue;me.processing=false}}});Ext.override(Ext.dom.Element,{syncContent:function(b){b=Ext.getDom(b);let sourceNodes=b.childNodes,sourceLen=sourceNodes.length,dest=this.dom,destNodes=dest.childNodes,destLen=destNodes.length,i,destNode,sourceNode,nodeType,newAttrs,attLen,attName,elData=dest._extData;if(Ext.isIE9m&&dest.mergeAttributes){dest.mergeAttributes(b,true);dest.src=b.src}else{newAttrs=b.attributes;attLen=newAttrs.length;for(i=0;i<attLen;i++){attName=newAttrs[i].name;if(attName!=="id"){dest.setAttribute(attName,newAttrs[i].value)}}}if(elData){elData.isSynchronized=false}if(sourceLen!==destLen){dest.innerHTML=b.innerHTML;return}for(i=0;i<sourceLen;i++){sourceNode=sourceNodes[i];destNode=destNodes[i];nodeType=sourceNode.nodeType;if(nodeType!==destNode.nodeType||(nodeType===1&&sourceNode.tagName!==destNode.tagName)){dest.innerHTML=b.innerHTML;return}if(nodeType===3){destNode.data=sourceNode.data}else{try{if(sourceNode.id&&destNode.id!==sourceNode.id){destNode.id=sourceNode.id}destNode.style.cssText=sourceNode.style.cssText;destNode.className=sourceNode.className;Ext.fly(destNode,"_syncContent").syncContent(sourceNode)}catch(f){}}}}});const files={validate:function(e,b){if(Ext.isEmpty(e)){showAlert("系统提醒","参数"+b+"必传！");return false}if(!Ext.isArray(e)){showAlert("系统提醒","参数"+b+"必需Array格式！");return false}if(e==0){showAlert("系统提醒","参数"+b+"集合不可为空！");return false}return true},file:function(){return{reg:/\.*$/i,tipMsg:"文件",type:"file",renderer:renders.file()}},image:function(e,b){if(Ext.isEmpty(e)){e=-1}if(Ext.isEmpty(b)){b=-1}return{width:e,height:b,reg:/\.(jpg|png|gif|jpeg)$/i,tipMsg:"图片",type:"images",renderer:renders.image(24)}},mp4:function(){return{reg:/\.(mp4)$/i,tipMsg:"mp4",type:"videos",renderer:renders.file()}},word:function(){return{reg:/\.(doc)$/i,tipMsg:"word文档",type:"words",renderer:renders.file()}},excel:function(){return{reg:/\.(xls|xlsx)$/i,tipMsg:"excel文档",type:"excels",renderer:renders.file()}},text:function(){return{reg:/\.(txt)$/i,tipMsg:"txt文档",type:"excels",renderer:renders.file()}}};function uploadFile(e,b){return new Ext.Promise(function(g,f){let title="上传文件",type="files",width=-1,height=-1;if(!files.validate(b,"fileModules")){return}if(b.length==1){title="上传"+b[0].tipMsg;type=b[0].type;width=b[0].width;height=b[0].height}let formPanel=Ext.create("Ext.form.FormPanel",{url:"upload",method:"POST",margin:"5",fileUpload:true,width:400,callBacked:false,border:0,layout:"column",items:[{xtype:"filefield",fieldLabel:title,labelWidth:60,labelAlign:"right",buttonText:"选择文件",allowBlank:false,name:"file",columnWidth:1,listeners:{change:function(l,k,h){if(k!=null&&k.length!=0){let errorMsg="";for(let i=0;i<b.length;i++){let fileModule=b[i];if(fileModule.reg.test(k)){formPanel.doSubmit();return}errorMsg=errorMsg+"或"+fileModule.tipMsg}formPanel.form.reset();Ext.Msg.alert("系统提醒","请上传有效的"+errorMsg.substring(1))}}}},{xtype:"hiddenfield",name:"type",value:type},{xtype:"hiddenfield",name:"file.width",value:width},{xtype:"hiddenfield",name:"file.height",value:height}],doSubmit:function(){let form=formPanel.form;if(form.isValid()){let myMask=new Ext.LoadMask({msg:"正在上传附件中…",target:uploadWin});myMask.show();form.submit({success:function(h,k){toast("文件上传成功！");if(!g.called){g.called=true;g(k.result.data)}uploadWin.close()},failure:function(h,k){myMask.destroy();Ext.Msg.alert("系统提醒","上传失败！"+k.result.message)}})}},listeners:{render:function(h){new Ext.KeyMap(h.getEl(),[{key:13,fn:formPanel.doSubmit,scope:Ext.getBody()}])}}});let btnSubmitId="btnSubmit"+new Date().getTime();let uploadWin=Ext.create("Ext.window.Window",{title:title,layout:"fit",resizable:false,scrollable:false,items:formPanel,modal:true,iconCls:"extIcon extUpload",animateTarget:e,constrain:true,buttons:[{text:"重置",width:88,iconCls:"extIcon extReset",handler:function(){formPanel.form.reset()}},{text:"上传",width:88,id:btnSubmitId,iconCls:"extIcon extOk",handler:function(){formPanel.doSubmit()}}],listeners:{show:function(h,k){formPanel.getForm().findField("file").fileInputEl.dom.click();Ext.getCmp(btnSubmitId).focus()},close:function(h,k){if(!g.called){g.called=true;g()}}}});uploadWin.show()})}function showFiles(g,f,e,b){if(!files.validate(e,"fileModules")){return}let datas=[],renderer=renders.file(),title="文件管理";if(!Ext.isEmpty(b)){let fileArray=b;if(Ext.isString(b)){fileArray=Ext.JSON.decode(b)}for(let i=0;i<fileArray.length;i++){datas.push({url:fileArray[i]})}}if(e.length==1){renderer=e[0].renderer;title=e[0].tipMsg+"管理"}let currTime=Ext.now();let fileStore=Ext.create("Ext.data.Store",{autoLoad:true,data:datas});let dataGridFiles=Ext.create("Ext.grid.Panel",{selModel:getGridSelModel(),store:fileStore,columnLines:true,cellTip:true,columns:[{header:"文件",dataIndex:"url",flex:1,align:"center",renderer:renderer}],plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:2})],selType:"cellmodel",tbar:[{xtype:"button",border:1,text:"删除",id:"btnDeleteFile"+currTime,iconCls:"extIcon extDelete",disabled:true,handler:function(){let data=dataGridFiles.getSelectionModel().getSelection();if(data.length==0){toast("请您选择需要删除的文件！")}else{Ext.Msg.confirm("系统提醒","您确定立即删除选中的附件吗？",function(h,k){if(h=="yes"){let params={};Ext.Array.each(data,function(l,m){params["path["+m+"]"]=l.get("url")});showWait("正在删除中……");server.deleteAttach(params,function(m,l){hideWait();if(m){dataGridFiles.getSelectionModel().deselectAll();showAlert("系统提醒","删除成功！");Ext.Array.each(data,function(o,p){fileStore.remove(o);fileStore.modify=true})}else{showAlert("系统提醒",l)}})}})}}},{xtype:"button",border:1,text:"上传",iconCls:"extIcon extUpload",handler:function(){uploadFile(this,e).then(function(h){if(h){fileStore.add(h);fileStore.modify=true}})}}],listeners:{selectionchange:function(){let data=this.getSelectionModel().getSelection();Ext.getCmp("btnDeleteFile"+currTime).setDisabled(!(data.length>0))}}});let win=Ext.create("Ext.window.Window",{title:title,height:300,width:400,minWidth:400,minHeight:300,layout:"fit",resizable:true,modal:true,constrain:true,iconCls:"extIcon extFolder",animateTarget:g,items:[dataGridFiles],listeners:{close:function(){if(fileStore.modify){let data=[];fileStore.each(function(h,k){data.push(h.get("url"))});if(f!=null){f(Ext.encode(data))}}}}});win.show()}function importExcel(f,g,e,b){return new Ext.Promise(function(k,h){if(!e){e=[]}else{e=Ext.Array.clone(e)}if(!b){b="entity/importData"}e.push({xtype:"filefield",fieldLabel:"Excel文件",buttonText:"选择文件",allowBlank:false,name:"file",columnWidth:1,listeners:{change:function(o,m,l){if(m!=null&&m.length!=0){if(!files.excel().reg.test(m)){formPanel.form.reset();Ext.Msg.alert("系统提醒","请上传有效的Excel文档！")}}}}});let formPanel=Ext.create("Ext.form.FormPanel",{url:b,method:"POST",margin:"5",fileUpload:true,width:400,callBacked:false,border:0,layout:"column",defaults:{labelWidth:80,margin:"5 5 5 5",labelAlign:"right",emptyText:"请填写"},items:e,doSubmit:function(){let form=formPanel.form;if(form.isValid()){let myMask=new Ext.LoadMask({msg:"正在导入中…",target:uploadWin});myMask.show();form.submit({params:g,success:function(l,m){myMask.destroy();Ext.Msg.alert("系统提醒",m.result.message,function(){runCallBack(k,m.result);uploadWin.close()})},failure:function(l,m){myMask.destroy();Ext.Msg.alert("系统提醒","导入失败！"+m.result.message)}})}},listeners:{render:function(l){new Ext.KeyMap(l.getEl(),[{key:13,fn:formPanel.doSubmit,scope:Ext.getBody()}])}}});let btnSubmitId="btnSubmit"+new Date().getTime();let uploadWin=Ext.create("Ext.window.Window",{title:"导入Excel数据",layout:"fit",resizable:false,scrollable:false,items:[formPanel],modal:true,iconCls:"extIcon extUpload",animateTarget:f,constrain:true,buttons:[{text:"重置",width:88,iconCls:"extIcon extReset",handler:function(){formPanel.form.reset()}},{text:"上传",width:88,id:btnSubmitId,iconCls:"extIcon extOk",handler:function(){formPanel.doSubmit()}}],listeners:{show:function(l,m){if(e.length==1){formPanel.getForm().findField("file").fileInputEl.dom.click();Ext.getCmp(btnSubmitId).focus()}}}});uploadWin.show()})}Ext.form.FormPanel.prototype.setFieldValue=function(e,b){this.getForm().findField(e).setValue(b)};Ext.form.FormPanel.prototype.getFieldValue=function(b){return this.getForm().findField(b).getValue()};Ext.form.FormPanel.prototype.getField=function(b){return this.getForm().findField(b)};Ext.form.field.Base.prototype.blur=function(){this.inputEl.blur()};Ext.form.FormPanel.prototype.submitForm=function(e,f,b){let me=this;if(!f){f={}}if(!b){b="正在提交中……"}return new Ext.Promise(function(h,g){let submitConfig={submitEmptyText:false,waitMsg:b,params:f,success:function(k,l){Ext.Msg.alert("系统提醒",l.result.message,function(m){if(m=="ok"){h(l.result)}})},failure:function(k,l){Ext.Msg.alert("系统提醒",l.result.message);g(l.result)}};if(e){submitConfig.params.entityCode=e.entityCode;if(e.menu){submitConfig.params.menu=e.menu.text}}let form=me.getForm();if(form.isValid()){form.submit(submitConfig)}})};Ext.override(Ext.form.field.Date,{initComponent:Ext.Function.createSequence(Ext.form.field.Date.prototype.initComponent,function(){if(isSystem()){if(this.format=="y-m-d"){this.format=system.dateFormat}}})});Ext.form.FormPanel.prototype.saveCache=function(b){if(Ext.isEmpty(b)){b=this.cacheKey}let data={};this.getForm().getFields().each(function(f,e){if(Ext.isDate(f.getValue())){data[f.getName()]=Ext.Date.format(f.getValue(),f.format)}else{data[f.getName()]=f.getValue()}});let params={configKey:b,configType:"FormPanelCache",configValue:Ext.encode(data)};showWait("暂存数据中……");$.post("ext/config/saveExtConfig",params,function(e){hideWait();if(e.success){toast("暂存成功！")}else{showAlert("系统提醒",e.message)}})};Ext.form.FormPanel.prototype.restoreCache=function(b){if(Ext.isEmpty(b)){b=this.cacheKey}let me=this;let params={configKey:b,configType:"FormPanelCache"};$.post("ext/config/showExtConfig",params,function(e){if(e.success){let data=Ext.decode(e.data.configValue);me.getForm().getFields().each(function(g,f){if(data.hasOwnProperty(g.getName())){g.setValue(data[g.getName()])}})}})};Ext.form.FormPanel.prototype.deleteCache=function(b){if(Ext.isEmpty(b)){b=this.cacheKey}let params={configKey:b,configType:"FormPanelCache"};$.post("ext/config/deleteExtConfig",params,function(e){})};Ext.override(Ext.form.Basic,{isValid:function(){try{let me=this,invalid;Ext.suspendLayouts();let fieldName="";let index=0;let errorInfo="请正确填写数据！";invalid=me.getFields().filterBy(function(e){let v=!e.validate();if(v&&index==0){fieldName=e.getFieldLabel();errorInfo=e.getErrors()[0];index++}return v});Ext.resumeLayouts(true);let result=invalid.length<1;if(!result){if(Ext.isEmpty(fieldName)){toast("请将数据填写完整！")}else{toast("【"+fieldName+"】错误："+errorInfo)}shakeComment(me.owner.ownerCt)}return result}catch(b){showException(b)}}});function isDateField(b){if(!b){return false}return b=="datefield"||b.xtype=="datefield"}function isNumberField(b){if(!b){return false}return b=="numberfield"||b.xtype=="numberfield"}function isTextField(b){if(!b){return false}return b=="textfield"||b.xtype=="textfield"}function isFileField(b){if(!b){return false}return b=="fastfile"||b.xtype=="fastfile"||b=="fastfilefield"||b.xtype=="fastfilefield"}function isFilesField(b){if(!b){return false}return b=="fastfiles"||b.xtype=="fastfiles"||b=="fastfilesfield"||b.xtype=="fastfilesfield"}function isEnumField(b){if(!b){return false}return b=="enumcombo"||b=="enumcombobox"||b.xtype=="enumcombo"||b.xtype=="enumcombobox"}function isContentField(b){if(!b){return false}return b=="contentfield"||b=="content"||b.xtype=="contentfield"||b.xtype=="content"}function isHtmlContentField(b){if(!b){return false}return b=="htmlcontentfield"||b=="htmlcontent"||b.xtype=="htmlcontentfield"||b.xtype=="htmlcontent"}function isLinkField(b){if(!b){return false}return b=="linkfield"||b=="link"||b.xtype=="linkfield"||b.xtype=="link"}function isTargetField(b){if(!b){return false}return b=="targetfield"||b=="target"||b.xtype=="targetfield"||b.xtype=="target"}function isPCAField(b){if(!b){return false}return b=="pcafield"||b=="pca"||b.xtype=="pcafield"||b.xtype=="pca"}Ext.override(Ext.grid.Panel,{initComponent:Ext.Function.createSequence(Ext.grid.Panel.prototype.initComponent,onGridInitComponent)});Ext.override(Ext.tree.Panel,{initComponent:Ext.Function.createSequence(Ext.tree.Panel.prototype.initComponent,onGridInitComponent)});Ext.override(Ext.grid.Panel,{afterRender:Ext.Function.createSequence(Ext.grid.Panel.prototype.afterRender,onGridAfterRender)});Ext.override(Ext.tree.Panel,{afterRender:Ext.Function.createSequence(Ext.tree.Panel.prototype.afterRender,onGridAfterRender)});function onGridInitComponent(){let grid=this;if(grid.entityList){configGridContextMenu(grid);configDefaultToolBar(grid);configGridListeners(grid)}}function onGridAfterRender(){let grid=this;if(grid.entityList){let tabContainer=grid.up("[tabContainer=true]");if(tabContainer){grid.tabPanelList=true}configGridLayout(grid).then(function(){configGridTip(grid);grid.setLoading(false);grid.getStore().grid=grid;if(!grid.getStore().isLoaded()){grid.getStore().loadPage(1)}})}}function addGridContextMenu(e,f,b){if(e.contextMenu&&f){if(!Ext.isFunction(e.contextMenu.getXType)){let menu=new Ext.menu.Menu({items:[]});if(Ext.isArray(e.contextMenu)){menu.add(e.contextMenu)}e.contextMenu=menu}if(!Ext.isEmpty(b)){e.contextMenu.insert(b,f)}else{e.contextMenu.add(f)}}}function configGridContextMenu(b){let index=0;addGridContextMenu(b,{iconCls:"extIcon extCopy2",text:"复制数据",menu:[{text:"复制单元格",iconCls:"extIcon extCopy2",handler:function(){let menu=b.contextMenu;copyToBoard($(menu.cellTd).text());toast("复制成功！")}},{text:"复制整行",iconCls:"extIcon extCopy2",handler:function(){let menu=b.contextMenu;let content="";$(menu.tr).find("td").each(function(){content+=$(this).text()+"\t"});copyToBoard(content);toast("复制成功！")}},{text:"复制数据",iconCls:"extIcon extCopy2",handler:function(){let menu=b.contextMenu;let record=menu.record;let fieldName=menu.cellContext.column.dataIndex;copyToBoard(record.get(fieldName));toast("复制成功！")}}]},index++);addGridContextMenu(b,{iconCls:"extIcon extEdit editColor",text:"编辑数据",onBeforeShow:function(){let menu=this.ownerCt;if(Ext.isEmpty(menu.cellContext.column.dataIndex)){this.hide();return}this.show();if(!menu.cellContext.column.field){if(!menu.cellContext.column.hasListener("dblclick")){this.hide()}}},handler:function(){let menu=this.ownerCt;if(menu.cellContext.column.field){b.doEdit=true;b.findPlugin("cellediting").startEditByPosition(menu.cellContext)}else{menu.cellContext.column.fireEvent("dblclick",b,this,menu.rowIndex)}}},index++);if(b.getStore().entity){addGridContextMenu(b,{iconCls:"extIcon extLink",text:"搜索链",onBeforeShow:function(){this.show();let menu=this.ownerCt;if(!Ext.isObject(menu.cellContext.column.searchLink)){this.hide()}else{let linkMenu=new Ext.menu.Menu({items:[]});let record=menu.record;let fieldName=menu.cellContext.column.dataIndex;let columns=menu.cellContext.column.searchLink.columns;for(let i=0;i<columns.length;i++){let column=columns[i];let child={icon:column.parent.icon,text:column.parent.text+"【"+column.text+"】",column:column,value:record.get(fieldName),handler:function(){let where={};where[this.column.dataIndex]=this.value;system.showTab(this.column.parent.method,$.md5(this.column.id+this.value),"搜索："+this.text,this.icon,true,false,where)}};linkMenu.add(child)}this.setMenu(linkMenu)}},menu:[]},index++);addGridContextMenu(b,{iconCls:"extIcon extSearch searchColor",text:"查找此数据",onBeforeShow:function(){let menu=this.ownerCt;if(Ext.isEmpty(menu.cellContext.column.dataIndex)||isFileColumn(menu.cellContext.column)||isFilesColumn(menu.cellContext.column)){this.hide()}else{this.show()}},handler:function(){let menu=this.ownerCt;let record=menu.record;let fieldName=menu.cellContext.column.dataIndex;menu.cellContext.column.searchValue(record.get(fieldName))}},index++);addGridContextMenu(b,{iconCls:"extIcon extClear",text:"清空此数据",onBeforeShow:function(){let menu=this.ownerCt;if(Ext.isEmpty(menu.cellContext.column.dataIndex)){this.hide()}else{this.show()}},handler:function(){let me=this;Ext.Msg.confirm("系统提醒","您确定清空选中的单元格数据吗？",function(e,f){if(e=="yes"){let menu=me.ownerCt;let record=menu.record;let fieldName=menu.cellContext.column.dataIndex;if(Ext.isObject(menu.cellContext.column.field)){if(!Ext.isEmpty(menu.cellContext.column.field.name)){fieldName=menu.cellContext.column.field.name}}let params={entityCode:b.getStore().entity.entityCode};for(let j=0;j<b.getStore().entity.idProperty.length;j++){let idName=b.getStore().entity.idProperty[j];params["data."+idName]=record.get(idName)}params["data."+fieldName]="<null>";showWait("正在清空中……");server.updateEntity(params,function(h,g){hideWait();if(h){toast("清除成功！");b.getStore().reload()}else{Ext.Msg.alert("系统提醒",g)}})}})}},index++)}}function configDefaultToolBar(b){if(!b){return}let toolbar=b.down("toolbar[dock='top']");if(toolbar){let button={xtype:"button",text:"更多操作",iconCls:"extIcon extMore",menu:[{text:"导出Excel",iconCls:"extIcon extExcel",handler:function(){exportGrid(b)}},{text:"导入Excel",iconCls:"extIcon extExcel",menu:[{text:"下载模板",iconCls:"extIcon extExcelModule searchColor",handler:function(){showWait("正在生成中……");let params={entityCode:b.getStore().entity.entityCode};if(b.getStore().entity.menu){params.title=b.getStore().entity.menu.text}Ext.each(b.getColumns(),function(f,e){if(isFileColumn(f)||isFilesColumn(f)||!toBool(f.excelHeader,true)){return}if(!Ext.isEmpty(f.dataIndex)){let indexStr=e;if(e<10){indexStr="0"+e}params["column["+indexStr+"].width"]=f.width;params["column["+indexStr+"].text"]=f.configText;params["column["+indexStr+"].enum"]=getEnumName(f);params["column["+indexStr+"].type"]=getColumnFieldType(f);params["column["+indexStr+"].dataIndex"]=f.dataIndex;if(isLinkColumn(f)){params["column["+indexStr+"].dataIndex"]=f.field.name}}});server.excelModule(params,function(g,f,e){hideWait();if(g){toast("生成成功！");location.href="attach/"+f}else{Ext.Msg.alert("系统提醒","生成失败！"+e)}})}},{text:"导入数据",iconCls:"extIcon extExcelImport searchColor",handler:function(){let params={entityCode:b.getStore().entity.entityCode};importExcel(this,params,b.importExcelItems).then(function(e){if(e){b.getStore().loadPage(1)}})}}]},{iconCls:"extIcon extSet",text:"操作设置",handler:function(){setGrid(this,b)}}]};toolbar.add("->");toolbar.add(button)}}function configGridTip(b){if(!b){return}let view=b.getView();if(!view){return}b.tip=new Ext.ToolTip({target:view.el,delegate:".x-grid-cell-inner",trackMouse:true,renderTo:Ext.getBody(),listeners:{beforeshow:function(e){if(b.operate&&!b.operate.hoverTip){return false}let innerHTML=e.triggerElement.innerHTML;if(Ext.isEmpty(innerHTML)||innerHTML=="&nbsp;"){return false}let tipHtml=innerHTML;let dataChild=e.triggerElement.firstChild;if(dataChild!=null&&dataChild.nodeType==1){if(dataChild.getAttribute("class")=="x-grid-row-checker"){return false}let detailsId=dataChild.getAttribute("details-id");if(window[detailsId]){e.update(window[detailsId]);return true}}e.update(tipHtml)}}})}function configGridListeners(b){if(!b||b.configListener){return}b.configListener=true;b.on("viewready",function(f,e){f.getHeaderContainer().sortOnClick=false});b.on("beforedestroy",function(f,e){saveGridColumn(f)});b.on("headertriggerclick",function(h,k,l,g,f){if(Ext.isEmpty(k.dataIndex)){return}h.sortOnClick=false;h.triggerColumn=k});b.on("headercontextmenu",function(h,k,l,g,f){if(Ext.isEmpty(k.dataIndex)){return}h.sortOnClick=false;h.onHeaderTriggerClick(k,l,k.triggerEl)});b.on("headermenucreate",function(f,h,g,e){b.columnHeadMenu=h;configGridHeadMenu(b)});b.on("headerclick",function(h,k,l,g,f){if(Ext.isEmpty(k.dataIndex)){return}h.sortOnClick=false;if(!showColumnSearchMenu(k)){h.onHeaderTriggerClick(k,l,k.triggerEl)}});b.on("sortchange",function(f,g,h,e){if(Ext.isEmpty(g.dataIndex)){return}g.sortDirection=h;refreshColumnStyle(g)});b.on("columnresize",function(f,h,g,e){h.width=g;f.sortOnClick=false});b.on("columnschanged",function(f,e){f.sortOnClick=false});b.on("cellcontextmenu",function(m,p,g,f,k,o,l,h){if(Ext.isEmpty(l.position.column.dataIndex)){return}if(Ext.isObject(b.contextMenu)){if(b.contextMenu.items.length>0){b.contextMenu.cellIndex=g;b.contextMenu.record=f;b.contextMenu.rowIndex=o;b.contextMenu.cellTd=p;b.contextMenu.tr=k;b.contextMenu.cellContext=l.position;m.getSelectionModel().select(f);m.fireEvent("selectionchange",m,f,h);fireMenuEvent(b.contextMenu,"onBeforeShow");b.contextMenu.showAt(l.getXY())}}});b.getStore().on("endupdate",function(f){try{if(b.getStore().holdUpdate){return true}let records=b.getStore().getUpdatedRecords();Ext.each(b.updateButtons,function(h,e){h.setDisabled(records.length==0)});if(b.operate&&b.operate.autoUpdate){commitStoreUpdate(b.getStore())}}catch(g){showException(g,"endupdate")}});b.on("celldblclick",function(m,p,g,f,k,o,l,h){b.doEdit=true});b.on("beforeedit",function(g,f,e){if(!b.doEdit){return false}b.doEdit=false;if(!toBool(f.column.editable,true)){return false}if(f.column.hasListener("beforeedit")){if(!f.column.fireEvent("beforeedit",f)){return false}}let editorField=f.column.field;let cell=Ext.get(f.cell);editorField.labelTitle=f.column.text;if(Ext.isFunction(editorField.setValue)&&!toBool(f.column.password,false)){if(Ext.isObject(f.value)||Ext.isArray(f.value)){editorField.setValue(JSON.stringify(f.value),f.record)}else{editorField.setValue(f.value,f.record)}}if(Ext.isFunction(editorField.showWindow)){editorField.showWindow(cell,function(h){if(Ext.isEmpty(f.value)&&Ext.isEmpty(h.getValue())){return}setRecordValue(f.record,f.field,h)});return false}if(!f.column.editMenu){f.column.editMenu=Ext.create("Ext.menu.Menu",{modal:true,layout:"fit",showSeparator:false,items:[{xtype:"panel",layout:"fit",width:cell.getWidth(),height:cell.getHeight(),style:{background:"#ffffff",borderWidth:1,borderColor:"#ffffff",color:"#eeeee"},border:0,items:[editorField]}],listeners:{show:function(k,h){let fieldObj=k.items.get(0).items.get(0);fieldObj.focus();new Ext.KeyMap(k.getEl(),[{key:13,fn:function(){k.hide()},scope:k}])},beforehide:function(k,h){let fieldObj=k.items.get(0).items.get(0);if(!fieldObj.isValid()){shakeComment(k);return false}return true},hide:function(k,h){if(!k.context){return}let fieldObj=k.items.get(0).items.get(0);if((Ext.isEmpty(k.context.value)||toBool(k.context.column.password,false))&&Ext.isEmpty(fieldObj.getValue())){return}setRecordValue(k.context.record,k.context.field,fieldObj)}}})}f.column.editMenu.setWidth(f.column.getWidth());f.column.editMenu.context=f;f.column.editMenu.showBy(cell,"tl");return false});b.on("selectionchange",function(k,g,f){try{if(b.selectButtons){Ext.each(b.selectButtons,function(l,e){let selectSize=k.getSelection().length;let checkSelect=l.checkSelect;if(checkSelect=="multiple"||checkSelect=="m"||checkSelect>1){l.setDisabled(!(selectSize>0))}else{if(checkSelect=="radio"||checkSelect=="r"||checkSelect=="single"||checkSelect=="s"||checkSelect==1){l.setDisabled(!(selectSize==1))}}})}}catch(h){showException(h,"按钮选中检测！[selectionchange]")}})}function configGridLayout(b){return new Ext.Promise(function(f,e){if(!b){return}b.setLoading("初始化配置中……");restoreGridOperate(b).then(function(){restoreGridColumn(b).then(function(){f(true)})})})}function configGridHeadMenu(b){if(!toBool(b.columnContextMenu,true)){return}if(!b.columnHeadMenu){return}if(!b.columnMenu){b.columnMenu={}}if(!b.columnMenu){return}let menu=b.columnHeadMenu;menu.on("beforeshow",function(e){if(isFilesColumn(e.activeHeader)||isFileColumn(e.activeHeader)||!hasColumnField(menu.activeHeader)){e.activeHeader.batchUpdate=false;e.activeHeader.operation=false;e.activeHeader.searchLink=false}if(isContentColumn(e.activeHeader)){e.activeHeader.searchLink=false}if(!e.configHeadMenu){e.configHeadMenu=true;let menus=[];if(toBool(b.columnMenu.lookField,true)){menus.push({text:"查看字段",iconCls:"extIcon extField",onBeforeShow:function(){if(toBool(menu.activeHeader.lookField,true)){this.show()}else{this.hide()}},handler:function(){Ext.Msg.alert("查看字段",menu.activeHeader.dataIndex)}})}if(b.getStore().entity){if(toBool(b.columnMenu.searchLink,true)){menus.push({text:"配置搜索链",iconCls:"extIcon extLink",onBeforeShow:function(){if(toBool(menu.activeHeader.searchLink,true)){this.show()}else{this.hide()}},handler:function(){configColumnSearchLink(menu.activeHeader)}})}if(toBool(b.columnMenu.operation,true)){menus.push({text:"计算数据",iconCls:"extIcon extMath",onBeforeShow:function(){if(toBool(menu.activeHeader.operation,false)){this.show()}else{this.hide()}},menu:[{text:"计算总和",iconCls:"extIcon extMath",handler:function(){showCompute(b,menu.activeHeader,"sum")}},{text:"计算平均值",iconCls:"extIcon extMath",handler:function(){showCompute(b,menu.activeHeader,"avg")}},{text:"计算最大值",iconCls:"extIcon extMath",handler:function(){showCompute(b,menu.activeHeader,"max")}},{text:"计算最小值",iconCls:"extIcon extMath",handler:function(){showCompute(b,menu.activeHeader,"min")}}]})}}if(toBool(b.columnMenu.batchUpdate,true)){menus.push({text:"批量修改值",iconCls:"extIcon extEdit",onBeforeShow:function(){if(toBool(menu.activeHeader.batchUpdate,true)){this.show()}else{this.hide()}},handler:function(){batchEditColumn(menu.activeHeader)}});menus.push({text:"批量随机值",iconCls:"extIcon extRandom",onBeforeShow:function(){if(isLinkColumn(menu.activeHeader)){this.hide();return}if(toBool(menu.activeHeader.batchUpdate,true)){this.show()}else{this.hide()}},handler:function(){batchEditColumnRandom(menu.activeHeader)}})}if(toBool(b.columnMenu.cancelSort,true)){menus.push({text:"取消排序",iconCls:"extIcon extCancelOrder",onBeforeShow:function(){if(toBool(menu.activeHeader.cancelSort,true)){this.show()}else{this.hide()}},handler:function(){try{let sortCollection=b.getStore().getSorters();if(sortCollection.count()==0){return}sortCollection.removeByKey(menu.activeHeader.dataIndex);b.getStore().loadPage(1);menu.activeHeader.sortDirection=null;refreshColumnStyle(menu.activeHeader)}catch(f){showException(f)}}})}e.insert(0,menus)}fireMenuEvent(e,"onBeforeShow")})}function getGridSelModel(){return Ext.create("Ext.grid.selection.SpreadsheetModel",{pruneRemoved:false,checkboxSelect:true,hasLockedHeader:true,cellSelect:false,rowNumbererHeaderWidth:0})}function getPageToolBar(b){let pagingtoolbar=Ext.create("Ext.toolbar.Paging",{store:b,dock:"bottom",pageSize:b.pageSize,displayInfo:true,inputItemWidth:70,overflowHandler:"scroller"});let control={xtype:"combo",pageTool:true,displayField:"text",valueField:"id",fieldLabel:"每页",labelWidth:40,editable:false,width:130,value:b.pageSize,store:getPageDataStore(),listeners:{change:function(g,f,e){if(f!=null&&f!=0){let pageRecord=g.getStore().getById(f);if(pageRecord==null){g.totalCount=f;g.setValue(-1);return}if(f==-1){this.ownerCt.pageSize=b.getTotalCount();b.pageSize=b.getTotalCount();if(!Ext.isEmpty(g.totalCount)){this.ownerCt.pageSize=g.totalCount;b.pageSize=g.totalCount}}else{this.ownerCt.pageSize=f;b.pageSize=f}b.loadPage(1)}}}};let copyBtn={xtype:"button",tooltip:"拷贝数据",iconCls:"extIcon extCopy2 grayColor",handler:function(){let selection=b.grid.getSelection();if(selection.length==0){showAlert("系统提醒","请选择需要复制的数据！");return}Ext.Msg.confirm("系统提醒","您确定复制选中的"+selection.length+"条数据吗？",function(e,f){if(e=="yes"){showWait("正在复制数据中……");commitStoreCopy(b.grid.getStore(),b.grid.getSelection()).then(function(g){if(g){b.grid.getSelectionModel().deselectAll();let grouped=b.grid.getStore().isGrouped();if(grouped){b.grid.getView().getFeature("group").collapseAll()}hideWait()}})}})}};let deleteAllBtn={xtype:"button",tooltip:"清空数据",iconCls:"extIcon extClear grayColor",handler:function(){let confirmFunction=function(e,f){if(e=="yes"){showWait("正在清空数据中……");let storeParams=b.grid.getStore().proxy.extraParams;let params={entityCode:b.entity.entityCode,all:true};if(b.grid.getStore().entity.menu){params.menu=b.grid.getStore().entity.menu.text}server.deleteEntity(mergeJson(params,storeParams),function(h,g){hideWait();if(h){b.loadPage(1)}showAlert("系统提醒",g)})}};let confirmConfig={title:"系统提醒",icon:Ext.Msg.QUESTION,message:"<b style='color: red;font-size: 16px;line-height: 18px;'>请您谨慎操作！</b><br/>您确定清空当前条件下的所有数据吗？！<br/>当前共"+b.getTotalCount()+"条数据！",buttons:Ext.Msg.YESNO,defaultFocus:"no",callback:confirmFunction};let hideFunction=function(){clearTimeout(Ext.Msg.timeout);let msgButton=Ext.Msg.msgButtons.yes;msgButton.setText("是");msgButton.enable()};Ext.Msg.on("hide",hideFunction,this,{single:true});Ext.Msg.show(confirmConfig);let timeFunction=function(e){let msgButton=Ext.Msg.msgButtons.yes;if(e<=0){msgButton.setText("立即清空");msgButton.enable();return}else{msgButton.setText(e+"秒后可操作");msgButton.disable()}Ext.Msg.timeout=setTimeout(function(){timeFunction(e-1)},1000)};timeFunction(5)}};let searchBtn={xtype:"button",toolType:"searchBtn",tooltip:"搜索数据",iconCls:"extIcon extSearch grayColor",handler:function(){showColumnSearchWin(this,b.grid)}};let sortBtn={xtype:"button",toolType:"sortBtn",tooltip:"排序数据",iconCls:"extIcon extSort grayColor",handler:function(){showColumnSortWin(this,b.grid)}};pagingtoolbar.insert(0,control);let beginIndex=2;let iterateIndex=1;if(system.isSuperRole()){pagingtoolbar.insert(pagingtoolbar.items.getCount()-beginIndex*iterateIndex,"-");pagingtoolbar.insert(pagingtoolbar.items.getCount()-beginIndex*iterateIndex++,deleteAllBtn);pagingtoolbar.insert(pagingtoolbar.items.getCount()-beginIndex*iterateIndex,"-");pagingtoolbar.insert(pagingtoolbar.items.getCount()-beginIndex*iterateIndex++,copyBtn)}pagingtoolbar.insert(pagingtoolbar.items.getCount()-beginIndex*iterateIndex,"-");pagingtoolbar.insert(pagingtoolbar.items.getCount()-beginIndex*iterateIndex++,sortBtn);pagingtoolbar.insert(pagingtoolbar.items.getCount()-beginIndex*iterateIndex,"-");pagingtoolbar.insert(pagingtoolbar.items.getCount()-beginIndex*iterateIndex++,searchBtn);return pagingtoolbar}function deleteGridData(b){return new Ext.Promise(function(f,e){if(!b.getStore().entity){Ext.Msg.alert("系统提醒","删除失败！Grid的DataStore未绑定Entity!");return}if(b.getSelection().length==0){toast("请您先选择需要删除的数据！");return}let selectLength=b.getSelection().length;let doDelete=function(){showWait("正在删除数据中……");commitStoreDelete(b.getStore(),b.getSelection()).then(function(g){if(g){b.getSelectionModel().deselectAll();let grouped=b.getStore().isGrouped();if(grouped){b.getView().getFeature("group").collapseAll()}hideWait()}f(g)})};if(b.operate&&b.operate.alertDelete){let confirmConfig={title:"系统提醒",icon:Ext.Msg.QUESTION,message:"您确定删除选中的"+selectLength+"条数据吗？",buttons:Ext.Msg.YESNO,defaultFocus:"no",callback:function(g,h){if(g=="yes"){doDelete()}}};Ext.Msg.show(confirmConfig)}else{doDelete()}})}function updateGridData(b){return new Ext.Promise(function(f,e){if(!b.getStore().entity){Ext.Msg.alert("系统提醒","修改失败！Grid的DataStore未绑定Entity!");return}let records=b.getStore().getUpdatedRecords();if(records.length==0){toast("当前暂无数据被修改！");return}if(b.operate&&b.operate.alertUpdate){Ext.Msg.confirm("系统提醒","您确定提交被修改的数据吗？",function(g,h){if(g=="yes"){showWait("正在修改数据中……");commitStoreUpdate(b.getStore()).then(function(k){f(k);if(k){hideWait()}})}})}else{showWait("正在修改数据中……");commitStoreUpdate(b.getStore()).then(function(g){f(g);if(g){hideWait()}})}})}function saveGridColumn(b){if(Ext.isEmpty(b.code)){return}return new Ext.Promise(function(g,f){try{let columnInfos={};Ext.each(b.getColumns(),function(k,e){if(!Ext.isEmpty(k.dataIndex)){let columnInfo={column:true};columnInfo.width=k.width;columnInfo.hidden=k.isHidden();columnInfo.locked=k.isLocked();columnInfo.text=k.configText;columnInfo.dataIndex=k.dataIndex;if(b.getStore().entity){columnInfo.entityCode=b.getStore().entityCode}let sortConfig=b.getStore().getSorters().getByKey(k.dataIndex);if(sortConfig){columnInfo.sortDirection=sortConfig.getDirection()}columnInfo.searchLink=k.searchLink;columnInfo.index=k.getIndex();let rendererStr=k.renderer.toString();rendererStr="function "+rendererStr.substring(rendererStr.indexOf("("));columnInfo.renderer=rendererStr;columnInfo.rendererFunction=k.rendererFunction;columnInfos[k.code]=columnInfo}});let pageTool={pageSize:b.getStore().pageSize,column:false};columnInfos.PageTool=pageTool;let params={};if(b.getStore().entity&&b.getStore().entity.menu){params.menuId=b.getStore().entity.menu.id;if(system.isSuperRole()&&toBool(b.tabPanelList,false)){params.entityCode=b.getStore().entity.entityCode}}server.saveExtConfig(b.code,"GridColumn",Ext.encode(columnInfos),function(k,e){g(k)},params)}catch(h){f(h)}})}function restoreGridOperate(b){return new Ext.Promise(function(g,f){try{if(Ext.isEmpty(b.code)){f("Grid编号[code]不可为空！");return}server.showExtConfig(b.code,"GridOperate",function(k,e){if(k){b.operate=Ext.decode(e)}else{if(Ext.isEmpty(b.operate)){b.operate={alertDelete:true,alertUpdate:true,autoUpdate:false,autoDetails:true,hoverTip:false}}}g()})}catch(h){f(h)}})}function restoreGridColumn(b){return new Ext.Promise(function(g,f){try{if(Ext.isEmpty(b.code)){f("Grid编号[code]不可为空！");return}server.showExtConfig(b.code,"GridColumn",function(k,e){let columnInfos={};if(k){columnInfos=Ext.decode(e)}let newColumns=[];let sorts=[];let configColumns=b.getColumns();for(let i=0;i<configColumns.length;i++){let column=configColumns[i];if(!Ext.isEmpty(column.dataIndex)){let newColumn=column.cloneConfig();if(columnInfos.hasOwnProperty(column.code)){let info=columnInfos[column.code];for(let key in info){if(key=="renderer"||key=="rendererFunction"){continue}newColumn[key]=info[key];if(key=="sortDirection"){sorts.push({property:newColumn.dataIndex,direction:newColumn.sortDirection})}}}newColumns.push(newColumn)}}newColumns.sort(function(m,l){return m.index-l.index});if(columnInfos.hasOwnProperty("PageTool")){let pageTool=columnInfos.PageTool;b.getStore().pageSize=pageTool.pageSize;let comboPage=b.down("combo[pageTool=true]");if(comboPage){comboPage.setValue(pageTool.pageSize)}}b.getStore().sort(sorts);b.reconfigure(newColumns);g()})}catch(h){f(h)}})}function createDetailsGrid(){let detailsStore=Ext.create("Ext.data.Store",{autoLoad:false,fields:[]});let detailsGrid=Ext.create("Ext.grid.Panel",{border:0,scrollable:"y",region:"center",store:detailsStore,hideHeaders:true,deferRowRender:true,superGrid:null,setRecord:function(e,b){this.superGrid=e;let columns=e.getColumns();let data=[];for(let i=0;i<columns.length;i++){let column=columns[i];if(Ext.isEmpty(column.dataIndex)||!toBool(column.hideable,true)){continue}let item={text:column.configText,value:b.get(column.dataIndex),dataIndex:column.dataIndex,renderer:column.renderer,index:column.getIndex(),record:b};data.push(item)}detailsStore.loadData(data);detailsStore.sort("index","ASC")},columns:[{header:"名称",dataIndex:"text",align:"right",flex:0.3,tdCls:"tdVTop",renderer:function(f,b,e){b.style="color:#000000;overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space:normal !important;line-height:20px;word-break:break-word; ";return"<b>"+f+"：</b>"}},{header:"值",dataIndex:"value",flex:0.7,align:"left",renderer:function(h,b,f){try{b.style="overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space:normal !important;line-height:20px;word-break:break-word; ";let fun=f.get("renderer");if(Ext.isFunction(fun)){let value=fun(h,b,f.get("record"),-1,-1,null,null,true);if(Ext.isEmpty(value)){return"<font color='#ccc'>无</font>"}return value}return h}catch(g){return h}}}],tbar:{flex:1,emptyText:"查找属性（轻敲回车键）",margin:"5",xtype:"textfield",doSearch:function(){let currIndex=0;let dataIndex=detailsStore.getAt(0).get("dataIndex");let text=null;let searchKey=this.getValue();if(!Ext.isEmpty(searchKey)){detailsStore.each(function(b,e){let fieldName=b.get("text").toString();let fieldValue=b.get("value");if(fieldName.indexOf(searchKey)>=0){currIndex=e;dataIndex=b.get("dataIndex");text=fieldName;return}if(!Ext.isEmpty(fieldValue)&&fieldValue.toString().indexOf(searchKey)>=0){currIndex=e;dataIndex=b.get("dataIndex");text=fieldName;return false}})}scrollToColumn(detailsGrid.superGrid,dataIndex,text);detailsGrid.getSelectionModel().select(currIndex);detailsGrid.view.focusRow(currIndex);this.focus()},triggers:{search:{cls:"text-search",handler:function(){this.doSearch()}}},listeners:{render:function(e,b){new Ext.KeyMap(e.getEl(),[{key:13,fn:function(){this.doSearch()},scope:this}])}}},bbar:{xtype:"label",style:{background:"#ffffff"},text:"小技巧：双击属性可快速定位左侧表格对应的列！",padding:"10"},viewConfig:{enableTextSelection:true},listeners:{itemdblclick:function(){try{let data=this.getSelectionModel().getSelection();scrollToColumn(this.superGrid,data[0].get("dataIndex"),data[0].get("text"))}catch(b){showException(b,"details:itemdblclick")}}}});return detailsGrid}function getDetailsPanel(b){let timestamp=Ext.now();let subtitle="";if(b.getStore().entity.menu){subtitle=b.getStore().entity.menu.text}let detailsPanel=Ext.create("Ext.panel.Panel",{title:"数据详情",subtitle:subtitle,iconCls:"extIcon extDetails",layout:"border",region:"east",border:0,width:258,minWidth:200,collapsed:false,maxWidth:688,split:true,autoScroll:false,scrollable:false,closeAction:"hide",dataId:-1,hidden:true,currIsClosed:false,closeTimer:null,setRecord:function(f){try{let me=this;window.clearTimeout(me.closeTimer);if(f!=null){let data=f.getSelectionModel().getSelection();if(data.length==1){me.items.get(0).setRecord(f,data[0]);me.show()}else{if(me.isVisible()){me.closeTimer=setTimeout(function(){me.close();setTimeout(function(){let left=f.view.getEl().getScrollLeft();f.view.getEl().scrollTo("left",left-1,false)},100)},80)}}}else{me.close()}}catch(g){showException(g)}},listeners:{collapse:function(f,e){Ext.getCmp("close"+timestamp).setHidden(true)},beforeexpand:function(f,e){Ext.getCmp("close"+timestamp).setHidden(false)}},tools:[{type:"gear",callback:function(){setGrid(this,b)}},{type:"close",id:"close"+timestamp,callback:function(){detailsPanel.collapse()}}],items:[createDetailsGrid()]});b.detailsPanel=detailsPanel;b.on("selectionchange",function(k,g,f){try{if(b.operate&&b.operate.autoDetails){if(!Ext.isEmpty(b.detailsPanel)){b.detailsPanel.setRecord(b)}}else{b.detailsPanel.close()}}catch(h){showException(h)}});return detailsPanel}function exportGrid(b){if(!b.getStore().entity){Ext.Msg.alert("系统提醒","导出失败！Grid的DataStore未绑定Entity!");return}Ext.Msg.confirm("系统提醒","您确定导出当前条件下的所有数据吗？",function(e,f){if(e=="yes"){let storeParams=b.getStore().proxy.extraParams;let params={};if(b.getStore().entity.menu){params.title=b.getStore().entity.menu.text}Ext.each(b.getColumns(),function(h,g){if(isFileColumn(h)||isFilesColumn(h)){return}if(!Ext.isEmpty(h.dataIndex)){params["column["+g+"].width"]=h.width;params["column["+g+"].text"]=h.configText;params["column["+g+"].enum"]=getEnumName(h);params["column["+g+"].dataIndex"]=h.dataIndex}});showWait("正在导出中……");server.exportExcel(mergeJson(params,storeParams),function(k,h,g){hideWait();if(k){toast("导出成功！");location.href="attach/"+h}else{Ext.Msg.alert("系统提醒","导出失败！"+g)}})}})}function setGrid(e,b){let setPanel=Ext.create("Ext.form.Panel",{bodyPadding:5,region:"center",autoScroll:true,viewModel:{data:b.operate},defaults:{labelWidth:60},items:[{xtype:"checkboxfield",fieldLabel:"删除提醒",labelAlign:"right",name:"alertDelete",columnWidth:1,bind:"{alertDelete}",uncheckedValue:false,boxLabel:"删除数据时，系统会弹出确认删除框，避免误操作删除！"},{xtype:"checkboxfield",fieldLabel:"修改提醒",labelAlign:"right",columnWidth:1,name:"alertUpdate",bind:"{alertUpdate}",uncheckedValue:false,boxLabel:"修改数据时，系统会弹出确认修改框，避免误操作修改！"},{xtype:"checkboxfield",fieldLabel:"自动提交",labelAlign:"right",columnWidth:1,name:"autoUpdate",bind:"{autoUpdate}",uncheckedValue:false,boxLabel:"双击编辑修改数据后，系统自动提交被修改的数据！"},{xtype:"checkboxfield",fieldLabel:"弹出详情",labelAlign:"right",columnWidth:1,name:"autoDetails",bind:"{autoDetails}",uncheckedValue:false,boxLabel:"点击数据时，右侧自动弹出此数据的详情窗体！"},{xtype:"checkboxfield",fieldLabel:"悬浮阅览",labelAlign:"right",columnWidth:1,name:"hoverTip",bind:"{hoverTip}",uncheckedValue:false,boxLabel:"当鼠标悬浮在数据超过2秒后，会在鼠标右下方弹出此数据的阅览！"}]});let winTitle="操作设置";if(b.getStore().entity&&b.getStore().entity.menu){winTitle=b.getStore().entity.menu.text+"-"+winTitle}let win=Ext.create("Ext.window.Window",{title:winTitle,height:370,iconCls:"extIcon extSet",width:300,layout:"border",resizable:false,animateTarget:e,items:[setPanel],modal:true,constrain:true,buttons:["->",{text:"保存配置",iconCls:"extIcon extSave whiteColor",handler:function(){showWait("正在保存中…");server.saveExtConfig(b.code,"GridOperate",Ext.encode(setPanel.getForm().getValues()),function(g,f){hideWait();if(g){b.operate=setPanel.getForm().getValues();toast("操作设置成功！");win.close()}else{Ext.Msg.alert("系统提醒",f)}})}},{text:"取消",iconCls:"extIcon extClose",handler:function(){win.close()}}]});win.show()}function showDetailsWindow(obj,title,entity,record){server.showColumns(entity.entityCode,function(success,value,message){if(success){let columnInfos=Ext.decode(value);let data=[];for(let key in columnInfos){if(columnInfos.hasOwnProperty(key)){let column=columnInfos[key];if(Ext.isEmpty(column.dataIndex)){continue}let d={value:record.get(column.dataIndex),record:record};for(let c in column){if(column.hasOwnProperty(c)){d[c]=column[c]}}data.push(d)}}data.sort(function(a,b){return a.index-b.index});let detailsStore=Ext.create("Ext.data.Store",{autoLoad:false,fields:[]});detailsStore.loadData(data);detailsStore.sort("index","ASC");let detailsGrid=Ext.create("Ext.grid.Panel",{border:0,scrollable:"y",region:"center",store:detailsStore,hideHeaders:true,columns:[{header:"名称",power:false,dataIndex:"text",flex:0.3,tdCls:"tdVTop",align:"right",renderer:function(val,m,r){m.style="overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space:normal !important;line-height:20px;word-break:break-word; ";return"<b>"+val+"：</b>"}},{header:"值",dataIndex:"value",power:false,flex:0.7,align:"left",renderer:function(val,m,r){try{m.style="overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space:normal !important;line-height:20px;word-break:break-word; ";let fun=null;let rendererFunction=r.get("rendererFunction");if(rendererFunction){fun=eval(rendererFunction)}else{let renderer=r.get("renderer");fun=loadFunction(renderer)}if(!Ext.isEmpty(fun)){val=fun(val,m,r.get("record"),-1,-1,null,null,true)}if(Ext.isEmpty(val)||val=="null"){return"<font color='#ccc'>无</font>"}return val}catch(e){return val}}}],viewConfig:{loadMask:{msg:"正在为您在加载数据…"},enableTextSelection:true}});let win=Ext.create("Ext.window.Window",{title:title,height:450,width:400,minHeight:300,iconCls:"extIcon extDetails",minWidth:200,layout:"border",resizable:true,constrain:true,maximizable:true,animateTarget:obj,listeners:{destroy:function(obj,op){},show:function(obj){obj.focus()}},items:[detailsGrid]});win.show()}else{showAlert("系统提醒",message)}})}function hasSearchColumn(b){let search=false;Ext.each(b.getColumns(),function(f,e){if(!Ext.isEmpty(f.dataIndex)){if(f.where&&f.where.length>0){search=true;return false}}});return search}Ext.override(Ext.grid.column.Column,{afterRender:Ext.Function.createSequence(Ext.grid.column.Column.prototype.afterRender,function(){let me=this;me.code=getPowerCode(me);if(!me.renderer){me.renderer=renders.normal()}if(me.rendererFunction){me.renderer=eval(me.rendererFunction)}configColumnProperty(me)})});function isColumnType(b){return b=="gridcolumn"||b.xtype=="gridcolumn"}function getColumnFieldType(b){if(Ext.isObject(b.field)){return b.field.xtype}return b.field}function getColumnGrid(b){if(!b.grid){b.grid=b.up("treepanel,grid")}if(b.grid.ownerGrid){return b.grid.ownerGrid}return null}function configColumnProperty(b){b.configText=b.text;b.toSearchKey=function(e,f){return"where['"+this.getIndex()+f+this.dataIndex+e.compare+"']"};b.searchValue=function(e){let me=this;if(!me.where){me.where=[]}let where={compare:"=",value:e};me.where.push(where);me.doSearch()};b.clearSearch=function(){let me=this;let storeParams=getColumnGrid(me).getStore().proxy.extraParams;if(me.where){for(let i=0;i<me.where.length;i++){let key=me.toSearchKey(me.where[i],i);if(storeParams.hasOwnProperty(key)){delete storeParams[key]}}}me.where=[];me.searchMenu=null;me.setStyle("color","#444444")};b.doSearch=function(e){let me=this;let storeParams=getColumnGrid(me).getStore().proxy.extraParams;if(me.where){for(let i=0;i<me.where.length;i++){let w=me.where[i];let key=me.toSearchKey(w,i);let value=w.value;if(w.compare.indexOf("?")>=0){value="%"+w.value+"%"}storeParams[key]=value}if(toBool(e,true)){getColumnGrid(me).getStore().loadPage(1)}if(me.where.length==0){me.setStyle("color","#444444")}else{me.setStyle("color","red")}}checkColumnSearch(getColumnGrid(me))}}function refreshColumnStyle(b){if(!Ext.isEmpty(b.dataIndex)){let sortDirection=b.sortDirection;if(Ext.isEmpty(sortDirection)){sortDirection="<font size='1'></font>"}else{if(sortDirection=="ASC"){sortDirection="<font color='red' size='1'>&nbsp;&nbsp;[正序]</font>"}else{sortDirection="<font color='red' size='1'>&nbsp;&nbsp;[倒序]</font>"}}if(Ext.isEmpty(b.sumText)){b.sumText="<font size='1'></font>"}b.setText("&nbsp;"+b.configText+b.sumText+sortDirection+"&nbsp;");checkColumnSort(getColumnGrid(b))}}function checkColumnSearch(b){let hasSearch=false;Ext.each(b.getColumns(),function(e){if(e.where){if(e.where.length>0){hasSearch=true;return false}}});let dockeds=b.getDockedItems('toolbar[dock="bottom"]');let searchBtn=dockeds[0].down("button[toolType=searchBtn]");if(hasSearch){searchBtn.setIconCls("extIcon extSearch redColor")}else{searchBtn.setIconCls("extIcon extSearch grayColor")}}function checkColumnSort(b){let hasSort=b.getStore().getSorters().length>0;let dockeds=b.getDockedItems('toolbar[dock="bottom"]');let sortBtn=dockeds[0].down("button[toolType=sortBtn]");if(hasSort){sortBtn.setIconCls("extIcon extSort redColor")}else{sortBtn.setIconCls("extIcon extSort grayColor")}}function showColumnSearchMenu(b){if(!toBool(getColumnGrid(b).columnSearch,true)){return false}if(isFilesColumn(b)||isFileColumn(b)){return false}if(!toBool(b.search,true)){return false}if(toBool(b.encrypt,false)){return false}if(!b.searchMenu){b.searchMenu=new Ext.menu.Menu({padding:"0 0 0 0",power:false,showSeparator:false,style:{background:"#ffffff"},addSearchItem:function(e){let index=this.items.length-1;if(index>=5){return}this.insert(index,buildSearchItem(b,e))},doSearch:function(){let me=this;let where=[];me.items.each(function(f,e){if(f.searchItem){let toParam=f.toParam();if(toParam==null){where=null;return false}if(Ext.isEmpty(toParam.value)){return}toParam.index=e;where.push(toParam)}});if(where){b.clearSearch();b.where=where;b.doSearch();me.hide()}},items:[{xtype:"panel",layout:"hbox",margin:"2",border:0,items:[{xtype:"button",text:"搜索",flex:1,iconCls:"extIcon extSearch",margin:"0 2 0 0",handler:function(){this.ownerCt.ownerCt.doSearch()}},{xtype:"button",iconCls:"extIcon extPlus fontSize14",width:35,handler:function(){this.ownerCt.ownerCt.addSearchItem()}}]}],listeners:{show:function(f,e){if(f.items.length==1){f.addSearchItem()}}}})}if(b.where){for(let i=0;i<b.where.length;i++){let where=b.where[i];if(Ext.isEmpty(where.index)){where.index=i}if(where.index<b.searchMenu.items.length-1){b.searchMenu.items.getAt(where.index).setParam(where)}else{b.searchMenu.addSearchItem(where)}}}b.searchMenu.setWidth(Math.max(b.width,200));b.searchMenu.showBy(b,"tl-bl?");return true}function buildSearchItem(e,b){let editorField=getColumnSimpleEditor(e,true);editorField.flex=1;editorField.margin="2 2 0 0";editorField.repeatTriggerClick=false;editorField.onClearValue=function(){if(Ext.isFunction(this.ownerCt.removeSearch)){this.ownerCt.removeSearch();return}this.ownerCt.destroy()};editorField.triggers={close:{cls:"text-clear",handler:function(){this.onClearValue()}}};editorField.editable=true;editorField.emptyText="请输入条件值";editorField.listeners={afterrender:function(g,f){if(Ext.isFunction(g.getTrigger)){if(g.getTrigger("picker")){g.getTrigger("picker").hide()}if(g.getTrigger("spinner")){g.getTrigger("spinner").hide()}}}};if(isDateField(editorField)){editorField.editable=false}if(!b){b={compare:"=",value:""};if(isTextField(editorField)){b.compare="?"}else{if(isDateField(editorField)){b.compare=">"}}}editorField.value=b.value;editorField.submitValue=false;editorField.name="value";let panel={xtype:"panel",margin:"0",searchItem:true,border:0,flex:1,region:"center",layout:"hbox",toParam:function(){let params={};this.items.each(function(f){if(Ext.isFunction(f.getValue)){if(f.isValid()){params[f.getName()]=f.getValue()}else{shakeComment(f);toast(f.getErrors()[0]);params=null;return false}}});return params},setParam:function(f){this.items.each(function(g){if(Ext.isFunction(g.getValue)){if(g.getName()=="compare"){g.setValue(f.compare)}else{g.setValue(f.value)}}})},items:[{xtype:"combo",name:"compare",value:b.compare,margin:"2 2 0 2",width:35,valueField:"text",editable:false,hideTrigger:true,tpl:Ext.create("Ext.XTemplate",'<ul class="x-list-plain"><tpl for=".">','<li role="option" class="x-boundlist-item" style="font-size: 12px;">{desc}</li>',"</tpl></ul>"),listeners:{afterrender:function(g,f){g.getPicker().setMinWidth(100)}},store:getCompareDataStore()},editorField]};return panel}function showCompute(b,f,e){if(!b.getStore().entity){Ext.Msg.alert("系统提醒","计算失败！Grid的DataStore未绑定Entity!");return}let selection=b.getSelection();if(selection.length>0){let value=null;let title="";for(let i=0;i<selection.length;i++){let record=selection[i];let columnValue=parseFloat(record.get(f.dataIndex));if(e=="sum"){title=f.configText+"总和：";if(!value){value=0}value+=columnValue}else{if(e=="avg"){title=f.configText+"平均值：";if(!value){value=0}value+=columnValue}else{if(e=="min"){title=f.configText+"最小值：";if(!value){value=columnValue}value=Math.min(columnValue,value)}else{if(e=="max"){title=f.configText+"最大值：";if(!value){value=columnValue}value=Math.max(columnValue,value)}}}}}if(e=="avg"){value=value/selection.length}if(Ext.isFunction(f.renderer)){Ext.Msg.alert("系统提醒","当前选中的数据，"+title+f.renderer(value))}else{Ext.Msg.alert("系统提醒","当前选中的数据，"+title+value)}return}let storeParams=b.getStore().proxy.extraParams;let params={entityCode:b.getStore().entity.entityCode,field:f.dataIndex,type:e};showWait("正在计算中……");$.post("entity/compute",mergeJson(params,storeParams),function(g){hideWait();let msg="";if(e=="sum"){msg=f.configText+"总和："}else{if(e=="avg"){msg=f.configText+"平均值："}else{if(e=="min"){msg=f.configText+"最小值："}else{if(e=="max"){msg=f.configText+"最大值："}}}}if(Ext.isFunction(f.renderer)){Ext.Msg.alert("系统提醒",msg+f.renderer(g.data))}else{Ext.Msg.alert("系统提醒",msg+g.data)}})}function getColumnSimpleEditor(e,b){let editor={};if(Ext.isObject(e.field)){editor.xtype=e.field.xtype}else{editor.xtype=e.field}if(Ext.isObject(e.config.field)){if(b){editor=copy(e.config.field)}else{editor=e.config.field}}if(b){if(isContentField(e.field)||isHtmlContentField(e.field)||isTargetField(e.field)||isPCAField(e.field)){editor.xtype="textfield"}}if(Ext.isEmpty(editor.xtype)){editor.xtype="textfield"}editor.dataIndex=e.dataIndex;return editor}function hasColumnField(b){if(Ext.isObject(b.field)){return true}if(!Ext.isEmpty(b.field)){return true}return false}function isDateColumn(b){if(!b){return false}return isDateField(b.field)}function isNumberColumn(b){if(!b){return false}return isNumberField(b.field)}function isFileColumn(b){if(!b){return false}return isFileField(b.field)}function isContentColumn(b){if(!b){return false}return isHtmlContentField(b.field)||isContentField(b.field)}function isFilesColumn(b){if(!b){return false}return isFilesField(b.field)}function isEnumColumn(b){if(!b){return false}return isEnumField(b.field)}function isLinkColumn(b){if(!b){return false}return isLinkField(b.field)}function getEnumName(b){if(isEnumColumn(b)){if(Ext.isObject(b.field)){return b.field.enumName}}return null}function getColumn(e,b,f){let columns=e.getColumns();for(let i=0;i<columns.length;i++){let column=columns[i];if(column.dataIndex==b){if(f&&column.text==f){return column}return column}}return null}function blinkColumn(b){if(b.blinking){return}b.blinking=true;let currColor=b.getEl().getStyle("color");let currBGColor=b.getEl().getStyle("background");let changeBg="#e41f00";if(currBGColor.indexOf("linear-gradient")>0){changeBg="linear-gradient(0deg, #e41f00, #fefefe)"}b.setStyle({color:"white",background:changeBg});setTimeout(function(){b.setStyle({color:currColor,background:currBGColor});b.blinking=false},1000)}function scrollToColumn(e,b,f){let column=getColumn(e,b,f);blinkColumn(column);let x=column.getLocalX();e.view.getEl().scrollTo("left",x,true)}function batchEditColumn(b){let editorField=b.batchField;if(!editorField){editorField=getColumnSimpleEditor(b);editorField.flex=1;editorField.emptyText="请输入";editorField=b.batchField=Ext.create(editorField)}let putRecord=function(e){if(!Ext.isEmpty(e.getValue())){getColumnGrid(b).getStore().holdUpdate=true;let selectData=getColumnGrid(b).getSelectionModel().getSelection();if(selectData.length>0){Ext.each(selectData,function(f,g){setRecordValue(f,b.dataIndex,e)})}else{getColumnGrid(b).getStore().each(function(f,g){setRecordValue(f,b.dataIndex,e)})}getColumnGrid(b).getStore().holdUpdate=false;getColumnGrid(b).getStore().fireEvent("endupdate")}};let placeholder="批量修改当前页的【"+b.text+"】数据";if(getColumnGrid(b).getSelection().length>0){placeholder="批量修改选择的"+getColumnGrid(b).getSelection().length+"条【"+b.text+"】数据"}if(Ext.isFunction(editorField.setEmptyText)){editorField.setEmptyText(placeholder)}if(Ext.isFunction(editorField.showWindow)){editorField.showWindow(b,function(e){putRecord(e)},placeholder);return}if(!b.batchEditMenu){b.batchEditMenu=Ext.create("Ext.menu.Menu",{showSeparator:false,layout:"fit",doUpdate:function(){let btn=this.down("button[name='confirm']");btn.setText("稍等");btn.setDisabled(true);let me=this;new Ext.Promise(function(f,e){let fieldObj=me.items.get(0).items.get(0);putRecord(fieldObj);fieldObj.setValue(null);f()}).then(function(){btn.setText("确定");btn.setDisabled(false);me.hide()})},items:[{xtype:"panel",layout:"hbox",style:{background:"#ffffff",borderWidth:1,borderColor:"#ffffff",color:"#eeeee"},border:0,items:[editorField,{xtype:"button",text:"确定",name:"confirm",width:60,margin:"0 0 0 2",handler:function(){b.batchEditMenu.doUpdate()}}]}],listeners:{show:function(f,e){let fieldObj=f.items.get(0).items.get(0);fieldObj.focus();new Ext.KeyMap(f.getEl(),[{key:13,fn:function(){editMenu.doUpdate()},scope:f}])},beforehide:function(f,e){let fieldObj=f.items.get(0).items.get(0);if(!fieldObj.isValid()){shakeComment(f);toast(fieldObj.getErrors()[0])}return fieldObj.isValid()}}})}b.batchEditMenu.setWidth(b.getWidth());b.batchEditMenu.showBy(b,"tl")}function configColumnSearchLink(b){let checked="";if(b.searchLink){checked=b.searchLink.checked}system.showMenuColumns(b,checked).then(function(e){if(e.columns.length>0){b.searchLink=e;toast("配置成功！")}else{b.searchLink=null;toast("已清空搜索链！")}})}function showColumnSearchWin(e,b){let store=getGridColumnStore(b,true);let buildItem=function(g,f){let inputItem=buildSearchItem(getColumn(b,g.get("id"),g.get("text")),f);inputItem.removeSearch=function(){this.ownerCt.destroy()};return{xtype:"panel",flex:1,columnWidth:1,layout:"hbox",margin:"0",border:0,toParam:function(){let param={};let combo=this.items.get(0);let g=combo.getStore().findRecord("id",combo.getValue(),0,false,false,true);param.text=g.get("text");param.dataIndex=g.get("id");let inputItem=this.items.get(1);param=mergeJson(param,inputItem.toParam());return param},items:[{xtype:"combo",region:"west",valueField:"id",displayField:"text",flex:0.4,margin:"2 0 0 2",value:g.get("id"),editable:false,listeners:{change:function(m,l,h,k){let parent=this.up("panel");parent.remove(parent.items.get(1),true);let g=m.getStore().findRecord("id",l,0,false,false,true);let inputItem=buildSearchItem(getColumn(b,g.get("id"),g.get("text")));inputItem.removeSearch=function(){this.ownerCt.destroy()};parent.insert(1,inputItem)}},store:store},inputItem]}};let formPanel=Ext.create("Ext.form.FormPanel",{margin:"5",border:0,layout:"column",width:400,scrollable:true,defaults:{labelWidth:80,margin:"5 5 5 5",labelAlign:"right",emptyText:"请填写"},items:[]});Ext.each(b.getColumns(),function(f){if(f.where){let data=store.findRecord("id",f.dataIndex,0,false,false,true);for(let i=0;i<f.where.length;i++){formPanel.add(buildItem(data,f.where[i]))}}});if(formPanel.items.length==0){formPanel.add(buildItem(store.getAt(0)))}if(!e.searchWin){e.searchWin=Ext.create("Ext.window.Window",{title:"搜索数据",layout:"fit",constrain:true,iconCls:"extIcon extSearch",resizable:true,minHeight:200,minWidth:400,height:200,animateTarget:e,items:[formPanel],listeners:{close:function(f,g){e.searchWin=null}},buttons:[{text:"添加条件",iconCls:"extIcon extPlus",handler:function(){formPanel.add(buildItem(store.getAt(0)));let winHeight=50+formPanel.items.length*35+55;formPanel.scrollTo(0,winHeight,false)}},{text:"确定",iconCls:"extIcon extOk",handler:function(){Ext.each(b.getColumns(),function(f){f.clearSearch()});let searchColumns=[];formPanel.items.each(function(f){let toParam=f.toParam();if(Ext.isEmpty(toParam.value)){return}let column=getColumn(b,toParam.dataIndex,toParam.text);if(!column){return false}if(!column.where){column.where=[]}delete toParam.dataIndex;delete toParam.text;column.where.push(toParam);searchColumns.push(column)});Ext.each(searchColumns,function(f){f.doSearch(false)});b.getStore().loadPage(1);checkColumnSearch(b)}}]});b.ownerCt.add(e.searchWin)}e.searchWin.show()}function batchEditColumnRandom(b){let idCode="Random"+Ext.now();let autoType=1;let dateFormat="Y-m-d H:i:s";let dataLength=getColumnGrid(b).getStore().getTotalCount();let title="批量随机生成当前页的【"+b.text+"】列数据";if(getColumnGrid(b).getSelection().length>0){title="批量随机生成选择的"+getColumnGrid(b).getSelection().length+"条【"+b.text+"】列数据";dataLength=getColumnGrid(b).getSelection().length}if(isNumberColumn(b)||isEnumColumn(b)||isLinkColumn(b)){autoType=2}else{if(isDateColumn(b)){autoType=3;if(Ext.isObject(b.field)){dateFormat=b.field.format}}}let textField={xtype:"fieldcontainer",layout:"column",columnWidth:1,id:idCode+"_1",defaults:{labelWidth:60,margin:"5 5 5 5",labelAlign:"right",columnWidth:1,emptyText:"请填写"},items:[{xtype:"fieldset",columnWidth:1,layout:"column",defaults:{labelWidth:60,margin:"5 5 5 5",labelAlign:"right",columnWidth:1,emptyText:"请填写"},title:"文字设置",items:[{fieldLabel:"文字前缀",name:"textPrefix",allowBlank:false,xtype:"textfield"},{fieldLabel:"开始序数",name:"textStartNumber",value:1,allowBlank:false,xtype:"numberfield"}]}]};let numberField={xtype:"fieldcontainer",layout:"column",columnWidth:1,id:idCode+"_2",hidden:true,disabled:true,defaults:{labelWidth:60,margin:"5 5 5 5",labelAlign:"right",columnWidth:1,emptyText:"请填写"},items:[{xtype:"fieldset",columnWidth:1,layout:"column",defaults:{labelWidth:60,margin:"5 5 5 5",labelAlign:"right",columnWidth:1,emptyText:"请填写"},title:"数字设置",items:[{fieldLabel:"保留位数",name:"dotNumber",value:0,allowBlank:false,xtype:"numberfield"},{fieldLabel:"最小数字",name:"minNumber",value:0,allowBlank:false,xtype:"numberfield"},{fieldLabel:"最大数字",name:"maxNumber",allowBlank:false,xtype:"numberfield"}]}]};let dateField={xtype:"fieldcontainer",layout:"column",columnWidth:1,id:idCode+"_3",hidden:true,disabled:true,defaults:{labelWidth:60,margin:"5 5 5 5",labelAlign:"right",columnWidth:1,emptyText:"请填写"},items:[{xtype:"fieldset",columnWidth:1,layout:"column",defaults:{labelWidth:60,margin:"5 5 5 5",labelAlign:"right",columnWidth:1,emptyText:"请填写"},title:"日期设置",items:[{fieldLabel:"最小日期",xtype:"datefield",name:"minDate",allowBlank:false,format:dateFormat},{fieldLabel:"最大日期",xtype:"datefield",name:"maxDate",allowBlank:false,format:dateFormat}]}]};let setPanel=Ext.create("Ext.form.Panel",{bodyPadding:5,region:"center",autoScroll:true,layout:"column",defaults:{labelWidth:60,margin:"5 5 5 5",labelAlign:"right",columnWidth:1,emptyText:"请填写"},items:[{xtype:"combo",name:"autoType",fieldLabel:"随机类型",editable:false,displayField:"text",valueField:"id",value:1,listeners:{change:function(h,g,e,f){Ext.getCmp(idCode+"_"+e).setHidden(true);Ext.getCmp(idCode+"_"+e).setDisabled(true);Ext.getCmp(idCode+"_"+g).setHidden(false);Ext.getCmp(idCode+"_"+g).setDisabled(false)}},store:Ext.create("Ext.data.Store",{fields:["id","text"],data:[{text:"文本",id:1},{text:"数字",id:2},{text:"日期",id:3}]})},textField,numberField,dateField]});let setColumnValue=function(e){if(e.length==0){return}getColumnGrid(b).getStore().holdUpdate=true;let selectData=getColumnGrid(b).getSelectionModel().getSelection();if(selectData.length>0){Ext.each(selectData,function(f,g){f.set(b.dataIndex,e[g])})}else{getColumnGrid(b).getStore().each(function(f,g){f.set(b.dataIndex,e[g])})}getColumnGrid(b).getStore().holdUpdate=false;getColumnGrid(b).getStore().fireEvent("endupdate")};let win=Ext.create("Ext.window.Window",{title:title,height:360,iconCls:"extIcon extRandom",width:450,layout:"border",items:[setPanel],modal:true,constrain:true,listeners:{show:function(){let autoTypeField=setPanel.getField("autoType");autoTypeField.setValue(autoType);autoTypeField.setReadOnly(autoType!=1)}},buttons:["->",{text:"取消",iconCls:"extIcon extClose",handler:function(){win.close()}},{text:"立即生成",iconCls:"extIcon extOk whiteColor",handler:function(){let form=setPanel.getForm();if(form.isValid()){let valueArray=[];let buildType=setPanel.getFieldValue("autoType");if(buildType==1){let textPrefix=setPanel.getFieldValue("textPrefix");let textStartNumber=setPanel.getFieldValue("textStartNumber");for(let i=parseInt(textStartNumber);i<Number.MAX_VALUE;i++){valueArray.push(textPrefix+i);if(valueArray.length==dataLength){break}}}else{if(buildType==2){let dotNumber=setPanel.getFieldValue("dotNumber");let minNumber=setPanel.getFieldValue("minNumber");let maxNumber=setPanel.getFieldValue("maxNumber");if(minNumber>maxNumber){showAlert("系统提醒","最大数字必须大于最小数字！");return}for(let i=0;i<Number.MAX_VALUE;i++){let numberValue=Math.random()*(maxNumber-minNumber)+minNumber;valueArray.push(numberValue.toFixed(dotNumber));if(valueArray.length==dataLength){break}}}else{if(buildType==3){let minDate=setPanel.getFieldValue("minDate");let maxDate=setPanel.getFieldValue("maxDate");if(minDate.getTime()>maxDate.getTime()){showAlert("系统提醒","最大日期必须大于最小日期！");return}for(let i=0;i<Number.MAX_VALUE;i++){let sub=maxDate.getTime()-minDate.getTime();let numberValue=Math.random()*sub+minDate.getTime();let randDate=new Date(numberValue);valueArray.push(Ext.Date.format(randDate,setPanel.getField("minDate").format));if(valueArray.length==dataLength){break}}}}}setColumnValue(valueArray);win.close()}}}]});win.show()}function showColumnSortWin(e,b){let store=getGridColumnStore(b);let buildItem=function(g,f){if(!f){f="ASC"}return{xtype:"panel",flex:1,columnWidth:1,layout:"hbox",margin:"0",border:0,toParam:function(){let param={};let combo=this.items.get(0);param.property=combo.getValue();let directionItem=this.items.get(1);param.direction=directionItem.getValue();return param},items:[{xtype:"combo",region:"west",valueField:"id",flex:0.4,margin:"2 0 0 2",value:g.get("id"),displayField:"text",editable:false,store:store},{xtype:"combo",flex:1,valueField:"value",editable:false,margin:"2 2 0 2",value:f,triggers:{close:{cls:"text-clear",handler:function(){this.ownerCt.destroy()}}},store:Ext.create("Ext.data.Store",{fields:["id","text"],data:[{text:"无",value:"NONE"},{text:"正序",value:"ASC"},{text:"倒序",value:"DESC"}]})}]}};let formPanel=Ext.create("Ext.form.FormPanel",{margin:"5",border:0,layout:"column",width:400,scrollable:true,defaults:{labelWidth:80,margin:"5 5 5 5",labelAlign:"right",emptyText:"请填写"},items:[]});b.getStore().getSorters().each(function(f){let data=store.findRecord("id",f.getProperty(),0,false,false,true);formPanel.add(buildItem(data,f.getDirection()))});if(formPanel.items.length==0){formPanel.add(buildItem(store.getAt(0),"NONE"))}if(!e.sortWin){e.sortWin=Ext.create("Ext.window.Window",{title:"排序数据",layout:"fit",constrain:true,iconCls:"extIcon extSort",resizable:true,minHeight:200,minWidth:400,height:200,animateTarget:e,items:[formPanel],listeners:{close:function(f,g){e.sortWin=null}},buttons:[{text:"添加条件",iconCls:"extIcon extPlus",handler:function(){formPanel.add(buildItem(store.getAt(0)));let winHeight=50+formPanel.items.length*35+55;formPanel.scrollTo(0,winHeight,false)}},{text:"确定",iconCls:"extIcon extOk",handler:function(){let sortCollection=b.getStore().getSorters();sortCollection.clear();Ext.each(b.getColumns(),function(f){f.sortDirection=null;refreshColumnStyle(f)});let sorts=[];formPanel.items.each(function(f){let toParam=f.toParam();sorts.push(toParam);let column=getColumn(b,toParam.property);column.sortDirection=toParam.direction;refreshColumnStyle(column)});if(sorts.length>0){b.getStore().sort(sorts)}else{b.getStore().loadPage(1)}checkColumnSort(b)}}]});b.ownerCt.add(e.sortWin)}e.sortWin.show()}function showMap(g,e,f,b){return new Ext.Promise(function(k,h){let defaultLngLat="";if(!Ext.isEmpty(e)&&!Ext.isEmpty(f)&&parseFloat(e)!=0&&parseFloat(f)!=0){defaultLngLat=e+","+f}let mapPanel=Ext.create("Ext.panel.Panel",{layout:"border",region:"center",border:0});let formPanel=Ext.create("Ext.form.FormPanel",{url:"addData",method:"POST",region:"north",fileUpload:true,autoScroll:true,height:50,layout:"column",defaults:{margin:"5 5 5 5"},items:[{name:"map.taskTitle",fieldLabel:"位置搜索",labelWidth:60,labelAlign:"right",id:"txtSearch",columnWidth:0.8,emptyText:"输入地址",xtype:"textfield"},{xtype:"button",columnWidth:0.2,text:"搜索",handler:function(){doSearch()}}],listeners:{render:function(l){new Ext.KeyMap(l.getEl(),[{key:13,fn:doSearch,scope:Ext.getBody()}])}}});let doSearch=function(){mapFrame.window.searchAddress(Ext.getCmp("txtSearch").getValue())};let bottomPanel=Ext.create("Ext.panel.Panel",{layout:"column",region:"south",border:0,height:42,defaults:{margin:"5 5 5 5"},items:[{xtype:"textfield",id:"lblAddress",fieldLabel:"选择位置",labelWidth:60,value:b,labelAlign:"right",columnWidth:0.8},{xtype:"hiddenfield",id:"lblLngLat",value:defaultLngLat},{xtype:"button",columnWidth:0.2,text:"确定",handler:function(){let lblLngLat=Ext.getCmp("lblLngLat");let lnglat=lblLngLat.getValue();let e=lnglat.split(",")[0];let f=lnglat.split(",")[1];if(!k.called){k.called=true;k({lng:e,lat:f,addr:Ext.getCmp("lblAddress").getValue(),pro:lblLngLat.province,city:lblLngLat.city,area:lblLngLat.area})}win.close()}}]});let containerPanel=Ext.create("Ext.panel.Panel",{layout:"border",border:0,items:[formPanel,mapPanel,bottomPanel]});let win=Ext.create("Ext.window.Window",{title:"选择位置",height:500,iconCls:"extIcon extMap",width:500,layout:"fit",resizable:true,maximizable:true,animateTarget:g,constrain:true,items:[containerPanel],modal:true,listeners:{show:function(){let url=system.formatUrlVersion("base/map/select.html",{mapVersion:getExt("amap-version").value,mapKey:getExt("amap-key").value});mapPanel.update("<iframe name='mapFrame'  src='"+url+"' width='100%' height='100%' frameborder='0' scrolling='no' />")},close:function(l){if(!k.called){k.called=true;k()}}}});win.show();containerPanel.setLoading("正在定位中，请稍后……");window.onMapLoadDone=function(){if(!Ext.isEmpty(defaultLngLat)){mapFrame.window.setLngLatAddress(defaultLngLat)}else{mapFrame.window.startLocation()}};window.closeMapMask=function(){containerPanel.setLoading(false)};window.showMapMask=function(l){if(l){containerPanel.setLoading(l)}else{containerPanel.setLoading(true)}};window.alert=function(l){showAlert("系统提醒",l)};window.setMarkCurrPos=function(m,o,l,q,p){Ext.getCmp("lblAddress").setValue(o);let lblLngLat=Ext.getCmp("lblLngLat");lblLngLat.setValue(m);lblLngLat.province=l;lblLngLat.city=q;lblLngLat.area=p}})}function showAddressInMap(e,b){let mapPanel=Ext.create("Ext.panel.Panel",{layout:"border",region:"center",border:0,listeners:{afterrender:function(g,f){let params={lnglat:b,mapVersion:getExt("amap-version").value,mapKey:getExt("amap-key").value};g.update("<iframe name='mapFrame'  src='"+system.formatUrlVersion("base/map/show.html",params)+"' width='100%' height='100%' frameborder='0' scrolling='no' />")}}});let win=Ext.create("Ext.window.Window",{title:"查看位置",height:500,iconCls:"extIcon extMap",width:500,layout:"border",resizable:true,maximizable:true,animateTarget:e,constrain:true,items:[mapPanel],modal:true});win.show();mapPanel.setLoading("正在请求地址信息……");window.closeMapMask=function(){mapPanel.setLoading(false)}}Ext.override(Ext.menu.Menu,{hide:function(){if(Ext.isEmpty(system)){return}let me=this;if(!me.powerMenu){if(power.menuShowing){return}}if(me.holdShow){return}if(me.pendingShow){me.pendingShow=false}if(!(me.rendered&&!me.isVisible())){if(!me.hasListeners.beforehide||me.fireEvent("beforehide",me)!==false||me.hierarchicallyHidden){me.getInherited().hidden=me.hidden=true;me.fireHierarchyEvent("beforehide");if(me.rendered){me.onHide.apply(me,arguments)}}}return me}});function copyMenu(b){let menus=[];b.items.each(function(f,e){let child={icon:f.icon,text:f.text,handler:f.handler};if(f.getMenu()!=null){child.menu=copyMenu(f.getMenu())}menus.push(child)});return menus}function fireMenuEvent(e,b){if(e){e.items.each(function(g,f){if(g.hasOwnProperty(b)&&Ext.isFunction(g[b])){g[b]()}if(Ext.isFunction(g.getMenu)){fireMenuEvent(g.getMenu(),b)}})}}Ext.define("Fast.ext.EnumComboBox",{alias:["widget.enumcombobox","widget.enumcombo"],extend:"Ext.form.field.ComboBox",enumName:"NONE",enumValue:"id",enumText:"text",exclude:[],firstData:null,lastData:null,initComponent:function(){let me=this;me.displayField=me.enumText;me.valueField=me.enumValue;me.editable=false;me.store=getEnumDataStore(me.enumName,me.firstData,me.lastData);me.store.filterBy(function(b){if(me.exclude.exists(b.get(me.enumValue))){return false}return true});me.callParent()}});Ext.define("Fast.ext.FastFile",{extend:"Ext.form.field.Text",alias:["widget.fastfile","widget.fastfilefield"],fileModules:[],editable:false,getMenu:function(){return this.up("menu")},listeners:{change:function(g,f,b,e){if(Ext.isEmpty(f)){g.getTrigger("help").hide()}else{g.getTrigger("help").show()}},afterrender:function(b){let me=this;if(!this.editable){b.inputEl.on("click",function(){me.selectData()})}}},initComponent:function(){let errorMsg="";for(let i=0;i<this.fileModules.length;i++){let fileModule=this.fileModules[i];errorMsg=errorMsg+"或"+fileModule.tipMsg}this.emptyText="请上传"+errorMsg.substring(1);this.editable=false;this.callParent(arguments)},triggers:{help:{cls:"extIcon extEye",hidden:true,handler:function(){let me=this;if(me.fileModules.length==1){if(me.fileModules[0].type=="images"){if(me.getMenu()){me.getMenu().holdShow=true}me.blur();showImage(me,me.getValue(),function(){if(me.getMenu()){me.getMenu().holdShow=false}},true);return}}location.href=me.getValue()}},search:{cls:"extIcon extUpload",handler:function(){this.selectData()}}},selectData:function(){let me=this;if(me.getMenu()){me.getMenu().holdShow=true}uploadFile(me,me.fileModules).then(function(b){if(me.getMenu()){me.getMenu().holdShow=false}if(b){me.setValue(b.url)}})}});Ext.define("Fast.ext.FastFiles",{alias:["widget.fastfiles","widget.fastfilesfield"],extend:"Ext.form.field.Text",editable:false,fileModules:[],allowBlank:true,autoUpdate:true,getMenu:function(){return this.up("menu")},listeners:{afterrender:function(b){let me=this;if(!this.editable){b.inputEl.on("click",function(){me.showWindow(me)})}}},initComponent:function(){let errorMsg="";for(let i=0;i<this.fileModules.length;i++){let fileModule=this.fileModules[i];errorMsg=errorMsg+"或"+fileModule.tipMsg}this.emptyText="请上传"+errorMsg.substring(1);this.editable=false;this.callParent(arguments)},triggers:{search:{cls:"text-search",handler:function(){this.showWindow(this)}}},showWindow:function(e,b,f){let me=this;showFiles(this,function(g){me.setValue(g);if(Ext.isFunction(b)){b(me)}},me.fileModules,me.getValue())}});Ext.define("Fast.ext.Content",{alias:["widget.content","widget.contentfield"],extend:"Ext.form.field.TextArea",height:220,emptyText:"请填写……",allowBlank:true,getCode:function(){return $.md5(this.getName()+this.dataIndex+this.getFieldLabel())},showWindow:function(e,b,f){if(Ext.isEmpty(f)){f="编辑内容"}let me=this;me.oldValue=me.getValue();if(!me.editorWin){me.editorWin=Ext.create("Ext.window.Window",{title:f,iconCls:"extIcon extEdit",resizable:true,maximizable:true,height:400,width:600,layout:"fit",animateTarget:e,items:[me],modal:true,constrain:true,closeAction:"hide",listeners:{show:function(g){server.showExtConfig(me.getCode(),"TextEditorCache",function(k,h){if(k){me.setValue(h)}})}},buttons:[{text:"暂存",iconCls:"extIcon extSave whiteColor",handler:function(){showWait("暂存中，请稍后……");server.saveExtConfig(me.getCode(),"TextEditorCache",me.getValue(),function(h,g){hideWait();if(h){toast("暂存成功！")}else{showAlert("系统提醒",g)}})}},{text:"重置",iconCls:"extIcon extReset",handler:function(){me.setValue(me.oldValue);server.deleteExtConfig(me.getCode(),"TextEditorCache")}},{text:"确定",iconCls:"extIcon extOk",handler:function(){showWait("请稍后……");server.deleteExtConfig(me.getCode(),"TextEditorCache",function(g){hideWait();if(Ext.isFunction(me.editorWin.callBack)){me.editorWin.callBack(me)}me.editorWin.close()})}}]})}me.editorWin.setTitle(f);me.editorWin.callBack=b;me.editorWin.animateTarget=e;me.editorWin.show()}});Ext.define("Fast.ext.HtmlContent",{alias:["widget.htmlcontent","widget.htmlcontentfield"],extend:"Ext.form.FieldContainer",height:300,getName:function(){return this.name},autoShowEditor:true,allowBlank:true,showEditor:function(){let me=this;window.editorLoadDone=function(){me.setValue(me.value);me.setPostImageUrl(system.formatUrl("upload?type=editor"))};let frameId="EditorFrame"+Ext.now();me.editorFrameId=frameId;let url=system.formatUrlVersion("base/editor/index.html");let html="<iframe id='"+frameId+"'  src='"+url+"' width='100%' height='100%' frameborder='0' scrolling='no' style='border: 1px solid #d0d0d0;'/>";me.update(html)},listeners:{afterrender:function(b){if(b.autoShowEditor){b.showEditor();console.log(b)}}},getCode:function(){return $.md5(this.getName()+this.dataIndex+this.getFieldLabel())},isValid:function(){return true},getValue:function(){let me=this;let value=me.down("[realValue=true]");if(value){return value.getValue()}return me.value},setValue:function(b){let me=this;let value=me.down("[realValue=true]");if(value){value.setValue(b)}me.value=b},setHtml:function(b){this.setValue(b)},setPostImageUrl:function(b){let me=this;if(me.editorFrameId){let iframe=document.getElementById(me.editorFrameId);if(iframe&&Ext.isFunction(iframe.contentWindow.getHtmlValue)){iframe.contentWindow.setPostImageUrl(b)}}},initComponent:function(){let me=this;me.items=[{xtype:"textfield",name:me.name,hidden:true,realValue:true,fieldLabel:me.fieldLabel,allowBlank:me.allowBlank,validation:"请输入"+me.fieldLabel,isValid:function(){if(!this.allowBlank){if(Ext.isEmpty($(this.getRawValue()).text())){return false}}return true},getRawValue:function(){if(me.editorFrameId){let iframe=document.getElementById(me.editorFrameId);if(iframe&&Ext.isFunction(iframe.contentWindow.getHtmlValue)){return iframe.contentWindow.getHtmlValue()}}return null},setValue:function(b){if(me.editorFrameId){let iframe=document.getElementById(me.editorFrameId);if(iframe&&Ext.isFunction(iframe.contentWindow.setHtmlValue)){iframe.contentWindow.setHtmlValue(b)}}}}];me.callParent(arguments)},showWindow:function(e,b,f){if(Ext.isEmpty(f)){f="编辑内容"}let me=this;me.autoShowEditor=false;me.oldValue=me.value;if(!me.editorWin){me.editorWin=Ext.create("Ext.window.Window",{title:f,iconCls:"extIcon extEdit",resizable:true,maximizable:true,height:400,width:600,layout:"fit",animateTarget:e,items:[me],modal:true,constrain:true,closeAction:"hide",listeners:{show:function(g){me.showEditor();server.showExtConfig(me.getCode(),"HtmlEditorCache",function(k,h){if(k){me.setValue(h)}})}},buttons:[{text:"暂存",iconCls:"extIcon extSave whiteColor",handler:function(){showWait("暂存中，请稍后……");server.saveExtConfig(me.getCode(),"HtmlEditorCache",me.getValue(),function(g,h){hideWait();if(g){toast("暂存成功！")}else{showAlert("系统提醒",h)}})}},{text:"重置",iconCls:"extIcon extReset",handler:function(){me.setValue(me.oldValue);server.deleteExtConfig(me.getCode(),"HtmlEditorCache")}},{text:"确定",iconCls:"extIcon extOk",handler:function(){let params={configKey:me.getCode(),configType:"HtmlEditorCache"};showWait("请稍后……");server.deleteExtConfig(me.getCode(),"HtmlEditorCache",function(g){hideWait();if(Ext.isFunction(me.editorWin.callBack)){me.editorWin.callBack(me)}me.editorWin.close()})}}]})}me.editorWin.setTitle(f);me.editorWin.callBack=b;me.editorWin.animateTarget=e;me.editorWin.show()}});Ext.define("Fast.ext.Link",{alias:["widget.link","widget.linkfield"],extend:"Ext.form.FieldContainer",entityId:null,entityText:null,entityCode:null,linkValue:null,editable:false,allowBlank:true,layout:"fit",submitValue:true,onBeforeSelect:null,onAfterSelect:null,isValid:function(){let me=this;let display=me.down("[name="+me.name+"Display]");display.allowBlank=me.allowBlank;return display.isValid()},getName:function(){return this.name},getValue:function(){let me=this;if(me.submitValue){let value=me.down("[name="+me.name+"]");return value.getValue()}return me.getText()},getText:function(){let me=this;let display=me.down("[name="+me.name+"Display]");return display.getValue()},setRecordValue:function(b){let me=this;if(b){if(Ext.isEmpty(me.getText())&&Ext.isEmpty(b.get(me.dataIndex))){return}if(b.store){b.store.holdUpdate=true}b.set(me.name,me.getValue());b.set(me.dataIndex,me.getText());if(b.store){b.store.holdUpdate=false;b.store.fireEvent("endupdate")}}},setValue:function(e,b){let me=this;let display=me.down("[name="+me.name+"Display]");display.setValue(e);if(b){me.setRawValue(b.get(me.name))}if(!e){me.setRawValue(-1)}},setHtml:function(b){this.setValue(b)},setRawValue:function(b){let me=this;let value=me.down("[name="+me.name+"]");if(value){value.setValue(b)}},getRawValue:function(){let me=this;let value=me.down("[name="+me.name+"]");if(value){return value.getValue()}return null},getMenu:function(){return this.up("menu")},selectData:function(){let me=this;if(Ext.isFunction(me.onBeforeSelect)){if(!me.onBeforeSelect(me)){return}}if(me.getMenu()){me.getMenu().holdShow=true}if(!me.entityCode){showAlert("系统提醒","请配置组件的entityCode属性值！",function(){if(me.getMenu()){me.getMenu().holdShow=false}});return}if(!me.entityId){showAlert("系统提醒","请配置组件的entityId属性值！",function(){if(me.getMenu()){me.getMenu().holdShow=false}});return}if(!me.entityText){showAlert("系统提醒","请配置组件的entityText属性值！",function(){if(me.getMenu()){me.getMenu().holdShow=false}});return}let entity=system.getEntity(me.entityCode);if(!entity){showAlert("系统提醒","未获取到 '"+me.entityCode+"' 实体类！",function(){if(me.getMenu()){me.getMenu().holdShow=false}});return}if(!entity.js){showAlert("系统提醒","未获取到 '"+me.entityCode+"' JS对象！",function(){if(me.getMenu()){me.getMenu().holdShow=false}});return}let entityObj=eval("new "+me.entityCode+"()");if(!Ext.isFunction(entityObj.showSelect)){showAlert("系统提醒","'"+me.entityCode+"' JS对象不存在函数showSelect(obj,callBack)！").then(function(){if(me.getMenu()){me.getMenu().holdShow=false}});return}let display=me.down("[name="+me.name+"Display]");display.blur();let selectTitle=entity.shortName;if(me.fieldLabel){selectTitle=me.fieldLabel}if(me.labelTitle){selectTitle=me.labelTitle}entityObj.showSelect(this,"选择"+selectTitle,me.linkValue.where).then(function(result){if(result){let data=result[0];me.setValue(data.get(me.entityText));me.setRawValue(data.get(me.entityId));me.record=data}if(me.getMenu()){me.getMenu().holdShow=false}if(Ext.isFunction(me.onAfterSelect)){me.onAfterSelect(me)}})},clearData:function(){let me=this;me.setValue(null);me.setRawValue(-1)},initComponent:function(){let me=this;if(!me.linkValue){me.linkValue={};me.linkValue[me.entityId]=-1;me.linkValue[me.entityText]=null}if(Ext.isEmpty(me.linkValue[me.entityId])){me.linkValue[me.entityId]=-1}if(Ext.isEmpty(me.name)){me.name="LinkField"+Ext.now()}let displayValue=me.linkValue[me.entityText];if(!displayValue){displayValue=me.value}me.items=[{xtype:"hiddenfield",name:me.name,value:me.linkValue[me.entityId]},{xtype:"textfield",name:me.name+"Display",editable:me.editable,value:displayValue,disabled:me.linkValue[me.entityText]!=null,hideLabel:true,fieldLabel:me.fieldLabel,allowBlank:me.allowBlank,emptyText:me.emptyText,listeners:{afterrender:function(b){if(!this.editable){b.inputEl.on("click",function(){me.selectData()})}}},triggers:{close:{cls:"text-clear",handler:function(){me.clearData();if(Ext.isFunction(me.onClearValue)){me.onClearValue()}}},search:{cls:"text-search",handler:function(){me.selectData();this.inputEl.blur()}}}}];me.callParent(arguments)}});Ext.define("Fast.ext.Target",{alias:["widget.target","widget.targetfield"],extend:"Ext.form.FieldContainer",layout:"column",labelWidth:null,targetType:null,targetTypeReadOnly:false,targetTypeEnum:null,targetId:null,targetValue:null,targetFunction:"getTargetEntity",getValue:function(){let me=this;let targetIdCmp=me.down("[name="+me.targetId+"]");return targetIdCmp.getText()},setValue:function(e,b){let me=this;let targetIdCmp=me.down("[name="+me.targetId+"]");targetIdCmp.setValue(e);if(b){me.targetValue={};me.targetValue[me.targetType]=b.get(me.targetType);me.targetValue[me.targetId]=b.get(me.targetId);me.holdIdValue=me.getTargetTypeValue()!=b.get(me.targetType);me.setTargetIdValue(b.get(me.targetId));me.setTargetTypeValue(b.get(me.targetType))}},setHtml:function(b){this.setValue(b)},getSearchField:function(){},setRecordValue:function(b){let me=this;if(b){if(b.store){b.store.holdUpdate=true}if(me.targetId){b.set(me.targetId,me.getTargetIdValue())}if(me.targetType){b.set(me.targetType,me.getTargetTypeValue())}if(me.targetText&&me.targetText!=me.dataIndex){b.set(me.targetText,me.getValue())}b.set(me.dataIndex,me.getValue());if(b.store){b.store.holdUpdate=false;b.store.fireEvent("endupdate")}}},setTargetTypeValue:function(b){let me=this;let targetTypeCmp=me.down("[name="+me.targetType+"]");if(targetTypeCmp){targetTypeCmp.setValue(b)}},getTargetTypeValue:function(){let me=this;let targetTypeCmp=me.down("[name="+me.targetType+"]");if(targetTypeCmp){return targetTypeCmp.getValue()}return 0},setTargetIdValue:function(b){let me=this;let targetIdCmp=me.down("[name="+me.targetId+"]");if(targetIdCmp){targetIdCmp.setRawValue(b)}},getTargetIdValue:function(){let me=this;let targetIdCmp=me.down("[name="+me.targetId+"]");if(targetIdCmp){return targetIdCmp.getRawValue()}return -1},getTargetEntity:function(b){let me=this;let targetEntity=window[me.targetFunction](b,me.targetType);if(!targetEntity){showAlert("目标组件错误","未获取到TargetType为："+b+"的实体配置！");return null}return targetEntity},showWindow:function(e,b,f){if(Ext.isEmpty(f)){f="编辑目标数据"}let me=this;if(!me.editorWin){me.editorWin=Ext.create("Ext.window.Window",{title:f,height:220,width:400,minWidth:400,minHeight:220,layout:"fit",resizable:true,modal:true,constrain:true,closeAction:"hide",iconCls:"extIcon extLink",items:[me],buttons:[{text:"取消",iconCls:"extIcon extClose",handler:function(){me.editorWin.close()}},{text:"确定",iconCls:"extIcon extOk",handler:function(){me.editorWin.close();if(Ext.isFunction(me.editorWin.callBack)){me.editorWin.callBack(me)}}}]})}me.editorWin.setTitle(f);me.editorWin.callBack=b;me.editorWin.animateTarget=e;me.editorWin.show()},initComponent:function(){let me=this;me.fieldLabel="";if(!me.labelWidth){me.labelWidth=60}me.labelAlign="right";if(!me.emptyText){me.emptyText="请填写"}if(!me.margin){me.margin="5 5 5 5"}let linkValue={};if(!Ext.isFunction(window[me.targetFunction])){showAlert("目标组件错误","未检测到方法"+me.targetFunction+"!");me.callParent(arguments);return}if(!me.targetValue){me.targetValue={};me.targetValue[me.targetType]=0;me.targetValue[me.targetId]=-1}if(!me.targetValue[me.targetType]){me.targetValue[me.targetType]=0}if(!me.targetValue[me.targetId]){me.targetValue[me.targetId]=-1}if(me.targetEnum){me.targetTypeEnum=me.targetEnum}if(!me.targetTypeEnum){me.targetTypeEnum=me.targetType.replace(me.targetType[0],me.targetType[0].toUpperCase())+"Enum"}let targetTypeValue=me.targetValue[me.targetType];let targetEntity=me.getTargetEntity(targetTypeValue);if(!targetEntity){return}linkValue[targetEntity.entityId]=me.targetValue[me.targetId];linkValue[targetEntity.entityText]=me.targetValue.targetText;let targetTypeCmp={name:me.targetType,xtype:"enumcombo",fieldLabel:"目标类型",columnWidth:1,value:targetTypeValue,labelWidth:me.labelWidth,labelAlign:me.labelAlign,emptyText:"请选择目标类型",margin:me.margin,allowBlank:false,readOnly:me.targetTypeReadOnly,enumName:me.targetTypeEnum,listeners:{change:function(f,e,b){let newEntity=me.getTargetEntity(e);if(newEntity){let targetIdCmp=me.down("[name="+me.targetId+"]");targetIdCmp.entityCode=newEntity.entityCode;targetIdCmp.entityId=newEntity.entityId;targetIdCmp.entityText=newEntity.entityText;if(me.holdIdValue){me.holdIdValue=false;return}targetIdCmp.setValue(null)}}}};let targetIdCmp={name:me.targetId,xtype:"linkfield",fieldLabel:"目标数据",columnWidth:1,margin:me.margin,labelWidth:me.labelWidth,labelAlign:me.labelAlign,entityCode:targetEntity.entityCode,entityId:targetEntity.entityId,entityText:targetEntity.entityText,linkValue:linkValue};me.items=[targetTypeCmp,targetIdCmp];me.callParent(arguments)}});Ext.define("Fast.ext.Map",{alias:["widget.map","widget.mapfield"],extend:"Ext.form.FieldContainer",lngName:"lnt",latName:"lat",proName:null,cityName:null,areaName:null,editable:true,allowBlank:true,layout:"fit",submitValue:true,isValid:function(){let me=this;let value=me.down("[name="+me.name+"]");return value.isValid()},getName:function(){return this.name},getValue:function(){let me=this;let value=me.down("[name="+me.name+"]");return value.getValue()},setValue:function(e,b){let me=this;let value=me.down("[name="+me.name+"]");value.setValue(e);if(b){if(me.latName){me.setLatValue(b.get(me.latName))}if(me.lngName){me.setLngValue(b.get(me.lngName))}if(me.proName){me.setProValue(b.get(me.proName))}if(me.cityName){me.setCityValue(b.get(me.cityName))}if(me.areaName){me.setAreaValue(b.get(me.areaName))}}},setHtml:function(b){this.setValue(b)},setRecordValue:function(b){let me=this;if(b){if(b.store){b.store.holdUpdate=true}if(me.latName){b.set(me.latName,me.getLatValue())}if(me.lngName){b.set(me.lngName,me.getLngValue())}if(me.proName){b.set(me.proName,me.getProValue())}if(me.cityName){b.set(me.cityName,me.getCityValue())}if(me.areaName){b.set(me.areaName,me.getAreaValue())}b.set(me.name,me.getValue());if(b.store){b.store.holdUpdate=false;b.store.fireEvent("endupdate")}}},setLatValue:function(b){let me=this;let lat=me.down("[name="+me.latName+"]");if(lat){lat.setValue(b)}},setLngValue:function(b){let me=this;let lng=me.down("[name="+me.lngName+"]");if(lng){lng.setValue(b)}},setProValue:function(b){let me=this;let pro=me.down("[name="+me.proName+"]");if(pro){pro.setValue(b)}},setCityValue:function(b){let me=this;let city=me.down("[name="+me.cityName+"]");if(city){city.setValue(b)}},setAreaValue:function(b){let me=this;let area=me.down("[name="+me.areaName+"]");if(area){area.setValue(b)}},getLatValue:function(){let me=this;let lat=me.down("[name="+me.latName+"]");if(lat){return lat.getValue()}return 0},getLngValue:function(){let me=this;let lng=me.down("[name="+me.lngName+"]");if(lng){return lng.getValue()}return 0},getProValue:function(){let me=this;let pro=me.down("[name="+me.proName+"]");if(pro){return pro.getValue()}return null},getCityValue:function(){let me=this;let city=me.down("[name="+me.cityName+"]");if(city){return city.getValue()}return null},getAreaValue:function(){let me=this;let area=me.down("[name="+me.areaName+"]");if(area){return area.getValue()}return null},getMenu:function(){return this.up("menu")},selectData:function(){let me=this;if(me.getMenu()){me.getMenu().holdShow=true}let value=me.down("[name="+me.name+"]");value.blur();showMap(me,me.getLngValue(),me.getLatValue(),me.getValue()).then(function(b){if(b){me.setLatValue(b.lat);me.setLngValue(b.lng);me.setProValue(b.pro);me.setAreaValue(b.area);me.setCityValue(b.city);me.setValue(b.addr)}if(me.getMenu()){me.getMenu().holdShow=false}})},clearData:function(){let me=this;me.setValue(null);me.setLatValue(0);me.setLngValue(0)},initComponent:function(){let me=this;if(!me.name){me.name=me.dataIndex}if(Ext.isEmpty(me.name)){me.name="MapField"+Ext.now()}me.items=[{xtype:"hiddenfield",name:me.lngName,value:0},{xtype:"hiddenfield",name:me.latName,value:0},{xtype:"hiddenfield",name:me.proName},{xtype:"hiddenfield",name:me.cityName},{xtype:"hiddenfield",name:me.areaName},{xtype:"textfield",name:me.name,editable:me.editable,fieldLabel:me.fieldLabel,hideLabel:true,allowBlank:me.allowBlank,emptyText:me.emptyText,listeners:{afterrender:function(b){if(!this.editable){b.inputEl.on("click",function(){me.selectData()})}}},triggers:{close:{cls:"text-clear",handler:function(){me.clearData();if(Ext.isFunction(me.onClearValue)){me.onClearValue()}}},search:{cls:"text-search",handler:function(){me.selectData();this.inputEl.blur()}}}}];me.callParent(arguments)}});Ext.define("Fast.ext.PCA",{alias:["widget.pca","widget.pcafield"],extend:"Ext.form.field.Text",proName:null,cityName:null,areaName:null,onAfterSelect:null,selectType:0,setRecordValue:function(b){let me=this;if(b){if(b.store){b.store.holdUpdate=true}if(me.proName&&me.name!=me.proName&&me.province){b.set(me.proName,me.province.provinceName)}if(me.cityName&&me.name!=me.cityName&&me.city){b.set(me.cityName,me.city.cityName)}if(me.areaName&&me.name!=me.areaName&&me.area){b.set(me.areaName,me.area.areaName)}b.set(me.name,me.getValue());if(b.store){b.store.holdUpdate=false;b.store.fireEvent("endupdate")}}me.clearData()},getMenu:function(){return this.up("menu")},selectData:function(){let me=this;if(me.getMenu()){me.getMenu().holdShow=true}if(!Ext.isFunction(window.selectPCA)){showAlert("系统提醒","未检测到函数selectPCA！请导入FastChar-Location插件！",function(){if(me.getMenu()){me.getMenu().holdShow=false}});return}window.selectPCA(me,function(g,b,f,e){if(!toBool(g,false)){return}me.province=b;me.area=e;me.city=f;let formPanel=me.up("form");if(formPanel){if(b&&me.proName){formPanel.setFieldValue(me.proName,b.provinceName)}if(f&&me.cityName){formPanel.setFieldValue(me.cityName,f.cityName)}if(e&&me.areaName){formPanel.setFieldValue(me.areaName,e.areaName)}}let normalValue="";if(b){normalValue=b.provinceName;if(me.name==me.proName){me.setValue(b.provinceName);normalValue=null}}if(f){if(normalValue){if(me.selectType==0){normalValue+=" "+f.cityName}else{normalValue=f.cityName}}if(me.name==me.cityName){me.setValue(f.cityName);normalValue=null}}if(e){if(normalValue){if(me.selectType==0){normalValue+=" "+e.areaName}else{normalValue=e.areaName}}if(me.name==me.areaName){me.setValue(e.areaName);normalValue=null}}if(normalValue){me.setValue(normalValue)}if(me.getMenu()){me.getMenu().holdShow=false}if(Ext.isFunction(me.onAfterSelect)){me.onAfterSelect(me)}},me.level)},clearData:function(){let me=this;me.setValue(null);me.province=null;me.area=null;me.city=null},triggers:{close:{cls:"text-clear",handler:function(){this.clearData();if(Ext.isFunction(this.onClearValue)){this.onClearValue()}}},search:{cls:"text-search",handler:function(){this.selectData();this.inputEl.blur()}}},listeners:{afterrender:function(b){let me=this;if(!this.editable){b.inputEl.on("click",function(){me.selectData()})}}},initComponent:function(){this.emptyText="请选择省市区";this.editable=false;this.province=null;this.area=null;this.city=null;this.callParent(arguments)}});const renders={normal:function(e,b){return function(p,f,h,q,l,k,g,o){if(Ext.isEmpty(p)){return"<span style='color: #ccc;'>无</span>"}if(!e){e=""}if(!b){b=false}if(b){return e+p}if(o){return(p+e).replace(new RegExp("\n","g"),"<br/>").replace(new RegExp("\t","g"),"&nbsp;&nbsp;&nbsp;&nbsp;").replace(new RegExp(" ","g"),"&nbsp;")}return p+e}},money:function(){return function(b){if(Ext.isEmpty(b)){return"<span style='color: #ccc;'>无</span>"}return"￥"+b}},text:function(){return function(b){if(Ext.isEmpty(b)){return"<span style='color: #ccc;'>无</span>"}return"<span style='white-space: pre;'>"+b+"</span>"}},file:function(){return function(f,b,e){if(Ext.isEmpty(f)||f=="null"){return"<span style='color: #ccc;'>暂无文件</span>"}return'&nbsp;<a href="'+system.formatUrlVersion(f)+"\" target='_blank' >"+f.substring(f.lastIndexOf("/")+1)+"</a>&nbsp;"}},files:function(){return function(f,g,h,l,q,p,o,b){if(Ext.isEmpty(f)||f=="null"){return"<span style='color: #ccc;'>暂无文件</span>"}let data=[];if(!Ext.isEmpty(f)){try{data=Ext.decode(f)}catch(k){}}if(data.length==0){return"<span style='color: #ccc;'>暂无文件</span>"}let dataId=$.md5(f);let detailsList="";for(let i=0;i<data.length;i++){detailsList+=renders.file()(data[i])+"<br/>"}if(b){return detailsList}let html="<span id='"+dataId+"' style='color: #4279fa;'>共有"+data.length+"个文件！</span>";let detailsId=$.md5(html);window[detailsId]=detailsList;return html}},image:function(b,e){return function(g){let imageHeight="16px";let imageWidth="auto";if(Ext.isEmpty(g)||g=="null"){return"<img style='border:1px solid #cccccc;height:"+imageHeight+";' src='images/default_img.png'   />"}if(g.startWith("//")){g="http:"+g}try{if(b){imageHeight=b+"px"}if(e){imageWidth=e+"px"}}catch(f){}let dataId=$.md5(g);window[dataId]="<img src='"+g+"' style='border:1px solid #cccccc;width: 100px;' onerror=\"javascript:this.src='images/default_img.png';\" >";return"<img details-id='"+dataId+"' style='border:1px solid #cccccc;height:"+imageHeight+";width: "+imageWidth+";' onerror=\"javascript:this.src='images/default_img.png';\" onclick=\"showImage(this,'"+system.formatUrlVersion(g)+"')\"  src='"+system.formatUrlVersion(g)+"'/>"}},images:function(){return function(f,g,h,l,q,p,o,b){if(Ext.isEmpty(f)||f=="null"){return"<span style='color: #ccc;'>暂无图片</span>"}let data=f;if(Ext.isString(f)){if(!Ext.isEmpty(f)){try{data=Ext.decode(f)}catch(k){}}}if(data.length==0){return"<span style='color: #ccc;'>暂无图片</span>"}let dataId=$.md5(JSON.stringify(data));let detailsList="";for(let i=0;i<data.length;i++){detailsList+=renders.image(24)(data[i])+"&nbsp;&nbsp;"}if(b){return detailsList}let html="<span details-id='"+dataId+"' style='color: #4279fa;'>共有"+data.length+"张图片！</span>";window[dataId]=detailsList;return html}},html:function(){return function(l,b,f,o,h,g,e,k){if(Ext.isEmpty(l)||l=="null"){return"<span style='color: #ccc;'>无</span>"}let key=$.md5(l);MemoryCache[key]=l;let functionStr="showEditorHtml(this,'查看内容',MemoryCache['"+key+"'])";return'&nbsp;<a href="javascript:'+functionStr+';">查看内容</a>&nbsp;'}},link:function(e,f,b){return function(k,g,h){if(Ext.isEmpty(k)||k=="null"){return"<span style='color: #ccc;'>无</span>"}let keyValue=h.get(e);let functionStr="new "+f+"().showDetails(null, {'t."+b+"':'"+keyValue+"'})";return'&nbsp;<a href="javascript:'+functionStr+';" >'+k+"</a>&nbsp;"}},target:function(b,f,e){return function(k,g,h){if(Ext.isEmpty(k)||k=="null"){return"<span style='color: #ccc;'>无</span>"}if(!e){e="getTargetEntity"}if(!Ext.isFunction(window[e])){return k}let targetTypeValue=h.get(f);let targetIdValue=h.get(b);let targetEntity=window[e](targetTypeValue,f);if(targetEntity){let functionStr="new "+targetEntity.entityCode+"().showDetails(null, {'t."+targetEntity.entityId+"':'"+targetIdValue+"'})";return'&nbsp;<a href="javascript:'+functionStr+';" >'+k+"</a>&nbsp;"}return k}},map:function(b,e){return function(h,f,g){if(Ext.isEmpty(h)||h=="null"){return"<span style='color: #ccc;'>无</span>"}let lng=g.get(b);let lat=g.get(e);if(lng&&lat){let lnglat=lng+","+lat;let functionStr="showAddressInMap(null,'"+lnglat+"')";return'&nbsp;<a href="javascript:'+functionStr+';" >'+h+"</a>&nbsp;"}return h}},password:function(){return function(l,b,f,o,h,g,e,k){if(Ext.isEmpty(l)){return"<span style='color: #ccc;'>无</span>"}return"<span>******</span>"}},href:function(){return function(f,b,e){if(Ext.isEmpty(f)||f=="null"){return"<span style='color: #ccc;'>无</span>"}return"&nbsp;<a href='"+f+"' target='_blank'>"+f+"</a>&nbsp;"}},fileSize:function(){return function(f,b,e){if(Ext.isEmpty(f)||f=="null"){return"<span style='color: #ccc;'>无</span>"}if(f>=1024*1024){return(f/1024/1024).toFixed(2)+"M"}if(f>=1024){return(f/1024).toFixed(2)+"KB"}return f+"B"}}};renders["enum"]=function(b){return function(e){if(Ext.isEmpty(e)){return"<span style='color: #ccc;'>无</span>"}let enumText=getEnumText(b,e);if(Ext.isEmpty(enumText)){return"<span style='color: #ccc;'>无</span>"}return enumText}};const server={logout:function(){showWait("正在退出登录中……");$.post("manager/logout",function(){location.reload()})},updateEntity:function(e,b){if(isPower()){b(false,"当前正在进行界面权限配置，不可修改数据！");return}$.post("entity/update",e,function(f){if(f.code==203){return}if(Ext.isFunction(b)){if(f.success){b(true)}else{b(false,f.message)}}})},deleteAttach:function(e,b){if(isPower()){b(false,"当前正在进行界面权限配置，不可删除数据！");return}$.post("deleteAttach",e,function(f){if(f.code==203){return}if(Ext.isFunction(b)){if(f.success){b(true)}else{b(false,f.message)}}})},deleteEntity:function(e,b){if(isPower()){b(false,"当前正在进行界面权限配置，不可删除数据！");return}$.post("entity/delete",e,function(f){if(f.code==203){return}if(Ext.isFunction(b)){b(f.success,f.message)}})},copyEntity:function(e,b){if(isPower()){b(false,"当前正在进行界面权限配置，不可复制数据！");return}$.post("entity/copy",e,function(f){if(f.code==203){return}if(Ext.isFunction(b)){if(f.success){b(true)}else{b(false,f.message)}}})},showExtConfig:function(b,e,f){if(isPower()){f(false);return}let params={configKey:b,configType:e};$.post("ext/config/showExtConfig",params,function(g){if(Ext.isFunction(f)){if(g.success){f(true,g.data.configValue)}else{f(false,null,g.message)}}})},saveExtConfig:function(e,f,h,g,b){if(isPower()){g(false);return}let params={configKey:e,configType:f,configValue:h};if(!Ext.isEmpty(b)){params=mergeJson(params,b)}$.post("ext/config/saveExtConfig",params,function(k){if(Ext.isFunction(g)){if(k.success){g(true)}else{g(false,k.message)}}})},deleteExtConfig:function(b,e,f){if(isPower()){f(false);return}let params={configKey:b,configType:e};$.post("ext/config/deleteExtConfig",params,function(g){if(Ext.isFunction(f)){if(g.success){f(true)}else{f(false,g.message)}}})},exportExcel:function(e,b){if(isPower()){b(false,"当前正在进行界面权限配置，不可导出数据！");return}$.post("entity/export",e,function(f){if(f.code==203){return}if(Ext.isFunction(b)){if(f.success){b(true,f.data)}else{b(false,null,f.message)}}})},excelModule:function(e,b){if(isPower()){b(false,"当前正在进行界面权限配置，不可生成模板！");return}$.post("entity/module",e,function(f){if(f.code==203){return}if(Ext.isFunction(b)){if(f.success){b(true,f.data)}else{b(false,null,f.message)}}})},showColumns:function(e,b){$.post("ext/config/showEntityColumn?entityCode="+e,function(f){if(Ext.isFunction(b)){if(f.success){b(true,f.data.configValue)}else{b(false,null,f.message)}}})},getIcon:function(e,b){let iconPath="icons/"+e;if(Ext.isEmpty(b)){return iconPath}if(b.startWith("#")){b=b.substring(1)}return"icon?path="+iconPath+"&color="+b},showSystemConfig:function(b){$.post("ext/config/showSystemConfig",function(e){if(Ext.isFunction(b)){if(e.success){b(true,e.data)}else{b(false,null,e.message)}}})},deleteSystemConfig:function(b){$.post("ext/config/deleteSystemConfig",function(e){if(Ext.isFunction(b)){b(e.success,e.message)}})}};function commitStoreUpdate(b){return new Ext.Promise(function(f,e){if(!b){return}if(!b.entity){return}if(b.commiting){return}let records=b.getUpdatedRecords();let phantoms=b.getNewRecords();records=records.concat(phantoms);if(records.length==0){return}b.commiting=true;let params={entityCode:b.entity.entityCode};if(b.entity.menu){params.menu=b.entity.menu.text}for(let i=0;i<records.length;i++){let record=records[i];for(let j=0;j<b.entity.idProperty.length;j++){let idName=b.entity.idProperty[j];params["data["+i+"]."+idName]=record.get(idName)}for(let key in record.modified){params["data["+i+"]."+key]=record.get(key)}}server.updateEntity(params,function(h,g){b.commiting=false;f(h);if(h){toast("修改成功!");b.commitChanges()}else{Ext.Msg.alert("系统提醒",g)}})})}function commitStoreDelete(b,e){return new Ext.Promise(function(g,f){if(!b.entity){return}let params={entityCode:b.entity.entityCode};if(b.entity.menu){params.menu=b.entity.menu.text}for(let i=0;i<e.length;i++){let record=e[i];for(let j=0;j<b.entity.idProperty.length;j++){let idName=b.entity.idProperty[j];params["data["+i+"]."+idName]=record.get(idName)}}server.deleteEntity(params,function(k,h){g(k);if(k){toast("删除成功!");let reloadPage=b.currentPage;if(b.count()-e.length<=0){reloadPage=reloadPage-1}b.loadPage(Math.max(reloadPage,1))}else{Ext.Msg.alert("系统提醒",h)}})})}function commitStoreCopy(b,e){return new Ext.Promise(function(g,f){if(!b.entity){return}let params={entityCode:b.entity.entityCode};if(b.entity.menu){params.menu=b.entity.menu.text}for(let i=0;i<e.length;i++){let record=e[i];for(let j=0;j<b.entity.idProperty.length;j++){let idName=b.entity.idProperty[j];params["data["+i+"]."+idName]=record.get(idName)}}server.copyEntity(params,function(k,h){g(k);if(k){toast("复制成功!");let reloadPage=b.currentPage;if(b.count()-e.length<=0){reloadPage=reloadPage-1}b.loadPage(Math.max(reloadPage,1))}else{Ext.Msg.alert("系统提醒",h)}})})}function isModified(b){for(let name in b.data){try{if(b.isModified(name)){return true}}catch(f){}}return false}function getEntityDataStore(entity,where,tree){if(Ext.isEmpty(entity)){showAlert("系统提醒","参数entity不可为空！");return}let config={fields:[],pageSize:20,where:where,entity:entity,remoteSort:toBool(entity.remoteSort,true),proxy:{type:"ajax",url:"entity/list",actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(obj,request,operation,eOpts){let data=eval("("+request.responseText+")");if(!data.success){Ext.Msg.alert("数据获取失败",data.message)}}},reader:{type:"json",root:"list",totalProperty:"totalRow"}},listeners:{endupdate:function(eOpts){},beforeload:function(store,options){try{let params=store.proxy.extraParams;let newParams={entityCode:store.entity.entityCode,limit:store.pageSize};if(store.where){for(let w in store.where){newParams["where['"+w+"']"]=store.where[w]}}if(tree){if(Ext.isEmpty(tree.parentIdValue)){tree.parentIdValue=-1}newParams.page=-1;let parentValue=options.node.data[tree.idName];if(Ext.isEmpty(parentValue)){parentValue=tree.parentIdValue}if(store.grid){if(!hasSearchColumn(store.grid)){newParams["where['"+tree.parentIdName+"']"]=parentValue}else{newParams["where['"+tree.parentIdName+"']"]=null}}else{newParams["where['"+tree.parentIdName+"']"]=parentValue}}if(store.grid){if(store.grid.getSelection().length>0){store.grid.getSelectionModel().deselectAll()}else{store.grid.fireEvent("selectionchange",store.grid)}if(store.grid.where){for(let w in store.grid.where){newParams["where['"+w+"']"]=store.grid.where[w]}}store.getSorters().each(function(item){newParams["indexSort['"+item.getProperty()+"']"]=getColumn(store.grid,item.getProperty()).getIndex()})}store.getProxy().setExtraParams(mergeJson(params,newParams));return true}catch(e){showException(e,"store:beforeload")}}}};if(tree){return Ext.create("Ext.data.TreeStore",config)}config.autoLoad=false;return Ext.create("Ext.data.Store",config)}function getEnumDataStore(f,e,b){let cacheKey=$.md5(f);if(!MemoryCache.hasOwnProperty(cacheKey)){Ext.Ajax.request({url:"showEnums?enumName="+f,async:false,success:function(g,h){try{let result=Ext.decode(g.responseText);if(result.success){MemoryCache[cacheKey]=result.data}else{Ext.Msg.alert("枚举获取失败",result.message)}}catch(k){showException(k,"获取枚举数据源！[getEnumDataStore]")}}})}let dataArray=Ext.clone(MemoryCache[cacheKey]);if(e){dataArray=Ext.Array.insert(dataArray,0,e)}if(b){dataArray=Ext.Array.push(dataArray,b)}return Ext.create("Ext.data.Store",{autoLoad:false,enumName:f,data:dataArray})}function getEnumText(e,b){let findRecord=getEnumDataStore(e).findRecord("id",b,0,false,false,true);if(findRecord){return findRecord.get("text")}return null}function getPageDataStore(e,b){if(e==null||e.length==0){e=100}if(b==null||b.length==0){b=10}let dataArray=[];for(let i=0;i<e/10;i++){let text=((i+1)*b)+"条";let id=((i+1)*b);dataArray.push({text:text,id:id})}return Ext.create("Ext.data.Store",{id:"pageSizeDataStore",fields:["id","text"],data:dataArray})}function getCompareDataStore(){return Ext.create("Ext.data.Store",{data:[{id:0,text:"=",desc:"等于"},{id:1,text:"!=",desc:"不等于"},{id:2,text:"?",desc:"包含"},{id:3,text:"!?",desc:"不包含"},{id:4,text:">",desc:"大于"},{id:5,text:"<",desc:"小于"},{id:6,text:">=",desc:"大等于"},{id:7,text:"<=",desc:"小等于"}]})}function getGridColumnStore(e,b){let dataArray=[];let configColumns=e.getColumns();for(let i=0;i<configColumns.length;i++){let column=configColumns[i];if(Ext.isEmpty(column.dataIndex)){continue}if(toBool(b,false)){if(isFilesColumn(column)||isFileColumn(column)){continue}if(!toBool(column.search,true)){continue}if(toBool(column.encrypt,false)){continue}}dataArray.push({text:column.configText,id:column.dataIndex,index:i})}return Ext.create("Ext.data.Store",{fields:["id","text","index"],data:dataArray})}function getYesOrNoDataStore(){return Ext.create("Ext.data.Store",{id:"yesOrNoDataStore",fields:["id","text"],data:[{text:"是",id:1},{text:"否",id:0}]})}function getThemeDataStore(){return Ext.create("Ext.data.Store",{id:"themeDataStore",fields:["id","text"],data:[{text:"圆润立体",id:"extjs/theme/fast-theme-wrap"},{text:"清爽扁平",id:"extjs/theme/fast-theme-flat"}]})}Ext.override(Ext.Window,{initComponent:Ext.Function.createSequence(Ext.Window.prototype.initComponent,function(){try{if(!eval(getExt("window-anim").value)){this.animateTarget=null}let regStr=/([^/]*.svg)/;if(this.icon&&regStr.test(this.icon)){this.icon=server.getIcon(regStr.exec(this.icon)[1].trim(),"#ffffff")}}catch(e){console.error(e)}})});Ext.override(Ext.window.Window,{show:Ext.Function.createSequence(Ext.window.Window.prototype.show,function(){let me=this;me.toFront(true);me.focus()}),setIcon:Ext.Function.createSequence(Ext.window.Window.prototype.setIcon,function(b){let me=this;let regStr=/([^/]*.svg)/;if(b&&regStr.test(b)){me.icon=server.getIcon(regStr.exec(b)[1].trim(),"#ffffff")}})});function showWait(b){Ext.MessageBox.show({alwaysOnTop:true,modal:true,title:"系统提醒",msg:b,progressText:"请耐心等待，即将完成操作",progress:true,closable:false});let i=0;let max=100;let fn=function(){if(Ext.MessageBox.isHidden()){return}i=i+0.5;if(i==max+30){i=0}let val=i/max;Ext.MessageBox.updateProgress(val,"请耐心等待，即将完成操作");setTimeout(fn,5)};setTimeout(fn,5)}function hideWait(){if(Ext.MessageBox.isVisible()){Ext.MessageBox.hide()}}function toast(b){Ext.toast({html:b,closable:true,align:"t",slideInDuration:200,slideBackDuration:200,minWidth:120,slideBackAnimation:"easeOut",iconCls:"extIcon extInfo",title:"消息"})}function showHtml(e,f,b){let win=Ext.create("Ext.window.Window",{title:f,layout:"fit",height:500,width:600,resizable:false,maximizable:true,modal:true,maximized:false,iconCls:"extIcon extSee",draggable:true,scrollable:true,html:b,alwaysOnTop:true,toFrontOnShow:true});win.show()}function showLink(e,f,b){let win=Ext.create("Ext.window.Window",{title:f,layout:"fit",height:500,width:600,resizable:false,maximizable:true,modal:true,maximized:false,iconCls:"extIcon extSee",draggable:true,scrollable:false,alwaysOnTop:true,toFrontOnShow:true,listeners:{show:function(){let html="<iframe src='"+b+"'  width='100%' height='100%' frameborder='0'>";this.update(html)}}});win.show()}function showEditorHtml(e,f,b){let win=Ext.create("Ext.window.Window",{title:f,layout:"fit",height:500,width:600,resizable:false,maximizable:true,modal:true,maximized:false,iconCls:"extIcon extSee",draggable:true,scrollable:false,alwaysOnTop:true,toFrontOnShow:true,listeners:{show:function(){let url=system.formatUrlVersion("base/editor/show.html");window.showEditorDone=function(){showEditorFrame.window.showContent(b)};let html="<iframe name='showEditorFrame' src='"+url+"'  width='100%' height='100%' frameborder='0'>";this.update(html)}}});win.show()}function showText(e,b,g,f){let win=Ext.create("Ext.window.Window",{title:g,icon:b,maximizable:true,height:400,width:600,layout:"fit",animateTarget:e,items:[{xtype:"textarea",value:f}],modal:true,constrain:true,alwaysOnTop:true});win.show()}function showException(b,f){if(b==null){return}hideWait();console.error(b);let message=b;if(b instanceof Error){message=b.stack;message=message.replace(/\n/g,"<br/>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/ /g,"&nbsp;&nbsp;")}if(f!=null){f+="，来自"+f}else{f=""}let isDebug=getExt("debug").value;if(isDebug){let win=Ext.create("Ext.window.Window",{title:"系统异常"+f,height:180,width:270,layout:"fit",resizable:false,maximizable:false,fixed:true,modal:true,iconCls:"extIcon extError",html:"<div  style='padding:15px;background: #fff;' align='center'>系统发生异常，请及时告知系统管理员！</div>",buttons:[{text:"下次再说",flex:1,handler:function(){win.close()}},{text:"查看错误",flex:1,handler:function(){showHtml(this,"异常信息",message)}}]});win.show()}}function showAlert(f,b,e){Ext.Msg.alert(f,b,e)}function showImage(g,b,f,e){if(Ext.isEmpty(e)){e=false}let jsonData=[{url:b}];let selectIndex=-1;if(Ext.getStore("ImageViewStore")!=null){let hasValue=false;let currStore=Ext.getStore("ImageViewStore");currStore.each(function(h,k){if(h.get("url").split("?")[0]==b.split("?")[0]){hasValue=true;Ext.getCmp("ImageViewGrid").getSelectionModel().select(k);return false}});if(!hasValue){currStore.add(jsonData);if(selectIndex==-1){selectIndex=currStore.count()-1}Ext.getCmp("ImageViewGrid").getSelectionModel().select(selectIndex)}return}else{if(selectIndex==-1){selectIndex=0}}let imageStore=Ext.create("Ext.data.Store",{fields:["url"],autoLoad:false,id:"ImageViewStore",data:jsonData});let dataGridImages=Ext.create("Ext.grid.Panel",{store:imageStore,region:"west",hideHeaders:true,id:"ImageViewGrid",width:125,disabled:true,border:1,scrollable:"y",columns:[{header:"文件",dataIndex:"url",flex:1,align:"center",renderer:function(h){if(Ext.isEmpty(h)){return"<span style='color: #ccc;'>无</span>"}return"<img width='30px' onerror=\"javascript:this.src='images/default_img.png';\" src='"+h+"'/>"}}],tbar:[{xtype:"button",border:1,text:"打包下载",iconCls:"extIcon extDownload",handler:function(h){let params={};imageStore.each(function(k,l){params["path"+l]=k.get("url")});buildForm("zipFile",params).submit()}}],listeners:{selectionchange:function(){try{let time=0;if(this.getStore().getCount()>1){this.setHidden(false);time=120}else{this.setHidden(true)}let data=this.getSelectionModel().getSelection();setTimeout(function(){imgViewFrame.window.showImage(system.formatUrl(data[0].get("url")),system.http)},time)}catch(h){showException(h,"showImage")}}}});window.imageViewerLoadDone=function(){Ext.getCmp("ImageViewGrid").setDisabled(false);try{let index=Ext.getStore("ImageViewStore").count()-1;Ext.getCmp("ImageViewGrid").getSelectionModel().select(index)}catch(h){showException(h,"showImage")}};window.imageViewerSize=function(k,h){Ext.getCmp("ImageViewWindow").setTitle("查看图片 "+k+"x"+h)};let imagePanel=Ext.create("Ext.panel.Panel",{layout:"fit",region:"center",border:0,height:"auto",html:'<div style="background: #000000;width: 100%;height: 100%;"></div>',listeners:{afterrender:function(k,h){if(imageStore.getCount()<=1){dataGridImages.setHidden(true)}else{dataGridImages.setHidden(false)}k.update("<iframe style='background: #000000;width: 100%;height: 100%;' name='imgViewFrame'  src='"+system.formatUrlVersion("base/image-view/index.html")+"' width='100%' height='100%' frameborder='0' scrolling='no' />")}},bbar:{xtype:"toolbar",dock:"bottom",layout:{type:"hbox",align:"middle",pack:"center"},items:[{xtype:"button",iconCls:"extIcon extZoomOut",handler:function(){imgViewFrame.window.zoomOut()}},{xtype:"button",iconCls:"extIcon extZoomIn",handler:function(){imgViewFrame.window.zoomIn()}},{xtype:"button",iconCls:"extIcon extOneOne",handler:function(){imgViewFrame.window.oneOne()}},{xtype:"button",iconCls:"extIcon extAround",handler:function(){imgViewFrame.window.rotate()}},{xtype:"button",iconCls:"extIcon extLeftRight",handler:function(){imgViewFrame.window.flipA()}},{xtype:"button",iconCls:"extIcon extTopBottom",handler:function(){imgViewFrame.window.flipB()}},{xtype:"button",iconCls:"extIcon extDownload2",handler:function(){let data=dataGridImages.getSelectionModel().getSelection();download(data[0].get("url"))}}]}});let newWin=Ext.create("Ext.window.Window",{title:"查看图片",height:500,width:600,id:"ImageViewWindow",layout:"border",iconCls:"extIcon extImage",resizable:true,alwaysOnTop:true,maximizable:true,modal:e,constrain:true,animateTarget:g,items:[dataGridImages,imagePanel],listeners:{close:function(h){imageStore.destroy();if(Ext.isFunction(f)){f()}}}});newWin.show()};