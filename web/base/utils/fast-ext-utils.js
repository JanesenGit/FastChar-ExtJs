var MemoryCache={},progressLine;String.prototype.endWith=function(a){if(a==null||a==""||this.length==0||a.length>this.length){return false}return this.substring(this.length-a.length)==a};String.prototype.startWith=function(a){if(a==null||a==""||this.length==0||a.length>this.length){return false}return this.substr(0,a.length)==a};String.prototype.firstUpperCase=function(){return this.replace(/^\S/,function(a){return a.toUpperCase()})};Array.prototype.exists=function(b){for(var a=0;a<this.length;a++){if(this[a]==b){return true}}return false};function toBool(b,a){if(Ext.isEmpty(a)){a=false}if(Ext.isEmpty(b)){return a}return Boolean(b)}function toColor(b,a){if(Ext.isEmpty(a)){a="#FFFFFF"}if(Ext.isEmpty(b)){return a}if(b.toString().startWith("#")){return b.toString()}return"#"+b}function jsonToObject(a){try{return Ext.decode(a)}catch(b){}return null}function objectToJson(b){try{return Ext.encode(b)}catch(a){}return null}function copyToBoard(a){var b=document.createElement("input");b.value=a;document.body.appendChild(b);b.select();document.execCommand("Copy");b.style.display="none";$(b).remove()}function copy(c){var a={};if(c instanceof Array){a=c.concat()}else{if(c instanceof Function){a=c}else{for(var b in c){a[b]=c[b]}}}return a}function isSystem(){try{if(system&&system.init){return true}}catch(a){}return false}function checkBrowserVersion(){if(Ext.isIE&&Ext.ieVersion<11){var a=Ext.create("Ext.window.Window",{title:"系统提醒",width:250,height:100,layout:"fit",icon:"icons/icon_error.svg",resizable:false,closable:false,html:"<div style='background:#eeeeee; padding:10px;'>您当前的IE版本太低，至少在11.0以上的IE才能使用本系统！</div>",modal:true});a.show();return false}return true}function getBodyContainer(){var a=Ext.getCmp("bodyContainer");if(a==null){Ext.getDoc().on("contextmenu",function(b){b.stopEvent()});Ext.tip.QuickTipManager.init();Ext.QuickTips.init();a=Ext.create("Ext.container.Viewport",{id:"bodyContainer",layout:"fit",border:0,renderTo:Ext.getBody()})}return a}var setCache=function(a,b){try{localStorage.setItem(a,JSON.stringify(b))}catch(c){}};var getCache=function(a){try{return JSON.parse(localStorage.getItem(a))}catch(b){}return null};var removeCache=function(a){localStorage.removeItem(a)};function getProgressLine(a){if(Ext.isEmpty(a)){a="#f8c633"}if(progressLine==null){progressLine=new ProgressBar.Line("#progress",{color:a,duration:1000,easing:"easeInOut",from:{color:"#9c58b6"},to:{color:a},step:function(c,b,d){b.path.setAttribute("stroke",c.color)}})}return progressLine}function shakeComment(h){try{var c,f=0,i=3,a=function(){clearInterval(c);h.setX(d);h.setY(b)};var d=h.getX();var b=h.getY();c=setInterval(function(){try{var k=f/180*Math.PI,j=Math.sin(k)*i,m=Math.cos(k)*i;h.setX(d+j);h.setY(b+m);if((f+=90)>1080){a()}}catch(l){a()}},30)}catch(g){}}function mergeJson(c,b){var d={};if(!Ext.isEmpty(c)){for(var a in c){d[a]=c[a]}}if(!Ext.isEmpty(b)){for(var a in b){d[a]=b[a]}}return d}function buildForm(b,c){var d=$("<form></form>");d.attr("action",b);d.attr("method","post");for(var e in c){var a=$("<input type='text' name='"+e+"' />");a.attr("value",c[e]);d.append(a)}$(document.body).append(d);return d}function loadFunction(functionStr){if(functionStr.toString().trim().startsWith("function")){var functionKey="do"+$.md5(functionStr);if(Ext.isEmpty(MemoryCache[functionKey])){var myScript=document.createElement("script");myScript.type="text/javascript";var code="var "+functionKey+"="+functionStr;try{myScript.appendChild(document.createTextNode(code))}catch(ex){myScript.text=code}document.body.appendChild(myScript);MemoryCache[functionKey]=true}return eval(functionKey)}return null}function download(d){var c=d.substring(d.lastIndexOf("/"));var b=document.createElement("a");var e=new MouseEvent("click");b.download=c;b.href=d;b.dispatchEvent(e)}function runCallBack(a,d){if(!Ext.isFunction(a)){return}if(a.callBacked){return}var c=[];for(var b=1;b<arguments.length;b++){c[b-1]=arguments[b]}a.apply(this,c);a.callBacked=true}function setRecordValue(a,b,d){d.dataIndex=b;if(Ext.isFunction(d.setRecordValue)){d.setRecordValue(a)}else{var c=d.getValue();if(Ext.isDate(d.getValue())){a.set(b,Ext.Date.format(c,d.format))}else{a.set(b,c)}}}Ext.override(Ext.button.Button,{afterRender:Ext.Function.createSequence(Ext.button.Button.prototype.afterRender,function(){var b=this;if(b.tipText){b.tip=new Ext.ToolTip({target:b.el,trackMouse:true,renderTo:Ext.getBody(),html:b.tipText})}if(!Ext.isEmpty(b.text)){var a=b.up("grid,treepanel");if(a){addGridContextMenu(a,buttonToMenuItem(b));if(b.checkSelect){if(!a.selectButtons){a.selectButtons=[]}b.setDisabled(true);a.selectButtons.push(b)}if(b.checkUpdate){if(!a.updateButtons){a.updateButtons=[]}b.setDisabled(true);a.updateButtons.push(b)}}}})});function buttonToMenuItem(a){var c={icon:a.icon,iconCls:a.iconCls,text:a.text,subtext:a.subtext,handler:a.handler};if(a.getMenu()!=null){var b=[];a.getMenu().items.each(function(e,d){b.push(buttonToMenuItem(e))});c.menu=b}return c}Ext.override(Ext.Component,{initComponent:Ext.Function.createSequence(Ext.Component.prototype.initComponent,function(){var d=this;try{if((d.getXType()=="window"||d.getXType()=="panel")&&(!Ext.isEmpty(d.getTitle())||!Ext.isEmpty(d.subtitle))&&(d.resizable||d.split)){var b=$.md5(d.getTitle()+d.subtitle+$("title").text());try{b=$.md5(b+d.width+d.height)}catch(f){}var c=getCache(b+"Width");var a=getCache(b+"Height");if(c!=null){d.setWidth(c)}if(a!=null){d.setHeight(a)}d.on("resize",function(i,h,e,g){if(h!=Ext.getBody().getWidth()){setCache(b+"Width",h)}if(e!=Ext.getBody().getHeight()){setCache(b+"Height",e)}})}}catch(f){console.error(f)}})});Ext.override(Ext.Component,{show:function(){if(isSystem()){if(!this.sessionWin){if(system.sessionOutAlert){return}}}var a=this,b=a.rendered;if(a.hierarchicallyHidden||(a.floating&&!b&&a.isHierarchicallyHidden())){if(!b){a.initHierarchyEvents()}if(arguments.length>1){arguments[0]=null;a.pendingShow=arguments}else{a.pendingShow=true}}else{if(b&&a.isVisible()){if(a.floating){a.onFloatShow()}}else{if(a.fireEvent("beforeshow",a)!==false){a.hidden=false;delete this.getInherited().hidden;Ext.suspendLayouts();if(!b&&(a.autoRender||a.floating)){a.doAutoRender();b=a.rendered}if(b){a.beforeShow();Ext.resumeLayouts();a.onShow.apply(a,arguments);a.afterShow.apply(a,arguments)}else{Ext.resumeLayouts(true)}}else{a.onShowVeto()}}}return a}});Ext.override(Ext.grid.CellContext,{setRow:function(c){var a=this,b=a.view.dataSource;if(c){if(typeof c==="number"){a.rowIdx=Math.max(Math.min(c,b.getCount()-1),0);a.record=b.getAt(c)}else{if(c.isModel){a.record=c;a.rowIdx=b.indexOf(c)}else{if(c.tagName||c.isElement){a.record=a.view.getRecord(c);a.rowIdx=b.indexOf(a.record)}}}}return a}});Ext.override(Ext.layout.container.Accordion,{nextCmp:function(b){var a=b.next();if(a&&a.isHidden()){return this.nextCmp(a)}return a},prevCmp:function(b){var a=b.prev();if(a&&a.isHidden()){return this.prevCmp(a)}return a},onBeforeComponentCollapse:function(d){var e=this,a=e.owner,f,c,b;if(e.owner.items.getCount()===1){return false}if(!e.processing){e.processing=true;b=a.deferLayouts;a.deferLayouts=true;f=e.nextCmp(d)||e.prevCmp(d);if(f.isHidden()){a.deferLayouts=b;e.processing=false;e.onBeforeComponentCollapse(f);return}if(e.multi){c=e.getExpanded();if(c.length===1){f.expand()}}else{if(f){f.expand()}}a.deferLayouts=b;e.processing=false}}});Ext.override(Ext.dom.Element,{syncContent:function(b){b=Ext.getDom(b);var c=b.childNodes,q=c.length,o=this.dom,p=o.childNodes,l=p.length,j,n,f,h,d,a,k,g=o._extData;if(Ext.isIE9m&&o.mergeAttributes){o.mergeAttributes(b,true);o.src=b.src}else{d=b.attributes;a=d.length;for(j=0;j<a;j++){k=d[j].name;if(k!=="id"){o.setAttribute(k,d[j].value)}}}if(g){g.isSynchronized=false}if(q!==l){o.innerHTML=b.innerHTML;return}for(j=0;j<q;j++){f=c[j];n=p[j];h=f.nodeType;if(h!==n.nodeType||(h===1&&f.tagName!==n.tagName)){o.innerHTML=b.innerHTML;return}if(h===3){n.data=f.data}else{try{if(f.id&&n.id!==f.id){n.id=f.id}n.style.cssText=f.style.cssText;n.className=f.className;Ext.fly(n,"_syncContent").syncContent(f)}catch(m){}}}}});var files={validate:function(b,a){if(Ext.isEmpty(b)){showAlert("系统提醒","参数"+a+"必传！");return false}if(!Ext.isArray(b)){showAlert("系统提醒","参数"+a+"必需Array格式！");return false}if(b==0){showAlert("系统提醒","参数"+a+"集合不可为空！");return false}return true},file:function(){return{reg:/\.*$/i,tipMsg:"文件",type:"file",renderer:renders.file()}},image:function(b,a){if(Ext.isEmpty(b)){b=-1}if(Ext.isEmpty(a)){a=-1}return{width:b,height:a,reg:/\.(jpg|png|gif|jpeg)$/i,tipMsg:"图片",type:"images",renderer:renders.image(24)}},mp4:function(){return{reg:/\.(mp4)$/i,tipMsg:"mp4",type:"videos",renderer:renders.file()}},word:function(){return{reg:/\.(doc)$/i,tipMsg:"word文档",type:"words",renderer:renders.file()}},excel:function(){return{reg:/\.(xls|xlsx)$/i,tipMsg:"excel文档",type:"excels",renderer:renders.file()}},text:function(){return{reg:/\.(txt)$/i,tipMsg:"txt文档",type:"excels",renderer:renders.file()}}};function uploadFile(b,a){return new Ext.Promise(function(i,k){var h="上传文件",f="files",c=-1,j=-1;if(!files.validate(a,"fileModules")){return}if(a.length==1){h="上传"+a[0].tipMsg;f=a[0].type;c=a[0].width;j=a[0].height}var e=Ext.create("Ext.form.FormPanel",{url:"upload",method:"POST",margin:"5",fileUpload:true,width:400,callBacked:false,border:0,layout:"column",items:[{xtype:"filefield",fieldLabel:h,labelWidth:60,labelAlign:"right",buttonText:"选择文件",allowBlank:false,name:"file",columnWidth:1,listeners:{change:function(q,p,m){if(p!=null&&p.length!=0){var o="";for(var l=0;l<a.length;l++){var n=a[l];if(n.reg.test(p)){e.doSubmit();return}o=o+"或"+n.tipMsg}e.form.reset();Ext.Msg.alert("系统提醒","请上传有效的"+o.substring(1))}}}},{xtype:"hiddenfield",name:"type",value:f},{xtype:"hiddenfield",name:"file.width",value:c},{xtype:"hiddenfield",name:"file.height",value:j}],doSubmit:function(){var m=e.form;if(m.isValid()){var l=new Ext.LoadMask({msg:"正在上传附件中…",target:d});l.show();m.submit({success:function(n,o){toast("文件上传成功！");if(!i.called){i.called=true;i(o.result.data)}d.close()},failure:function(n,o){l.destroy();Ext.Msg.alert("系统提醒","上传失败！"+o.result.message)}})}},listeners:{render:function(l){new Ext.KeyMap(l.getEl(),[{key:13,fn:e.doSubmit,scope:Ext.getBody()}])}}});var g="btnSubmit"+new Date().getTime();var d=Ext.create("Ext.window.Window",{title:h,layout:"fit",resizable:false,scrollable:false,items:e,modal:true,iconCls:"extIcon extUpload",animateTarget:b,constrain:true,buttons:[{text:"重置",width:88,iconCls:"extIcon extReset",handler:function(){e.form.reset()}},{text:"上传",width:88,id:g,iconCls:"extIcon extOk",handler:function(){e.doSubmit()}}],listeners:{show:function(l,m){e.getForm().findField("file").fileInputEl.dom.click();Ext.getCmp(g).focus()},close:function(l,m){if(!i.called){i.called=true;i()}}}});d.show()})}function showFiles(f,a,n,m){if(!files.validate(n,"fileModules")){return}var h=[],k=renders.file(),l="文件管理";if(!Ext.isEmpty(m)){var b=m;if(Ext.isString(m)){b=Ext.JSON.decode(m)}for(var e=0;e<b.length;e++){h.push({url:b[e]})}}if(n.length==1){k=n[0].renderer;l=n[0].tipMsg+"管理"}var d=Ext.now();var g=Ext.create("Ext.data.Store",{autoLoad:true,data:h});var c=Ext.create("Ext.grid.Panel",{selModel:getGridSelModel(),store:g,columnLines:true,cellTip:true,columns:[{header:"文件",dataIndex:"url",flex:1,align:"center",renderer:k}],plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:2})],selType:"cellmodel",tbar:[{xtype:"button",border:1,text:"删除",id:"btnDeleteFile"+d,iconCls:"extIcon extDelete",disabled:true,handler:function(){var i=c.getSelectionModel().getSelection();if(i.length==0){toast("请您选择需要删除的文件！");return}else{Ext.Msg.confirm("系统提醒","您确定立即删除选中的附件吗？",function(o,p){if(o=="yes"){Ext.Array.each(i,function(q){g.remove(q);g.modify=true});c.getSelectionModel().deselectAll()}})}}},{xtype:"button",border:1,text:"上传",iconCls:"extIcon extUpload",handler:function(){uploadFile(this,n).then(function(i){if(i){g.add(i);g.modify=true}})}}],listeners:{selectionchange:function(){var i=this.getSelectionModel().getSelection();Ext.getCmp("btnDeleteFile"+d).setDisabled(!(i.length>0))}}});var j=Ext.create("Ext.window.Window",{title:l,height:300,width:400,minWidth:400,minHeight:300,layout:"fit",resizable:true,modal:true,constrain:true,iconCls:"extIcon extFolder",animateTarget:f,items:[c],listeners:{close:function(){if(g.modify){var i=[];g.each(function(o,p){i.push(o.get("url"))});if(a!=null){a(Ext.encode(i))}}}}});j.show()}function importExcel(a,b){return new Ext.Promise(function(f,e){var c=Ext.create("Ext.form.FormPanel",{url:"entity/importData",method:"POST",margin:"5",fileUpload:true,width:400,callBacked:false,border:0,layout:"column",items:[{xtype:"filefield",fieldLabel:"Excel文件",labelWidth:60,labelAlign:"right",buttonText:"选择文件",allowBlank:false,name:"file",columnWidth:1,listeners:{change:function(j,i,h){if(i!=null&&i.length!=0){if(!files.excel().reg.test(i)){c.form.reset();Ext.Msg.alert("系统提醒","请上传有效的Excel文档！")}}}}}],doSubmit:function(){var i=c.form;if(i.isValid()){var h=new Ext.LoadMask({msg:"正在导入中…",target:g});h.show();i.submit({params:b,success:function(j,k){if(!f.called){f.called=true;f(k.result)}g.close()},failure:function(j,k){h.destroy();Ext.Msg.alert("系统提醒","导入失败！"+k.result.message)}})}},listeners:{render:function(h){new Ext.KeyMap(h.getEl(),[{key:13,fn:c.doSubmit,scope:Ext.getBody()}])}}});var d="btnSubmit"+new Date().getTime();var g=Ext.create("Ext.window.Window",{title:"导入Excel数据",layout:"fit",resizable:false,scrollable:false,items:c,modal:true,iconCls:"extIcon extUpload",animateTarget:a,constrain:true,buttons:[{text:"重置",width:88,iconCls:"extIcon extReset",handler:function(){c.form.reset()}},{text:"上传",width:88,id:d,iconCls:"extIcon extOk",handler:function(){c.doSubmit()}}],listeners:{show:function(h,i){c.getForm().findField("file").fileInputEl.dom.click();Ext.getCmp(d).focus()},close:function(h,i){if(!f.called){f.called=true;f()}}}});g.show()})}Ext.form.FormPanel.prototype.setFieldValue=function(b,a){this.getForm().findField(b).setValue(a)};Ext.form.FormPanel.prototype.getFieldValue=function(a){return this.getForm().findField(a).getValue()};Ext.form.FormPanel.prototype.getField=function(a){return this.getForm().findField(a)};Ext.form.field.Base.prototype.blur=function(){this.inputEl.blur()};Ext.form.FormPanel.prototype.submitForm=function(a){var b=this;return new Ext.Promise(function(f,e){var c={submitEmptyText:false,waitMsg:"正在提交中……",params:{},success:function(g,h){Ext.Msg.alert("系统提醒",h.result.message,function(i){if(i=="ok"){f(h.result)}})},failure:function(g,h){Ext.Msg.alert("系统提醒",h.result.message);f(h.result)}};if(a){c.params.entityCode=a.entityCode;if(a.menu){c.params.menu=a.menu.text}}var d=b.getForm();if(d.isValid()){d.submit(c)}})};Ext.override(Ext.form.field.Date,{initComponent:Ext.Function.createSequence(Ext.form.field.Date.prototype.initComponent,function(){if(isSystem()){this.format=system.dateFormat}})});Ext.form.FormPanel.prototype.saveCache=function(a){if(Ext.isEmpty(a)){a=this.cacheKey}var b={};this.getForm().getFields().each(function(e,d){if(Ext.isDate(e.getValue())){b[e.getName()]=Ext.Date.format(e.getValue(),e.format)}else{b[e.getName()]=e.getValue()}});var c={configKey:a,configType:"FormPanelCache",configValue:Ext.encode(b)};showWait("暂存数据中……");$.post("ext/config/saveExtConfig",c,function(d){hideWait();if(d.success){toast("暂存成功！")}else{showAlert("系统提醒",d.message)}})};Ext.form.FormPanel.prototype.restoreCache=function(a){if(Ext.isEmpty(a)){a=this.cacheKey}var b=this;var c={configKey:a,configType:"FormPanelCache"};$.post("ext/config/showExtConfig",c,function(d){if(d.success){var e=Ext.decode(d.data.configValue);b.getForm().getFields().each(function(g,f){if(e.hasOwnProperty(g.getName())){g.setValue(e[g.getName()])}})}})};Ext.form.FormPanel.prototype.deleteCache=function(a){if(Ext.isEmpty(a)){a=this.cacheKey}var b={configKey:a,configType:"FormPanelCache"};$.post("ext/config/deleteExtConfig",b,function(c){})};Ext.override(Ext.form.Basic,{isValid:function(){try{var c=this,d;Ext.suspendLayouts();var h="";var b=0;var g="请正确填写数据！";d=c.getFields().filterBy(function(i){var e=!i.validate();if(e&&b==0){h=i.getFieldLabel();g=i.getErrors()[0];b++}return e});Ext.resumeLayouts(true);var a=d.length<1;if(!a){if(Ext.isEmpty(h)){toast("请将数据填写完整！")}else{toast("【"+h+"】错误："+g)}shakeComment(c.owner.ownerCt)}return a}catch(f){showException(f)}}});function isDateField(a){if(!a){return false}return a=="datefield"||a.xtype=="datefield"}function isNumberField(a){if(!a){return false}return a=="numberfield"||a.xtype=="numberfield"}function isTextField(a){if(!a){return false}return a=="textfield"||a.xtype=="textfield"}function isFileField(a){if(!a){return false}return a=="fastfile"||a.xtype=="fastfile"||a=="fastfilefield"||a.xtype=="fastfilefield"}function isFilesField(a){if(!a){return false}return a=="fastfiles"||a.xtype=="fastfiles"||a=="fastfilesfield"||a.xtype=="fastfilesfield"}function isEnumField(a){if(!a){return false}return a=="enumcombo"||a=="enumcombobox"||a.xtype=="enumcombo"||a.xtype=="enumcombobox"}function isContentField(a){if(!a){return false}return a=="contentfield"||a=="content"||a.xtype=="contentfield"||a.xtype=="content"}function isHtmlContentField(a){if(!a){return false}return a=="htmlcontentfield"||a=="htmlcontent"||a.xtype=="htmlcontentfield"||a.xtype=="htmlcontent"}function isLinkField(a){if(!a){return false}return a=="linkfield"||a=="link"||a.xtype=="linkfield"||a.xtype=="link"}function isTargetField(a){if(!a){return false}return a=="targetfield"||a=="target"||a.xtype=="targetfield"||a.xtype=="target"}Ext.override(Ext.grid.Panel,{initComponent:Ext.Function.createSequence(Ext.grid.Panel.prototype.initComponent,onGridInitComponent)});Ext.override(Ext.tree.Panel,{initComponent:Ext.Function.createSequence(Ext.tree.Panel.prototype.initComponent,onGridInitComponent)});Ext.override(Ext.grid.Panel,{afterRender:Ext.Function.createSequence(Ext.grid.Panel.prototype.afterRender,onGridAfterRender)});Ext.override(Ext.tree.Panel,{afterRender:Ext.Function.createSequence(Ext.tree.Panel.prototype.afterRender,onGridAfterRender)});function onGridInitComponent(){var a=this;if(a.entityList){configGridContextMenu(a);configDefaultToolBar(a);configGridTip(a);configGridListeners(a)}}function onGridAfterRender(){var a=this;if(a.entityList){configGridLayout(a).then(function(){a.setLoading(false);a.getStore().grid=a;if(!a.getStore().isLoaded()){a.getStore().loadPage(1)}})}}function addGridContextMenu(b,c,a){if(b.contextMenu&&c){if(!Ext.isFunction(b.contextMenu.getXType)){var d=new Ext.menu.Menu({items:[]});if(Ext.isArray(b.contextMenu)){d.add(b.contextMenu)}b.contextMenu=d}if(!Ext.isEmpty(a)){b.contextMenu.insert(a,c)}else{b.contextMenu.add(c)}}}function configGridContextMenu(b){var a=0;addGridContextMenu(b,{iconCls:"extIcon extCopy2",text:"复制数据",menu:[{text:"复制单元格",iconCls:"extIcon extCopy2",handler:function(){var c=b.contextMenu;copyToBoard($(c.cellTd).text());toast("复制成功！")}},{text:"复制整行",iconCls:"extIcon extCopy2",handler:function(){var d=b.contextMenu;var c="";$(d.tr).find("td").each(function(){c+=$(this).text()+"\t"});copyToBoard(c);toast("复制成功！")}},{text:"复制数据",iconCls:"extIcon extCopy2",handler:function(){var d=b.contextMenu;var c=d.record;var e=d.cellContext.column.dataIndex;copyToBoard(c.get(e));toast("复制成功！")}}]},a++);addGridContextMenu(b,{iconCls:"extIcon extEdit editColor",text:"编辑数据",onBeforeShow:function(){var c=this.ownerCt;if(Ext.isEmpty(c.cellContext.column.dataIndex)){this.hide();return}this.show();if(!c.cellContext.column.field){if(!c.cellContext.column.hasListener("dblclick")){this.hide()}}},handler:function(){var c=this.ownerCt;if(c.cellContext.column.field){b.findPlugin("cellediting").startEditByPosition(c.cellContext)}else{c.cellContext.column.fireEvent("dblclick",b,this,c.rowIndex)}}},a++);if(b.getStore().entity){addGridContextMenu(b,{iconCls:"extIcon extLink",text:"搜索链",onBeforeShow:function(){this.show();var h=this.ownerCt;if(!Ext.isObject(h.cellContext.column.searchLink)){this.hide()}else{var f=new Ext.menu.Menu({items:[]});var c=h.record;var k=h.cellContext.column.dataIndex;var e=h.cellContext.column.searchLink.columns;for(var d=0;d<e.length;d++){var g=e[d];var j={icon:g.parent.icon,text:g.parent.text+"【"+g.text+"】",column:g,value:c.get(k),handler:function(){var i={};i[this.column.dataIndex]=this.value;system.showTab(this.column.parent.method,$.md5(this.column.id+this.value),"搜索："+this.text,this.icon,true,false,i)}};f.add(j)}this.setMenu(f)}},menu:[]},a++);addGridContextMenu(b,{iconCls:"extIcon extSearch searchColor",text:"查找此数据",onBeforeShow:function(){var c=this.ownerCt;if(Ext.isEmpty(c.cellContext.column.dataIndex)){this.hide()}else{this.show()}},handler:function(){var d=this.ownerCt;var c=d.record;var e=d.cellContext.column.dataIndex;d.cellContext.column.searchValue(c.get(e))}},a++);addGridContextMenu(b,{iconCls:"extIcon extClear",text:"清空此数据",onBeforeShow:function(){var c=this.ownerCt;if(Ext.isEmpty(c.cellContext.column.dataIndex)){this.hide()}else{this.show()}},handler:function(){var c=this;Ext.Msg.confirm("系统提醒","您确定清空选中的单元格数据吗？",function(g,k){if(g=="yes"){var i=c.ownerCt;var d=i.record;var l=i.cellContext.column.dataIndex;if(Ext.isObject(i.cellContext.column.field)){if(!Ext.isEmpty(i.cellContext.column.field.name)){l=i.cellContext.column.field.name}}var h={entityCode:b.getStore().entity.entityCode};for(var f=0;f<b.getStore().entity.idProperty.length;f++){var e=b.getStore().entity.idProperty[f];h["data."+e]=d.get(e)}h["data."+l]="<null>";showWait("正在清空中……");server.updateEntity(h,function(m,j){hideWait();if(m){toast("清除成功！");b.getStore().reload()}else{Ext.Msg.alert("系统提醒",j)}})}})}},a++)}}function configDefaultToolBar(b){if(!b){return}var c=b.down("toolbar[dock='top']");if(c){var a={xtype:"button",text:"更多操作",iconCls:"extIcon extMore",menu:[{text:"导出Excel",iconCls:"extIcon extExcel",handler:function(){exportGrid(b)}},{text:"导入Excel",iconCls:"extIcon extExcel",menu:[{text:"下载模板",iconCls:"extIcon extExcelModule searchColor",handler:function(){showWait("正在生成中……");var d={entityCode:b.getStore().entity.entityCode};if(b.getStore().entity.menu){d.title=b.getStore().entity.menu.text}Ext.each(b.getColumns(),function(f,e){if(isFileColumn(f)||isFilesColumn(f)){return}if(!Ext.isEmpty(f.dataIndex)){d["column["+e+"].width"]=f.width;d["column["+e+"].text"]=f.configText;d["column["+e+"].enum"]=getEnumName(f);d["column["+e+"].type"]=getColumnFieldType(f);d["column["+e+"].dataIndex"]=f.dataIndex;if(isLinkColumn(f)){d["column["+e+"].dataIndex"]=f.field.name}}});server.excelModule(d,function(g,f,e){hideWait();if(g){toast("生成成功！");location.href="attach/"+f}else{Ext.Msg.alert("系统提醒","生成失败！"+e)}})}},{text:"导入数据",iconCls:"extIcon extExcelImport searchColor",handler:function(){var d={entityCode:b.getStore().entity.entityCode};importExcel(this,d).then(function(e){if(e){toast(e.message);b.getStore().loadPage(1)}})}}]},{iconCls:"extIcon extSet",text:"操作设置",handler:function(){setGrid(this,b)}}]};c.add("->");c.add(a)}}function configGridTip(c){if(!c){return}if(!c.view){return}var a=c.getView();c.tip=new Ext.ToolTip({target:a.el,delegate:".x-grid-cell-inner",trackMouse:true,renderTo:Ext.getBody(),listeners:{beforeshow:function b(f){if(c.operate&&!c.operate.hoverTip){return false}var g=f.triggerElement.innerHTML;if(Ext.isEmpty(g)||g=="&nbsp;"){return false}var e=g;var d=f.triggerElement.firstChild;if(d!=null&&d.nodeType==1){if(d.getAttribute("class")=="x-grid-row-checker"){return false}}f.update(e)}}})}function configGridListeners(a){if(!a){return}a.on("viewready",function(c,b){c.getHeaderContainer().sortOnClick=false});a.on("beforedestroy",function(b,c){saveGridColumn(a)});a.on("headertriggerclick",function(d,f,g,c,b){if(Ext.isEmpty(f.dataIndex)){return}d.sortOnClick=false;d.triggerColumn=f});a.on("headercontextmenu",function(d,f,g,c,b){if(Ext.isEmpty(f.dataIndex)){return}d.sortOnClick=false;d.onHeaderTriggerClick(f,g,f.triggerEl)});a.on("headermenucreate",function(c,e,d,b){a.columnHeadMenu=e;configGridHeadMenu(a)});a.on("headerclick",function(d,f,g,c,b){if(Ext.isEmpty(f.dataIndex)){return}d.sortOnClick=false;if(!showColumnSearchMenu(f)){d.onHeaderTriggerClick(f,g,f.triggerEl)}});a.on("sortchange",function(c,d,e,b){if(Ext.isEmpty(d.dataIndex)){return}d.sortDirection=e;refreshColumnStyle(d)});a.on("columnresize",function(c,e,d,b){e.width=d;c.sortOnClick=false});a.on("columnschanged",function(c,b){c.sortOnClick=false});a.on("cellcontextmenu",function(h,j,c,b,f,i,g,d){if(Ext.isEmpty(g.position.column.dataIndex)){return}if(Ext.isObject(a.contextMenu)){if(a.contextMenu.items.length>0){a.contextMenu.cellIndex=c;a.contextMenu.record=b;a.contextMenu.rowIndex=i;a.contextMenu.cellTd=j;a.contextMenu.tr=f;a.contextMenu.cellContext=g.position;h.getSelectionModel().select(b);h.fireEvent("selectionchange",h,b,d);fireMenuEvent(a.contextMenu,"onBeforeShow");a.contextMenu.showAt(g.getXY())}}});a.getStore().on("endupdate",function(c){try{if(a.getStore().holdUpdate){return true}var b=a.getStore().getUpdatedRecords();Ext.each(a.updateButtons,function(f,e){f.setDisabled(b.length==0)});if(a.operate&&a.operate.autoUpdate){commitStoreUpdate(a.getStore())}}catch(d){showException(d,"endupdate")}});a.on("beforeedit",function(f,e,d){if(!toBool(e.column.editable,true)){return false}if(e.column.hasListener("beforeedit")){if(!e.column.fireEvent("beforeedit",e)){return false}}var c=e.column.field;var b=Ext.get(e.cell);if(Ext.isFunction(c.setValue)&&!toBool(e.column.password,false)){if(Ext.isObject(e.value)||Ext.isArray(e.value)){c.setValue(JSON.stringify(e.value),e.record)}else{c.setValue(e.value,e.record)}}if(Ext.isFunction(c.showWindow)){c.showWindow(b,function(g){if(Ext.isEmpty(e.value)&&Ext.isEmpty(g.getValue())){return}setRecordValue(e.record,e.field,g)});return false}if(!e.column.editMenu){e.column.editMenu=Ext.create("Ext.menu.Menu",{modal:true,layout:"fit",showSeparator:false,items:[{xtype:"panel",layout:"fit",width:b.getWidth(),height:b.getHeight(),style:{background:"#ffffff",borderWidth:1,borderColor:"#ffffff",color:"#eeeee"},border:0,items:[c]}],listeners:{show:function(i,g){var h=i.items.get(0).items.get(0);h.focus();new Ext.KeyMap(i.getEl(),[{key:13,fn:function(){i.hide()},scope:i}])},beforehide:function(i,g){var h=i.items.get(0).items.get(0);if(!h.isValid()){shakeComment(i);return false}return true},hide:function(i,g){var h=i.items.get(0).items.get(0);if((Ext.isEmpty(i.context.value)||toBool(i.context.column.password,false))&&Ext.isEmpty(h.getValue())){return}setRecordValue(i.context.record,i.context.field,h)}}})}e.column.editMenu.setWidth(e.column.getWidth());e.column.editMenu.context=e;e.column.editMenu.showBy(b,"tl");return false});a.on("selectionchange",function(f,c,b){try{if(a.selectButtons){Ext.each(a.selectButtons,function(i,g){var e=f.getSelection().length;var h=i.checkSelect;if(h=="multiple"||h=="m"||h>1){i.setDisabled(!(e>0))}else{if(h=="radio"||h=="r"||h=="single"||h=="s"||h==1){i.setDisabled(!(e==1))}}})}}catch(d){showException(d,"按钮选中检测！[selectionchange]")}})}function configGridLayout(a){return new Ext.Promise(function(c,b){if(!a){return}a.setLoading("初始化配置中……");restoreGridOperate(a).then(function(){restoreGridColumn(a).then(function(){c(true)})})})}function configGridHeadMenu(a){if(!a.columnHeadMenu){return}if(!a.columnMenu){a.columnMenu={}}if(!a.columnMenu){return}var b=a.columnHeadMenu;b.on("beforeshow",function(d){if(isFilesColumn(d.activeHeader)||isFileColumn(d.activeHeader)||!hasColumnField(b.activeHeader)){d.activeHeader.batchUpdate=false;d.activeHeader.operation=false;d.activeHeader.searchLink=false}if(isContentColumn(d.activeHeader)){d.activeHeader.searchLink=false}if(!d.configHeadMenu){d.configHeadMenu=true;var c=[];if(toBool(a.columnMenu.lookField,true)){c.push({text:"查看字段",iconCls:"extIcon extField",onBeforeShow:function(){if(toBool(b.activeHeader.lookField,true)){this.show()}else{this.hide()}},handler:function(){Ext.Msg.alert("查看字段",b.activeHeader.dataIndex)}})}if(a.getStore().entity){if(toBool(a.columnMenu.searchLink,true)){c.push({text:"配置搜索链",iconCls:"extIcon extLink",onBeforeShow:function(){if(toBool(b.activeHeader.searchLink,true)){this.show()}else{this.hide()}},handler:function(){configColumnSearchLink(b.activeHeader)}})}if(toBool(a.columnMenu.operation,true)){c.push({text:"统计数据",iconCls:"extIcon extMath",onBeforeShow:function(){if(toBool(b.activeHeader.operation,false)){this.show()}else{this.hide()}},menu:[{text:"计算总和",iconCls:"extIcon extMath",handler:function(){showCompute(a,b.activeHeader,"sum")}},{text:"计算平均值",iconCls:"extIcon extMath",handler:function(){showCompute(a,b.activeHeader,"avg")}},{text:"计算最大值",iconCls:"extIcon extMath",handler:function(){showCompute(a,b.activeHeader,"max")}},{text:"计算最小值",iconCls:"extIcon extMath",handler:function(){showCompute(a,b.activeHeader,"min")}}]})}}if(toBool(a.columnMenu.batchUpdate,true)){c.push({text:"批量修改",iconCls:"extIcon extEdit",onBeforeShow:function(){if(toBool(b.activeHeader.batchUpdate,true)){this.show()}else{this.hide()}},handler:function(){batchEditColumn(b.activeHeader)}})}if(toBool(a.columnMenu.cancelSort,true)){c.push({text:"取消排序",iconCls:"extIcon extCancelOrder",onBeforeShow:function(){if(toBool(b.activeHeader.cancelSort,true)){this.show()}else{this.hide()}},handler:function(){try{var f=a.getStore().getSorters();if(f.count()==0){return}f.removeByKey(b.activeHeader.dataIndex);a.getStore().loadPage(1);b.activeHeader.sortDirection=null;refreshColumnStyle(b.activeHeader)}catch(g){showException(g)}}})}d.insert(0,c)}fireMenuEvent(d,"onBeforeShow")})}function getGridSelModel(){return Ext.create("Ext.grid.selection.SpreadsheetModel",{pruneRemoved:false,checkboxSelect:true,hasLockedHeader:true,cellSelect:false,rowNumbererHeaderWidth:0})}function getPageToolBar(b){var a=Ext.create("Ext.toolbar.Paging",{store:b,dock:"bottom",pageSize:b.pageSize,displayInfo:true,inputItemWidth:70,overflowHandler:"scroller"});var e={xtype:"combo",pageTool:true,displayField:"text",valueField:"id",fieldLabel:"每页",labelWidth:40,editable:false,width:130,value:b.pageSize,store:getPageDataStore(),listeners:{change:function(i,h,f){if(h!=null&&h!=0){var g=i.getStore().getById(h);if(g==null){i.totalCount=h;i.setValue(-1);return}if(h==-1){this.ownerCt.pageSize=b.getTotalCount();b.pageSize=b.getTotalCount();if(!Ext.isEmpty(i.totalCount)){this.ownerCt.pageSize=i.totalCount;b.pageSize=i.totalCount}}else{this.ownerCt.pageSize=h;b.pageSize=h}b.loadPage(1)}}}};var d={xtype:"button",iconCls:"extIcon extCopy2 grayColor",handler:function(){var f=b.grid.getSelection();if(f.length==0){showAlert("系统提醒","请选择需要复制的数据！");return}Ext.Msg.confirm("系统提醒","您确定复制选中的"+f.length+"条数据吗？",function(g,h){if(g=="yes"){showWait("正在复制数据中……");commitStoreCopy(b.grid.getStore(),b.grid.getSelection()).then(function(j){if(j){b.grid.getSelectionModel().deselectAll();var i=b.grid.getStore().isGrouped();if(i){b.grid.getView().getFeature("group").collapseAll()}hideWait()}})}})}};var c={xtype:"button",iconCls:"extIcon extDelete grayColor",handler:function(){Ext.Msg.confirm("系统提醒","您确定删除当前条件下的所有数据吗？请您谨慎操作！",function(g,i){if(g=="yes"){showWait("正在删除数据中……");var f=b.grid.getStore().proxy.extraParams;var h={entityCode:b.entity.entityCode,all:true};server.deleteEntity(mergeJson(h,f),function(k,j){hideWait();if(k){b.loadPage(1)}showAlert("系统提醒",j)})}})}};a.insert(0,e);a.insert(a.items.getCount()-2,"-");a.insert(a.items.getCount()-2,c);a.insert(a.items.getCount()-4,"-");a.insert(a.items.getCount()-4,d);return a}function deleteGridData(a){return new Ext.Promise(function(e,d){if(!a.getStore().entity){Ext.Msg.alert("系统提醒","删除失败！Grid的DataStore未绑定Entity!");return}if(a.getSelection().length==0){toast("请您先选择需要删除的数据！");return}var b=a.getSelection().length;var c=function(){showWait("正在删除数据中……");commitStoreDelete(a.getStore(),a.getSelection()).then(function(g){if(g){a.getSelectionModel().deselectAll();var f=a.getStore().isGrouped();if(f){a.getView().getFeature("group").collapseAll()}hideWait()}e(g)})};if(a.operate&&a.operate.alertDelete){Ext.Msg.confirm("系统提醒","您确定删除选中的"+b+"条数据吗？",function(f,g){if(f=="yes"){c()}})}else{c()}})}function updateGridData(a){return new Ext.Promise(function(d,c){if(!a.getStore().entity){Ext.Msg.alert("系统提醒","修改失败！Grid的DataStore未绑定Entity!");return}var b=a.getStore().getUpdatedRecords();if(b.length==0){toast("当前暂无数据被修改！");return}showWait("正在修改数据中……");if(a.operate&&a.operate.alertUpdate){Ext.Msg.confirm("系统提醒","您确定提交被修改的数据吗？",function(e,f){if(e=="yes"){commitStoreUpdate(a.getStore()).then(function(g){d(g);if(g){hideWait()}})}})}else{commitStoreUpdate(a.getStore()).then(function(e){d(e);if(e){hideWait()}})}})}function saveGridColumn(a){if(Ext.isEmpty(a.code)){return}return new Ext.Promise(function(f,d){try{var c={};Ext.each(a.getColumns(),function(j,i){if(!Ext.isEmpty(j.dataIndex)){var l={column:true};l.width=j.width;l.hidden=j.isHidden();l.locked=j.isLocked();l.text=j.configText;l.dataIndex=j.dataIndex;if(a.getStore().entity){l.entityCode=a.getStore().entityCode}var k=a.getStore().getSorters().getByKey(j.dataIndex);if(k){l.sortDirection=k.getDirection()}l.searchLink=j.searchLink;l.index=j.getIndex();var e=j.renderer.toString();e="function "+e.substring(e.indexOf("("));l.renderer=e;l.rendererFunction=j.rendererFunction;c[j.code]=l}});var b={pageSize:a.getStore().pageSize,column:false};c.PageTool=b;var h={};if(a.getStore().entity&&a.getStore().entity.menu){h.menuId=a.getStore().entity.menu.id;if(system.isSuperRole()){h.entityCode=a.getStore().entity.entityCode}}server.saveExtConfig(a.code,"GridColumn",Ext.encode(c),function(i,e){f(i)},h)}catch(g){d(g)}})}function restoreGridOperate(a){return new Ext.Promise(function(c,b){try{if(Ext.isEmpty(a.code)){b("Grid编号[code]不可为空！");return}server.showExtConfig(a.code,"GridOperate",function(f,e){if(f){a.operate=Ext.decode(e)}else{if(Ext.isEmpty(a.operate)){a.operate={alertDelete:true,alertUpdate:true,autoUpdate:false,autoDetails:true,hoverTip:false}}}c()})}catch(d){b(d)}})}function restoreGridColumn(a){return new Ext.Promise(function(c,b){try{if(Ext.isEmpty(a.code)){b("Grid编号[code]不可为空！");return}server.showExtConfig(a.code,"GridColumn",function(r,p){var o={};if(r){o=Ext.decode(p)}var j=[];var m=[];var e=a.getColumns();for(var l=0;l<e.length;l++){var h=e[l];if(!Ext.isEmpty(h.dataIndex)){var k=h.cloneConfig();if(o.hasOwnProperty(h.code)){var f=o[h.code];for(var q in f){if(q=="renderer"||q=="rendererFunction"){continue}k[q]=f[q];if(q=="sortDirection"){m.push({property:k.dataIndex,direction:k.sortDirection})}}}j.push(k)}}j.sort(function(s,i){return s.index-i.index});if(o.hasOwnProperty("PageTool")){var g=o.PageTool;a.getStore().pageSize=g.pageSize;var n=a.down("combo[pageTool=true]");if(n){n.setValue(g.pageSize)}}a.getStore().sort(m);a.reconfigure(j);c()})}catch(d){b(d)}})}function createDetailsGrid(){var a=Ext.create("Ext.data.Store",{autoLoad:false,fields:[]});var b=Ext.create("Ext.grid.Panel",{border:0,scrollable:"y",region:"center",store:a,hideHeaders:true,superGrid:null,setRecord:function(f,c){this.superGrid=f;var e=f.getColumns();var j=[];for(var d=0;d<e.length;d++){var g=e[d];if(Ext.isEmpty(g.dataIndex)){continue}var h={text:g.configText,value:c.get(g.dataIndex),dataIndex:g.dataIndex,renderer:g.renderer,index:g.getIndex(),record:c};j.push(h)}a.loadData(j);a.sort("index","ASC")},columns:[{header:"名称",dataIndex:"text",width:120,align:"right",tdCls:"tdVTop",renderer:function(e,c,d){c.style="color:#000000;overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space:normal !important;line-height:20px;word-break:break-all; ";return"<b>"+e+"：</b>"}},{header:"值",dataIndex:"value",flex:1,align:"left",renderer:function(i,c,f){try{c.style="overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space:normal !important;line-height:20px;word-break:break-all; ";var d=f.get("renderer");if(Ext.isFunction(d)){var g=d(i,c,f.get("record"),-1,-1,null,null,true);if(Ext.isEmpty(g)){return"<font color='#ccc'>无</font>"}return g}return i}catch(h){return i}}}],tbar:{flex:1,emptyText:"查找属性（轻敲回车键）",xtype:"textfield",doSearch:function(){var e=0;var c=a.getAt(0).get("dataIndex");var d=this.getValue();if(!Ext.isEmpty(d)){a.each(function(f,g){var i=f.get("text").toString();var h=f.get("value");if(i.indexOf(d)>=0){e=g;c=f.get("dataIndex");return}if(!Ext.isEmpty(h)&&h.toString().indexOf(d)>=0){e=g;c=f.get("dataIndex");return false}})}scrollToColumn(b.superGrid,c);b.getSelectionModel().select(e);b.view.focusRow(e);this.focus()},triggers:{search:{cls:"text-search",handler:function(){this.doSearch()}}},listeners:{render:function(d,c){new Ext.KeyMap(d.getEl(),[{key:13,fn:function(){this.doSearch()},scope:this}])}}},viewConfig:{enableTextSelection:true},listeners:{itemdblclick:function(){try{var c=this.getSelectionModel().getSelection();scrollToColumn(this.superGrid,c[0].get("dataIndex"))}catch(d){showException(d,"details:itemdblclick")}}}});return b}function getDetailsPanel(b){var c=Ext.now();var a=Ext.create("Ext.panel.Panel",{title:"数据详情",iconCls:"extIcon extDetails",layout:"fit",region:"east",border:0,width:258,minWidth:200,collapsed:false,maxWidth:588,split:true,autoScroll:true,closeAction:"hide",dataId:-1,hidden:true,currIsClosed:false,closeTimer:null,setRecord:function(d){try{var f=this;window.clearTimeout(f.closeTimer);if(d!=null){var g=d.getSelectionModel().getSelection();if(g.length==1){f.items.get(0).setRecord(d,g[0]);f.show()}else{f.closeTimer=setTimeout(function(){f.close()},80)}}else{f.close()}}catch(h){showException(h)}},listeners:{collapse:function(e,d){Ext.getCmp("close"+c).setHidden(true)},beforeexpand:function(e,d){Ext.getCmp("close"+c).setHidden(false)}},tools:[{type:"gear",callback:function(){setGrid(this,b)}},{type:"close",id:"close"+c,callback:function(){a.collapse()}}],items:[createDetailsGrid()]});b.detailsPanel=a;b.on("selectionchange",function(h,f,d){try{if(b.operate&&b.operate.autoDetails){if(!Ext.isEmpty(b.detailsPanel)){b.detailsPanel.setRecord(b)}}else{b.detailsPanel.close()}}catch(g){showException(g)}});return a}function exportGrid(b){if(!b.getStore().entity){Ext.Msg.alert("系统提醒","导出失败！Grid的DataStore未绑定Entity!");return}var a=b.getStore().proxy.extraParams;var c={};if(b.getStore().entity.menu){c.title=b.getStore().entity.menu.text}Ext.each(b.getColumns(),function(e,d){if(isFileColumn(e)||isFilesColumn(e)){return}if(!Ext.isEmpty(e.dataIndex)){c["column["+d+"].width"]=e.width;c["column["+d+"].text"]=e.configText;c["column["+d+"].enum"]=getEnumName(e);c["column["+d+"].dataIndex"]=e.dataIndex}});showWait("正在导出中……");server.exportExcel(mergeJson(c,a),function(f,e,d){hideWait();if(f){toast("导出成功！");location.href="attach/"+e}else{Ext.Msg.alert("系统提醒","导出失败！"+d)}})}function setGrid(e,b){var a=Ext.create("Ext.form.Panel",{bodyPadding:5,region:"center",autoScroll:true,viewModel:{data:b.operate},defaults:{labelWidth:60},items:[{xtype:"checkboxfield",fieldLabel:"删除提醒",labelAlign:"right",name:"alertDelete",columnWidth:1,bind:"{alertDelete}",uncheckedValue:false,boxLabel:"删除数据时，系统会弹出确认删除框，避免误操作删除！"},{xtype:"checkboxfield",fieldLabel:"修改提醒",labelAlign:"right",columnWidth:1,name:"alertUpdate",bind:"{alertUpdate}",uncheckedValue:false,boxLabel:"修改数据时，系统会弹出确认修改框，避免误操作修改！"},{xtype:"checkboxfield",fieldLabel:"自动提交",labelAlign:"right",columnWidth:1,name:"autoUpdate",bind:"{autoUpdate}",uncheckedValue:false,boxLabel:"双击编辑修改数据后，系统自动提交被修改的数据！"},{xtype:"checkboxfield",fieldLabel:"弹出详情",labelAlign:"right",columnWidth:1,name:"autoDetails",bind:"{autoDetails}",uncheckedValue:false,boxLabel:"点击数据时，右侧自动弹出此数据的详情窗体！"},{xtype:"checkboxfield",fieldLabel:"悬浮阅览",labelAlign:"right",columnWidth:1,name:"hoverTip",bind:"{hoverTip}",uncheckedValue:false,boxLabel:"当鼠标悬浮在数据超过2秒后，会在鼠标右下方弹出此数据的阅览！"}]});var c="操作设置";if(b.getStore().entity&&b.getStore().entity.menu){c=b.getStore().entity.menu.text+"-"+c}var d=Ext.create("Ext.window.Window",{title:c,height:370,iconCls:"extIcon extSet",width:300,layout:"border",resizable:false,animateTarget:e,items:[a],modal:true,constrain:true,buttons:["->",{text:"保存配置",iconCls:"extIcon extSave whiteColor",handler:function(){showWait("正在保存中…");server.saveExtConfig(b.code,"GridOperate",Ext.encode(a.getForm().getValues()),function(g,f){hideWait();if(g){b.operate=a.getForm().getValues();toast("操作设置成功！");d.close()}else{Ext.Msg.alert("系统提醒",f)}})}},{text:"取消",iconCls:"extIcon extClose",handler:function(){d.close()}}]});d.show()}function showDetailsWindow(obj,title,entity,record){server.showColumns(entity.entityCode,function(success,value,message){if(success){var columnInfos=Ext.decode(value);var data=[];for(var key in columnInfos){if(columnInfos.hasOwnProperty(key)){var column=columnInfos[key];if(Ext.isEmpty(column.dataIndex)){continue}var d={value:record.get(column.dataIndex),record:record};for(var c in column){if(column.hasOwnProperty(c)){d[c]=column[c]}}data.push(d)}}data.sort(function(a,b){return a.index-b.index});var detailsStore=Ext.create("Ext.data.Store",{autoLoad:false,fields:[]});detailsStore.loadData(data);detailsStore.sort("index","ASC");var detailsGrid=Ext.create("Ext.grid.Panel",{border:0,scrollable:"y",region:"center",store:detailsStore,hideHeaders:true,columns:[{header:"名称",power:false,dataIndex:"text",width:120,tdCls:"tdVTop",align:"right",renderer:function(val,m,r){m.style="overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space:normal !important;line-height:20px;word-break:break-all; ";return"<b>"+val+"：</b>"}},{header:"值",dataIndex:"value",power:false,flex:1,align:"left",renderer:function(val,m,r){try{m.style="overflow:auto;padding: 3px 6px;text-overflow: ellipsis;white-space:normal !important;line-height:20px;word-break:break-all; ";var fun=null;var rendererFunction=r.get("rendererFunction");if(rendererFunction){fun=eval(rendererFunction)}else{var renderer=r.get("renderer");fun=loadFunction(renderer)}if(!Ext.isEmpty(fun)){val=fun(val,m,r.get("record"),-1,-1,null,null,true)}if(Ext.isEmpty(val)||val=="null"){return"<font color='#ccc'>无</font>"}return val}catch(e){return val}}}],viewConfig:{loadMask:{msg:"正在为您在加载数据…"},enableTextSelection:true}});var win=Ext.create("Ext.window.Window",{title:title,height:450,width:400,minHeight:300,iconCls:"extIcon extDetails",minWidth:200,layout:"border",resizable:true,constrain:true,maximizable:true,animateTarget:obj,listeners:{destroy:function(obj,op){}},items:[detailsGrid]});win.show()}else{showAlert("系统提醒",message)}})}function hasSearchColumn(b){var a=false;Ext.each(b.getColumns(),function(d,c){if(!Ext.isEmpty(d.dataIndex)){if(d.where&&d.where.length>0){a=true;return false}}});return a}Ext.override(Ext.grid.column.Column,{afterRender:Ext.Function.createSequence(Ext.grid.column.Column.prototype.afterRender,function(){var me=this;me.code=getPowerCode(me);if(!me.renderer){me.renderer=renders.normal()}if(me.rendererFunction){me.renderer=eval(me.rendererFunction)}configColumnProperty(me)})});function isColumnType(a){return a=="gridcolumn"||a.xtype=="gridcolumn"}function getColumnFieldType(a){if(Ext.isObject(a.field)){return a.field.xtype}return a.field}function getColumnGrid(a){if(!a.grid){a.grid=a.up("treepanel,grid")}if(a.grid.ownerGrid){return a.grid.ownerGrid}return null}function configColumnProperty(a){a.configText=a.text;a.toSearchKey=function(b){return"where['"+this.getIndex()+this.dataIndex+b.compare+"']"};a.searchValue=function(d){var c=this;if(!c.where){c.where=[]}var b={compare:"=",value:d};c.where.push(b);c.doSearch()};a.clearSearch=function(){var e=this;var b=getColumnGrid(e).getStore().proxy.extraParams;if(e.where){for(var d=0;d<e.where.length;d++){var c=e.toSearchKey(e.where[d]);if(b.hasOwnProperty(c)){delete b[c]}}}};a.doSearch=function(){var f=this;var c=getColumnGrid(f).getStore().proxy.extraParams;if(f.where){for(var e=0;e<f.where.length;e++){var b=f.where[e];var d=f.toSearchKey(b);var g=b.value;if(b.compare.indexOf("?")>=0){g="%"+b.value+"%"}c[d]=g}getColumnGrid(f).getStore().loadPage(1);if(f.where.length==0){a.setStyle("color","#444444")}else{a.setStyle("color","red")}}}}function refreshColumnStyle(a){if(!Ext.isEmpty(a.dataIndex)){var b=a.sortDirection;if(Ext.isEmpty(b)){b="<font size='1'></font>"}else{if(b=="ASC"){b="<font color='red' size='1'>&nbsp;&nbsp;[正序]</font>"}else{b="<font color='red' size='1'>&nbsp;&nbsp;[倒序]</font>"}}if(Ext.isEmpty(a.sumText)){a.sumText="<font size='1'></font>"}a.setText("&nbsp;"+a.configText+a.sumText+b+"&nbsp;")}}function showColumnSearchMenu(c){if(isFilesColumn(c)||isFileColumn(c)){return false}if(!toBool(c.search,true)){return false}if(!c.searchMenu){c.searchMenu=new Ext.menu.Menu({padding:"0 0 0 0",power:false,showSeparator:false,style:{background:"#ffffff"},addSearchItem:function(e){var d=this.items.length-1;if(d>=5){return}this.insert(d,buildSearchItem(c,e))},doSearch:function(){var e=this;var d=[];e.items.each(function(h,g){if(h.searchItem){var f=h.toParam();if(f==null){d=null;return false}if(Ext.isEmpty(f.value)){return}f.index=g;d.push(f)}});if(d){c.clearSearch();c.where=d;c.doSearch();e.hide()}},items:[{xtype:"panel",layout:"hbox",margin:"2",border:0,items:[{xtype:"button",text:"搜索",flex:1,iconCls:"extIcon extSearch",margin:"0 2 0 0",handler:function(){this.ownerCt.ownerCt.doSearch()}},{xtype:"button",iconCls:"extIcon extPlus fontSize14",width:35,handler:function(){this.ownerCt.ownerCt.addSearchItem()}}]}],listeners:{show:function(e,d){if(e.items.length==1){e.addSearchItem()}new Ext.KeyMap(e.getEl(),[{key:13,fn:function(){e.doSearch()},scope:e}])}}})}if(c.where){for(var b=0;b<c.where.length;b++){var a=c.where[b];if(Ext.isEmpty(a.index)){a.index=b}if(a.index<c.searchMenu.items.length-1){c.searchMenu.items.getAt(a.index).setParam(a)}else{c.searchMenu.addSearchItem(a)}}}c.searchMenu.setWidth(Math.max(c.width,200));c.searchMenu.showBy(c,"tl-bl?");return true}function buildSearchItem(d,c){var b=getColumnSimpleEditor(d,true);b.flex=1;b.margin="2 2 0 0";b.repeatTriggerClick=false;b.onClearValue=function(){this.ownerCt.destroy()};b.triggers={close:{cls:"text-clear",handler:function(){this.ownerCt.destroy()}}};b.editable=true;b.emptyText="请输入条件值";b.listeners={afterrender:function(f,e){if(Ext.isFunction(f.getTrigger)){if(f.getTrigger("picker")){f.getTrigger("picker").hide()}if(f.getTrigger("spinner")){f.getTrigger("spinner").hide()}}}};if(isDateField(b)){b.editable=false}if(!c){c={compare:"=",value:""};if(isTextField(b)){c.compare="?"}else{if(isDateField(b)){c.compare=">"}}}b.value=c.value;b.submitValue=false;b.name="value";var a={xtype:"panel",margin:"0",searchItem:true,border:0,layout:"hbox",toParam:function(){var e={};this.items.each(function(f){if(Ext.isFunction(f.getValue)){if(f.isValid()){e[f.getName()]=f.getValue()}else{shakeComment(f);toast(f.getErrors()[0]);e=null;return false}}});return e},setParam:function(e){this.items.each(function(f){if(Ext.isFunction(f.getValue)){if(f.getName()=="compare"){f.setValue(e.compare)}else{f.setValue(e.value)}}})},items:[{xtype:"combo",name:"compare",value:c.compare,margin:"2 2 0 2",width:35,valueField:"text",editable:false,hideTrigger:true,tpl:Ext.create("Ext.XTemplate",'<ul class="x-list-plain"><tpl for=".">','<li role="option" class="x-boundlist-item" style="font-size: 12px;">{desc}</li>',"</tpl></ul>"),listeners:{afterrender:function(f,e){f.getPicker().setMinWidth(100)}},store:getCompareDataStore()},b]};return a}function showCompute(b,d,c){if(!b.getStore().entity){Ext.Msg.alert("系统提醒","计算失败！Grid的DataStore未绑定Entity!");return}var a=b.getStore().proxy.extraParams;var e={entityCode:b.getStore().entity.entityCode,field:d.dataIndex,type:c};showWait("正在计算中……");$.post("entity/compute",mergeJson(e,a),function(f){hideWait();var g="";if(c=="sum"){g=d.configText+"总和："}else{if(c=="avg"){g=d.configText+"平均值："}else{if(c=="min"){g=d.configText+"最小值："}else{if(c=="max"){g=d.configText+"最大值："}}}}if(Ext.isFunction(d.renderer)){Ext.Msg.alert("系统提醒",g+d.renderer(f.data))}else{Ext.Msg.alert("系统提醒",g+f.data)}})}function getColumnSimpleEditor(c,a){var b={};if(Ext.isObject(c.field)){b.xtype=c.field.xtype}else{b.xtype=c.field}if(Ext.isObject(c.config.field)){if(a){b=copy(c.config.field)}else{b=c.config.field}}if(a){if(isContentField(c.field)||isHtmlContentField(c.field)||isTargetField(c.field)){b.xtype="textfield"}}if(Ext.isEmpty(b.xtype)){b.xtype="textfield"}b.dataIndex=c.dataIndex;return b}function hasColumnField(a){if(Ext.isObject(a.field)){return true}if(!Ext.isEmpty(a.field)){return true}return false}function isDateColumn(a){if(!a){return false}return isDateField(a.field)}function isNumberColumn(a){if(!a){return false}return isNumberField(a.field)}function isFileColumn(a){if(!a){return false}return isFileField(a.field)}function isContentColumn(a){if(!a){return false}return isHtmlContentField(a.field)||isContentField(a.field)}function isFilesColumn(a){if(!a){return false}return isFilesField(a.field)}function isEnumColumn(a){if(!a){return false}return isEnumField(a.field)}function isLinkColumn(a){if(!a){return false}return isLinkField(a.field)}function getEnumName(a){if(isEnumColumn(a)){if(Ext.isObject(a.field)){return a.field.enumName}}return null}function getColumn(d,c){var b=d.getColumns();for(var a=0;a<b.length;a++){var e=b[a];if(e.dataIndex==c){return e}}return null}function blinkColumn(b){if(b.blinking){return}b.blinking=true;var c=b.getEl().getStyle("color");var a=b.getEl().getStyle("backgroundColor");b.setStyle({color:"white",backgroundColor:"#e41f00"});setTimeout(function(){b.setStyle({color:c,backgroundColor:a});b.blinking=false},1000)}function scrollToColumn(c,b){var d=getColumn(c,b);blinkColumn(d);var a=d.getLocalX();c.view.getEl().scrollTo("left",a,true)}function batchEditColumn(b){var a=b.batchField;if(!a){a=getColumnSimpleEditor(b);a.flex=1;a.emptyText="请输入";a=b.batchField=Ext.create(a)}var c=function(f){if(!Ext.isEmpty(f.getValue())){if(getColumnGrid(b).operate&&getColumnGrid(b).operate.autoUpdate){getColumnGrid(b).getStore().holdUpdate=true}var e=getColumnGrid(b).getSelectionModel().getSelection();if(e.length>0){Ext.each(e,function(g,h){setRecordValue(g,b.dataIndex,f)})}else{getColumnGrid(b).getStore().each(function(g,h){setRecordValue(g,b.dataIndex,f)})}if(getColumnGrid(b).getStore().holdUpdate){commitStoreUpdate(getColumnGrid(b).getStore()).then(function(){getColumnGrid(b).getStore().holdUpdate=false})}}};var d="批量修改当前页的【"+b.text+"】数据";if(getColumnGrid(b).getSelection().length>0){d="批量修改选择的"+getColumnGrid(b).getSelection().length+"条【"+b.text+"】数据"}if(Ext.isFunction(a.setEmptyText)){a.setEmptyText(d)}if(Ext.isFunction(a.showWindow)){a.showWindow(b,function(e){c(e)},d);return}if(!b.batchEditMenu){b.batchEditMenu=Ext.create("Ext.menu.Menu",{showSeparator:false,layout:"fit",doUpdate:function(){var e=this.down("button[name='confirm']");e.setText("稍等");e.setDisabled(true);var f=this;new Ext.Promise(function(i,h){var g=f.items.get(0).items.get(0);c(g);g.setValue(null);i()}).then(function(){e.setText("确定");e.setDisabled(false);f.hide()})},items:[{xtype:"panel",layout:"hbox",style:{background:"#ffffff",borderWidth:1,borderColor:"#ffffff",color:"#eeeee"},border:0,items:[a,{xtype:"button",text:"确定",name:"confirm",width:60,margin:"0 0 0 2",handler:function(){b.batchEditMenu.doUpdate()}}]}],listeners:{show:function(g,e){var f=g.items.get(0).items.get(0);f.focus();new Ext.KeyMap(g.getEl(),[{key:13,fn:function(){editMenu.doUpdate()},scope:g}])},beforehide:function(g,e){var f=g.items.get(0).items.get(0);if(!f.isValid()){shakeComment(g);toast(f.getErrors()[0])}return f.isValid()}}})}b.batchEditMenu.setWidth(b.getWidth());b.batchEditMenu.showBy(b,"tl")}function configColumnSearchLink(a){var b="";if(a.searchLink){b=a.searchLink.checked}system.showMenuColumns(a,b).then(function(c){if(c.columns.length>0){a.searchLink=c;toast("配置成功！")}else{a.searchLink=null;toast("已清空搜索链！")}})}function showMap(d,b,c,a){return new Ext.Promise(function(l,m){var i="";if(!Ext.isEmpty(b)&&!Ext.isEmpty(c)&&parseFloat(b)!=0&&parseFloat(c)!=0){i=b+","+c}var f=Ext.create("Ext.panel.Panel",{layout:"border",region:"center",border:0});var e=Ext.create("Ext.form.FormPanel",{url:"addData",method:"POST",region:"north",fileUpload:true,autoScroll:true,height:50,layout:"column",defaults:{margin:"5 5 5 5"},items:[{name:"map.taskTitle",fieldLabel:"位置搜索",labelWidth:60,labelAlign:"right",id:"txtSearch",columnWidth:0.8,emptyText:"输入地址",xtype:"textfield"},{xtype:"button",columnWidth:0.2,text:"搜索",handler:function(){g()}}],listeners:{render:function(n){new Ext.KeyMap(n.getEl(),[{key:13,fn:g,scope:Ext.getBody()}])}}});var g=function(){mapFrame.window.searchAddress(Ext.getCmp("txtSearch").getValue())};var k=Ext.create("Ext.panel.Panel",{layout:"column",region:"south",border:0,height:42,defaults:{margin:"5 5 5 5"},items:[{xtype:"textfield",id:"lblAddress",fieldLabel:"选择位置",labelWidth:60,value:a,labelAlign:"right",columnWidth:0.8},{xtype:"hiddenfield",id:"lblLngLat",value:i},{xtype:"button",columnWidth:0.2,text:"确定",handler:function(){var o=Ext.getCmp("lblLngLat");var n=o.getValue();var p=n.split(",")[0];var q=n.split(",")[1];if(!l.called){l.called=true;l({lng:p,lat:q,addr:Ext.getCmp("lblAddress").getValue(),pro:o.province,city:o.city,area:o.area})}h.close()}}]});var j=Ext.create("Ext.panel.Panel",{layout:"border",border:0,items:[e,f,k]});var h=Ext.create("Ext.window.Window",{title:"选择位置",height:500,iconCls:"extIcon extMap",width:500,layout:"fit",resizable:true,maximizable:true,animateTarget:d,constrain:true,items:[j],modal:true,listeners:{show:function(){var n=system.formatUrlVersion("base/map/select.html",{mapVersion:getExt("amap-version").value,mapKey:getExt("amap-key").value});f.update("<iframe name='mapFrame'  src='"+n+"' width='100%' height='100%' frameborder='0' scrolling='no' />")},close:function(n){if(!l.called){l.called=true;l()}}}});h.show();j.setLoading("正在定位中，请稍后……");window.onMapLoadDone=function(){if(!Ext.isEmpty(i)){mapFrame.window.setLngLatAddress(i)}else{mapFrame.window.startLocation()}};window.closeMapMask=function(){j.setLoading(false)};window.showMapMask=function(n){if(n){j.setLoading(n)}else{j.setLoading(true)}};window.alert=function(n){showAlert("系统提醒",n)};window.setMarkCurrPos=function(o,p,n,s,r){Ext.getCmp("lblAddress").setValue(p);var q=Ext.getCmp("lblLngLat");q.setValue(o);q.province=n;q.city=s;q.area=r}})}function showAddressInMap(c,a){var d=Ext.create("Ext.panel.Panel",{layout:"border",region:"center",border:0,listeners:{afterrender:function(f,e){var g={lnglat:a,mapVersion:getExt("amap-version").value,mapKey:getExt("amap-key").value};f.update("<iframe name='mapFrame'  src='"+system.formatUrlVersion("base/map/show.html",g)+"' width='100%' height='100%' frameborder='0' scrolling='no' />")}}});var b=Ext.create("Ext.window.Window",{title:"查看位置",height:500,iconCls:"extIcon extMap",width:500,layout:"border",resizable:true,maximizable:true,animateTarget:c,constrain:true,items:[d],modal:true});b.show();d.setLoading("正在请求地址信息……");window.closeMapMask=function(){d.setLoading(false)}}Ext.override(Ext.menu.Menu,{hide:function(){if(Ext.isEmpty(system)){return}var a=this;if(!a.powerMenu){if(power.menuShowing){return}}if(a.holdShow){return}if(a.pendingShow){a.pendingShow=false}if(!(a.rendered&&!a.isVisible())){if(!a.hasListeners.beforehide||a.fireEvent("beforehide",a)!==false||a.hierarchicallyHidden){a.getInherited().hidden=a.hidden=true;a.fireHierarchyEvent("beforehide");if(a.rendered){a.onHide.apply(a,arguments)}}}return a}});function copyMenu(b){var a=[];b.items.each(function(d,c){var e={icon:d.icon,text:d.text,handler:d.handler};if(d.getMenu()!=null){e.menu=copyMenu(d.getMenu())}a.push(e)});return a}function fireMenuEvent(b,a){if(b){b.items.each(function(d,c){if(d.hasOwnProperty(a)&&Ext.isFunction(d[a])){d[a]()}if(Ext.isFunction(d.getMenu)){fireMenuEvent(d.getMenu(),a)}})}}Ext.define("Fast.ext.EnumComboBox",{alias:["widget.enumcombobox","widget.enumcombo"],extend:"Ext.form.field.ComboBox",enumName:"NONE",exclude:[],initComponent:function(){var a=this;a.displayField="text";a.valueField="id";a.editable=false;a.store=getEnumDataStore(a.enumName);a.store.filterBy(function(b){if(a.exclude.exists(b.get("id"))){return false}return true});a.callParent()}});Ext.define("Fast.ext.FastFile",{extend:"Ext.form.field.Text",alias:["widget.fastfile","widget.fastfilefield"],fileModules:[],editable:false,getMenu:function(){return this.up("menu")},listeners:{change:function(d,c,a,b){if(Ext.isEmpty(c)){d.getTrigger("help").hide()}else{d.getTrigger("help").show()}},afterrender:function(b){var a=this;if(!this.editable){b.inputEl.on("click",function(){a.selectData()})}}},initComponent:function(){var c="";for(var a=0;a<this.fileModules.length;a++){var b=this.fileModules[a];c=c+"或"+b.tipMsg}this.emptyText="请上传"+c.substring(1);this.editable=false;this.callParent(arguments)},triggers:{help:{cls:"extIcon extEye",hidden:true,handler:function(){var a=this;if(a.fileModules.length==1){if(a.fileModules[0].type=="images"){if(a.getMenu()){a.getMenu().holdShow=true}a.blur();showImage(a,a.getValue(),function(){if(a.getMenu()){a.getMenu().holdShow=false}},true);return}}location.href=a.getValue()}},search:{cls:"extIcon extUpload",handler:function(){this.selectData()}}},selectData:function(){var a=this;if(a.getMenu()){a.getMenu().holdShow=true}uploadFile(a,a.fileModules).then(function(b){if(a.getMenu()){a.getMenu().holdShow=false}if(b){a.setValue(b.url)}})}});Ext.define("Fast.ext.FastFiles",{alias:["widget.fastfiles","widget.fastfilesfield"],extend:"Ext.form.field.Text",editable:false,fileModules:[],allowBlank:true,getMenu:function(){return this.up("menu")},listeners:{afterrender:function(b){var a=this;if(!this.editable){b.inputEl.on("click",function(){a.showWindow(a)})}}},initComponent:function(){var c="";for(var a=0;a<this.fileModules.length;a++){var b=this.fileModules[a];c=c+"或"+b.tipMsg}this.emptyText="请上传"+c.substring(1);this.editable=false;this.callParent(arguments)},triggers:{search:{cls:"text-search",handler:function(){this.showWindow(this)}}},showWindow:function(c,b,d){var a=this;showFiles(this,function(e){a.setValue(e);if(Ext.isFunction(b)){b(a)}},a.fileModules,a.getValue())}});Ext.define("Fast.ext.Content",{alias:["widget.content","widget.contentfield"],extend:"Ext.form.field.TextArea",height:220,emptyText:"请填写……",allowBlank:true,getCode:function(){return $.md5(this.getName()+this.dataIndex+this.getFieldLabel())},showWindow:function(c,b,d){if(Ext.isEmpty(d)){d="编辑内容"}var a=this;a.oldValue=a.getValue();if(!a.editorWin){a.editorWin=Ext.create("Ext.window.Window",{title:d,iconCls:"extIcon extEdit",resizable:true,maximizable:true,height:400,width:600,layout:"fit",animateTarget:c,items:[a],modal:true,constrain:true,closeAction:"hide",listeners:{show:function(e){server.showExtConfig(a.getCode(),"TextEditorCache",function(g,f){if(g){a.setValue(f)}})}},buttons:[{text:"暂存",iconCls:"extIcon extSave whiteColor",handler:function(){showWait("暂存中，请稍后……");server.saveExtConfig(a.getCode(),"TextEditorCache",a.getValue(),function(f,e){hideWait();if(f){toast("暂存成功！")}else{showAlert("系统提醒",e)}})}},{text:"重置",iconCls:"extIcon extReset",handler:function(){a.setValue(a.oldValue);server.deleteExtConfig(a.getCode(),"TextEditorCache")}},{text:"确定",iconCls:"extIcon extOk",handler:function(){showWait("请稍后……");server.deleteExtConfig(a.getCode(),"TextEditorCache",function(e){hideWait();if(Ext.isFunction(a.editorWin.callBack)){a.editorWin.callBack(a)}a.editorWin.close()})}}]})}a.editorWin.setTitle(d);a.editorWin.callBack=b;a.editorWin.animateTarget=c;a.editorWin.show()}});Ext.define("Fast.ext.HtmlContent",{alias:["widget.htmlcontent","widget.htmlcontentfield"],extend:"Ext.form.FieldContainer",height:300,getName:function(){return this.name},autoShowEditor:true,allowBlank:true,showEditor:function(){var d=this;console.log("showEditor");window.editorLoadDone=function(){d.setValue(d.value);d.setPostImageUrl(system.formatUrl("upload?type=editor"))};var c="EditorFrame"+Ext.now();d.editorFrameId=c;var a=system.formatUrlVersion("base/editor/index.html");var b="<iframe id='"+c+"'  src='"+a+"' width='100%' height='100%' frameborder='0' scrolling='no' style='border: 1px solid #d0d0d0;'/>";d.update(b)},listeners:{afterrender:function(a){if(a.autoShowEditor){a.showEditor()}}},getCode:function(){return $.md5(this.getName()+this.dataIndex+this.getFieldLabel())},isValid:function(){return true},getValue:function(){var a=this;var b=a.down("[realValue=true]");if(b){return b.getValue()}return a.value},setValue:function(c){var a=this;var b=a.down("[realValue=true]");if(b){b.setValue(c)}a.value=c},setPostImageUrl:function(c){var b=this;if(b.editorFrameId){var a=document.getElementById(b.editorFrameId);if(a&&Ext.isFunction(a.contentWindow.getHtmlValue)){a.contentWindow.setPostImageUrl(c)}}},initComponent:function(){var a=this;a.items=[{xtype:"textfield",name:a.name,hidden:true,realValue:true,fieldLabel:a.fieldLabel,allowBlank:a.allowBlank,validation:"请输入"+a.fieldLabel,isValid:function(){if(!this.allowBlank){if(Ext.isEmpty($(this.getRawValue()).text())){return false}}return true},getRawValue:function(){if(a.editorFrameId){var b=document.getElementById(a.editorFrameId);if(b&&Ext.isFunction(b.contentWindow.getHtmlValue)){return b.contentWindow.getHtmlValue()}}return null},setValue:function(c){if(a.editorFrameId){var b=document.getElementById(a.editorFrameId);if(b&&Ext.isFunction(b.contentWindow.setHtmlValue)){b.contentWindow.setHtmlValue(c)}}}}];a.callParent(arguments)},showWindow:function(c,b,d){if(Ext.isEmpty(d)){d="编辑内容"}var a=this;a.autoShowEditor=false;a.oldValue=a.value;if(!a.editorWin){a.editorWin=Ext.create("Ext.window.Window",{title:d,iconCls:"extIcon extEdit",resizable:true,maximizable:true,height:400,width:600,layout:"fit",animateTarget:c,items:[a],modal:true,constrain:true,closeAction:"hide",listeners:{show:function(e){a.showEditor();server.showExtConfig(a.getCode(),"HtmlEditorCache",function(g,f){if(g){a.setValue(f)}})}},buttons:[{text:"暂存",iconCls:"extIcon extSave whiteColor",handler:function(){showWait("暂存中，请稍后……");server.saveExtConfig(a.getCode(),"HtmlEditorCache",a.getValue(),function(e,f){hideWait();if(e){toast("暂存成功！")}else{showAlert("系统提醒",f)}})}},{text:"重置",iconCls:"extIcon extReset",handler:function(){a.setValue(a.oldValue);server.deleteExtConfig(a.getCode(),"HtmlEditorCache")}},{text:"确定",iconCls:"extIcon extOk",handler:function(){var e={configKey:a.getCode(),configType:"HtmlEditorCache"};showWait("请稍后……");server.deleteExtConfig(a.getCode(),"HtmlEditorCache",function(f){hideWait();if(Ext.isFunction(a.editorWin.callBack)){a.editorWin.callBack(a)}a.editorWin.close()})}}]})}a.editorWin.setTitle(d);a.editorWin.callBack=b;a.editorWin.animateTarget=c;a.editorWin.show()}});Ext.define("Fast.ext.Link",{alias:["widget.link","widget.linkfield"],extend:"Ext.form.FieldContainer",entityId:null,entityText:null,entityCode:null,linkValue:null,editable:false,allowBlank:true,layout:"fit",submitValue:true,onBeforeSelect:null,isValid:function(){var a=this;var b=a.down("[name="+a.name+"Display]");return b.isValid()},getName:function(){return this.name},getValue:function(){var a=this;if(a.submitValue){var b=a.down("[name="+a.name+"]");return b.getValue()}return a.getText()},getText:function(){var a=this;var b=a.down("[name="+a.name+"Display]");return b.getValue()},setRecordValue:function(a){var b=this;if(a){if(Ext.isEmpty(b.getText())&&Ext.isEmpty(a.get(b.dataIndex))){return}if(a.store){a.store.holdUpdate=true}a.set(b.name,b.getValue());if(a.store){a.store.holdUpdate=false}a.set(b.dataIndex,b.getText())}},setValue:function(d,a){var b=this;var c=b.down("[name="+b.name+"Display]");c.setValue(d);if(a){b.setRawValue(a.get(b.name))}if(!d){b.setRawValue(-1)}},setRawValue:function(c){var a=this;var b=a.down("[name="+a.name+"]");if(b){b.setValue(c)}},getRawValue:function(){var a=this;var b=a.down("[name="+a.name+"]");if(b){return b.getValue()}return null},getMenu:function(){return this.up("menu")},selectData:function(){var me=this;if(Ext.isFunction(me.onBeforeSelect)){if(!me.onBeforeSelect(me)){return}}if(me.getMenu()){me.getMenu().holdShow=true}if(!me.entityCode){showAlert("系统提醒","请配置组件的entityCode属性值！",function(){if(me.getMenu()){me.getMenu().holdShow=false}});return}if(!me.entityId){showAlert("系统提醒","请配置组件的entityId属性值！",function(){if(me.getMenu()){me.getMenu().holdShow=false}});return}if(!me.entityText){showAlert("系统提醒","请配置组件的entityText属性值！",function(){if(me.getMenu()){me.getMenu().holdShow=false}});return}var entity=system.getEntity(me.entityCode);if(!entity){showAlert("系统提醒","未获取到 '"+me.entityCode+"' 实体类！",function(){if(me.getMenu()){me.getMenu().holdShow=false}});return}if(!entity.js){showAlert("系统提醒","未获取到 '"+me.entityCode+"' JS对象！",function(){if(me.getMenu()){me.getMenu().holdShow=false}});return}var entityObj=eval("new "+me.entityCode+"()");if(!Ext.isFunction(entityObj.showSelect)){showAlert("系统提醒","'"+me.entityCode+"' JS对象不存在函数showSelect(obj,callBack)！").then(function(){if(me.getMenu()){me.getMenu().holdShow=false}});return}var display=me.down("[name="+me.name+"Display]");display.blur();entityObj.showSelect(this,"选择"+entity.shortName,me.linkValue.where).then(function(result){if(result){var data=result[0];me.setValue(data.get(me.entityText));me.setRawValue(data.get(me.entityId))}if(me.getMenu()){me.getMenu().holdShow=false}})},clearData:function(){var a=this;a.setValue(null);a.setRawValue(-1)},initComponent:function(){var b=this;if(!b.linkValue){b.linkValue={};b.linkValue[b.entityId]=-1;b.linkValue[b.entityText]=null}if(Ext.isEmpty(b.linkValue[b.entityId])){b.linkValue[b.entityId]=-1}if(Ext.isEmpty(b.name)){b.name="LinkField"+Ext.now()}var a=b.linkValue[b.entityText];if(!a){a=b.value}b.items=[{xtype:"hiddenfield",name:b.name,value:b.linkValue[b.entityId]},{xtype:"textfield",name:b.name+"Display",editable:b.editable,value:a,disabled:b.linkValue[b.entityText]!=null,hideLabel:true,fieldLabel:b.fieldLabel,allowBlank:b.allowBlank,emptyText:b.emptyText,listeners:{afterrender:function(c){if(!this.editable){c.inputEl.on("click",function(){b.selectData()})}}},triggers:{close:{cls:"text-clear",handler:function(){b.clearData();if(Ext.isFunction(b.onClearValue)){b.onClearValue()}}},search:{cls:"text-search",handler:function(){b.selectData();this.inputEl.blur()}}}}];b.callParent(arguments)}});Ext.define("Fast.ext.Target",{alias:["widget.target","widget.targetfield"],extend:"Ext.form.FieldContainer",layout:"column",labelWidth:null,targetType:null,targetTypeReadOnly:false,targetTypeEnum:null,targetId:null,targetValue:null,targetFunction:"getTargetEntity",getValue:function(){var b=this;var a=b.down("[name="+b.targetId+"]");return a.getText()},setValue:function(d,b){var c=this;var a=c.down("[name="+c.targetId+"]");a.setValue(d);if(b){c.targetValue={};c.targetValue[c.targetType]=b.get(c.targetType);c.targetValue[c.targetId]=b.get(c.targetId);c.holdIdValue=c.getTargetTypeValue()!=b.get(c.targetType);c.setTargetIdValue(b.get(c.targetId));c.setTargetTypeValue(b.get(c.targetType))}},getSearchField:function(){},setRecordValue:function(a){var b=this;if(a){if(a.store){a.store.holdUpdate=true}if(b.targetId){a.set(b.targetId,b.getTargetIdValue())}if(b.targetType){a.set(b.targetType,b.getTargetTypeValue())}if(b.targetText&&b.targetText!=b.dataIndex){a.set(b.targetText,b.getValue())}if(a.store){a.store.holdUpdate=false}a.set(b.dataIndex,b.getValue())}},setTargetTypeValue:function(c){var a=this;var b=a.down("[name="+a.targetType+"]");if(b){b.setValue(c)}},getTargetTypeValue:function(){var a=this;var b=a.down("[name="+a.targetType+"]");if(b){return b.getValue()}return 0},setTargetIdValue:function(c){var b=this;var a=b.down("[name="+b.targetId+"]");if(a){a.setRawValue(c)}},getTargetIdValue:function(){var b=this;var a=b.down("[name="+b.targetId+"]");if(a){return a.getRawValue()}return -1},getTargetEntity:function(c){var b=this;var a=window[b.targetFunction](c,b.targetType);if(!a){showAlert("目标组件错误","未获取到TargetType为："+c+"的实体配置！");return null}return a},showWindow:function(c,b,d){if(Ext.isEmpty(d)){d="编辑目标数据"}var a=this;if(!a.editorWin){a.editorWin=Ext.create("Ext.window.Window",{title:d,height:220,width:400,minWidth:400,minHeight:220,layout:"fit",resizable:true,modal:true,constrain:true,closeAction:"hide",iconCls:"extIcon extLink",items:[a],buttons:[{text:"取消",iconCls:"extIcon extClose",handler:function(){a.editorWin.close()}},{text:"确定",iconCls:"extIcon extOk",handler:function(){a.editorWin.close();if(Ext.isFunction(a.editorWin.callBack)){a.editorWin.callBack(a)}}}]})}a.editorWin.setTitle(d);a.editorWin.callBack=b;a.editorWin.animateTarget=c;a.editorWin.show()},initComponent:function(){var d=this;d.fieldLabel="";if(!d.labelWidth){d.labelWidth=60}d.labelAlign="right";if(!d.emptyText){d.emptyText="请填写"}if(!d.margin){d.margin="5 5 5 5"}var f={};if(!Ext.isFunction(window[d.targetFunction])){showAlert("目标组件错误","未检测到方法"+d.targetFunction+"!");d.callParent(arguments);return}if(!d.targetValue){d.targetValue={};d.targetValue[d.targetType]=0;d.targetValue[d.targetId]=-1}if(d.targetEnum){d.targetTypeEnum=d.targetEnum}if(!d.targetTypeEnum){d.targetTypeEnum=d.targetType.replace(d.targetType[0],d.targetType[0].toUpperCase())+"Enum"}var a=d.targetValue[d.targetType];var c=d.getTargetEntity(a);if(!c){return}f[c.entityId]=d.targetValue[d.targetId];var e={name:d.targetType,xtype:"enumcombo",fieldLabel:"目标类型",columnWidth:1,value:a,labelWidth:d.labelWidth,labelAlign:d.labelAlign,emptyText:"请选择目标类型",margin:d.margin,allowBlank:false,readOnly:d.targetTypeReadOnly,enumName:d.targetTypeEnum,listeners:{change:function(k,j,i){var h=d.getTargetEntity(j);if(h){var g=d.down("[name="+d.targetId+"]");g.entityCode=h.entityCode;g.entityId=h.entityId;g.entityText=h.entityText;if(d.holdIdValue){d.holdIdValue=false;return}g.setValue(null)}}}};var b={name:d.targetId,xtype:"linkfield",fieldLabel:"目标数据",columnWidth:1,margin:d.margin,labelWidth:d.labelWidth,labelAlign:d.labelAlign,entityCode:c.entityCode,entityId:c.entityId,entityText:c.entityText,linkValue:f};d.items=[e,b];d.callParent(arguments)}});Ext.define("Fast.ext.Map",{alias:["widget.map","widget.mapfield"],extend:"Ext.form.FieldContainer",lngName:"lnt",latName:"lat",proName:null,cityName:null,areaName:null,editable:true,allowBlank:true,layout:"fit",submitValue:true,isValid:function(){var a=this;var b=a.down("[name="+a.name+"]");return b.isValid()},getName:function(){return this.name},getValue:function(){var a=this;var b=a.down("[name="+a.name+"]");return b.getValue()},setValue:function(d,a){var b=this;var c=b.down("[name="+b.name+"]");c.setValue(d);if(a){if(b.latName){b.setLatValue(a.get(b.latName))}if(b.lngName){b.setLngValue(a.get(b.lngName))}if(b.proName){b.setProValue(a.get(b.proName))}if(b.cityName){b.setCityValue(a.get(b.cityName))}if(b.areaName){b.setAreaValue(a.get(b.areaName))}}},setRecordValue:function(a){var b=this;if(a){if(a.store){a.store.holdUpdate=true}if(b.latName){a.set(b.latName,b.getLatValue())}if(b.lngName){a.set(b.lngName,b.getLngValue())}if(b.proName){a.set(b.proName,b.getProValue())}if(b.cityName){a.set(b.cityName,b.getCityValue())}if(b.areaName){a.set(b.areaName,b.getAreaValue())}if(a.store){a.store.holdUpdate=false}a.set(b.name,b.getValue())}},setLatValue:function(c){var a=this;var b=a.down("[name="+a.latName+"]");if(b){b.setValue(c)}},setLngValue:function(c){var b=this;var a=b.down("[name="+b.lngName+"]");if(a){a.setValue(c)}},setProValue:function(c){var a=this;var b=a.down("[name="+a.proName+"]");if(b){b.setValue(c)}},setCityValue:function(c){var a=this;var b=a.down("[name="+a.cityName+"]");if(b){b.setValue(c)}},setAreaValue:function(c){var b=this;var a=b.down("[name="+b.areaName+"]");if(a){a.setValue(c)}},getLatValue:function(){var a=this;var b=a.down("[name="+a.latName+"]");if(b){return b.getValue()}return 0},getLngValue:function(){var b=this;var a=b.down("[name="+b.lngName+"]");if(a){return a.getValue()}return 0},getProValue:function(){var a=this;var b=a.down("[name="+a.proName+"]");if(b){return b.getValue()}return null},getCityValue:function(){var a=this;var b=a.down("[name="+a.cityName+"]");if(b){return b.getValue()}return null},getAreaValue:function(){var b=this;var a=b.down("[name="+b.areaName+"]");if(a){return a.getValue()}return null},getMenu:function(){return this.up("menu")},selectData:function(){var a=this;if(a.getMenu()){a.getMenu().holdShow=true}var b=a.down("[name="+a.name+"]");b.blur();showMap(a,a.getLngValue(),a.getLatValue(),a.getValue()).then(function(c){if(c){a.setLatValue(c.lat);a.setLngValue(c.lng);a.setProValue(c.pro);a.setAreaValue(c.area);a.setCityValue(c.city);a.setValue(c.addr)}if(a.getMenu()){a.getMenu().holdShow=false}})},clearData:function(){var a=this;a.setValue(null);a.setLatValue(0);a.setLngValue(0)},initComponent:function(){var a=this;if(!a.name){a.name=a.dataIndex}if(Ext.isEmpty(a.name)){a.name="MapField"+Ext.now()}a.items=[{xtype:"hiddenfield",name:a.lngName,value:0},{xtype:"hiddenfield",name:a.latName,value:0},{xtype:"hiddenfield",name:a.proName},{xtype:"hiddenfield",name:a.cityName},{xtype:"hiddenfield",name:a.areaName},{xtype:"textfield",name:a.name,editable:a.editable,fieldLabel:a.fieldLabel,hideLabel:true,allowBlank:a.allowBlank,emptyText:a.emptyText,listeners:{afterrender:function(b){if(!this.editable){b.inputEl.on("click",function(){a.selectData()})}}},triggers:{close:{cls:"text-clear",handler:function(){a.clearData();if(Ext.isFunction(a.onClearValue)){a.onClearValue()}}},search:{cls:"text-search",handler:function(){a.selectData();this.inputEl.blur()}}}}];a.callParent(arguments)}});var power={types:["gridcolumn","button","menuitem"],config:false,menuShowing:false,powers:{},defaultPower:{show:true,edit:true},hasPower:function(b,a){if(b.managerPower){if(b.managerPower.hasOwnProperty(a)){return b.managerPower[a]}}return true},checkPower:function(d){var c=this;if(!c.powers.hasOwnProperty(d)){c.powers[d]=copy(c.defaultPower)}var b=c.powers[d];for(var a in c.defaultPower){if(!b.hasOwnProperty(a)){b[a]=c.defaultPower[a]}}return b},checkManagerPower:function(c){if(!system.manager||Ext.isEmpty(system.manager.managerExtPower)){return null}if(system.manager.role.roleType==0){return null}if(!system.managerPowers){system.managerPowers=jsonToObject(system.manager.managerExtPower)}if(!system.managerPowers){system.managerPowers={}}var b=system.managerPowers[c.code];if(b){for(var a in power.defaultPower){if(!b.hasOwnProperty(a)){b[a]=power.defaultPower[a]}}}return b},pushPower:function(c,a){var b=this;b.powers[c]=a},savePower:function(){var a=this;return Ext.encode(a.powers)}};Ext.override(Ext.Component,{afterRender:Ext.Function.createSequence(Ext.Component.prototype.afterRender,function(){if(!isSystem()){return}var a=this;if(!Ext.isEmpty(a.power)&&!a.power){return}if(a.up("[power=false]")){return}if(a.getXTypes().indexOf("field/")>0||Ext.Array.contains(power.types,a.getXType())||a.power){a.code=getPowerCode(a);if(a.code){a.managerPower=power.checkManagerPower(a);if(!power.hasPower(a,"show")){a.hideable=false;a.setHidden(true);a.setDisabled(true);a.clearListeners();if(Ext.isFunction(a.collapse)){a.collapse()}}else{if(!power.hasPower(a,"edit")){a.editable=false;if(Ext.isFunction(a.setReadOnly)){a.setReadOnly(true)}}}if(power.config){a.powerConfig=power.checkPower(a.code);setPowerStyle(a);a.getEl().on("contextmenu",function(d,c,b){d.stopEvent();showPowerConfig(a,d)})}}}})});Ext.override(Ext.Component,{setDisabled:function(a){if(power.config){return this["enable"]()}return this[a?"disable":"enable"]()}});Ext.override(Ext.form.field.Base,{markInvalid:function(e){if(power.config){return}var c=this,a=c.ariaEl.dom,b=c.getActiveError(),d;c.setActiveErrors(Ext.Array.from(e));d=c.getActiveError();if(b!==d){c.setError(d);if(!c.ariaStaticRoles[c.ariaRole]&&a){a.setAttribute("aria-invalid",true)}}}});function getPowerCode(c){if(c!=null){var a=null;if(Ext.isFunction(c.up)){var b=c.up("window");if(b){a=b.getTitle()}}if(c.name){a+=c.name}if(c.title){a+=c.title}if(c.text){a+=c.text}if(c.subtext){a+=c.subtext}if(c.dataIndex){a+=c.dataIndex}if(Ext.isFunction(c.getFieldLabel)&&Ext.isEmpty(c.getFieldLabel())){a+=c.getFieldLabel()}if(a){return $.md5(a)}}return null}function showPowerConfig(f,d){if(!isSystem()){return}var c=power.checkPower(f.code);power.menuShowing=true;var a=Ext.create("Ext.panel.Panel",{layout:{type:"vbox",pack:"center"},border:0,defaults:{height:20,power:false},items:[{xtype:"checkbox",name:"updateAlert",checked:true,boxLabel:"允许显示",value:c.show,listeners:{change:function(i,h,e,g){c.show=h;setPowerStyle(f)}}},{xtype:"checkbox",name:"updateAlert",checked:true,boxLabel:"允许编辑",hidden:!isColumnType(f),value:c.edit,listeners:{change:function(i,h,e,g){c.edit=h;setPowerStyle(f)}}}]});var b=new Ext.menu.Menu({padding:"0 0 0 10",powerMenu:true,style:{background:"#ffffff"},items:[a],listeners:{beforehide:function(g,e){power.menuShowing=false;power.pushPower(f.code,c)}}});b.showAt(d.getXY())}function setPowerStyle(b){var a=Ext.all("[code="+b.code+"]");Ext.each(a,function(e,c){var d=power.checkPower(b.code);if(d){if(!d.show){e.addCls("no-show-power")}else{e.removeCls("no-show-power");if(!d.edit){e.addCls("no-edit-power")}else{e.removeCls("no-edit-power")}}}})}var renders={normal:function(b,a){return function(c){if(Ext.isEmpty(c)){return"<span style='color: #ccc;'>无</span>"}if(!b){b=""}if(!a){a=false}if(a){return b+c}return c+b}},money:function(){return function(a){if(Ext.isEmpty(a)){return"<span style='color: #ccc;'>无</span>"}return"￥"+a}},text:function(){return function(a){if(Ext.isEmpty(a)){return"<span style='color: #ccc;'>无</span>"}return"<span style='white-space: pre;'>"+a+"</span>"}},file:function(){return function(c,a,b){if(Ext.isEmpty(c)||c=="null"){return"<span style='color: #ccc;'>暂无文件</span>"}return'<a href="'+system.formatUrlVersion(c)+"\" target='_blank' >"+c.substring(c.lastIndexOf("/")+1)+"</a>"}},files:function(){return function(b,c,g,k,o,n,l,a){if(Ext.isEmpty(b)||b=="null"){return"<span style='color: #ccc;'>暂无文件</span>"}var f=[];if(!Ext.isEmpty(b)){try{f=Ext.decode(b)}catch(j){}}if(f.length==0){return"<span style='color: #ccc;'>暂无文件</span>"}if(a){var h="";for(var d=0;d<f.length;d++){h+=renders.file()(f[d])+"<br/>"}return h}return"<span style='color: #4279fa;'>共有"+f.length+"个文件！</span>"}},image:function(a){return function(d){var b="16px";if(Ext.isEmpty(d)||d=="null"){return"<img style='border:1px solid #cccccc;height:"+b+";' src='images/default_img.png'   />"}try{if(a){b=a+"px"}}catch(c){}return"<img style='border:1px solid #cccccc;height:"+b+";' onerror=\"javascript:this.src='images/default_img.png';\" onclick=\"showImage(this,'"+system.formatUrlVersion(d)+"')\"  src='"+system.formatUrlVersion(d)+"'   />"}},images:function(){return function(b,c,g,k,o,n,l,a){if(Ext.isEmpty(b)||b=="null"){return"<span style='color: #ccc;'>暂无图片</span>"}var f=b;if(Ext.isString(b)){if(!Ext.isEmpty(b)){try{f=Ext.decode(b)}catch(j){}}}if(f.length==0){return"<span style='color: #ccc;'>暂无图片</span>"}if(a){var h="";for(var d=0;d<f.length;d++){h+=renders.image(24)(f[d])+"&nbsp;&nbsp;"}return h}return"<span style='color: #4279fa;'>共有"+f.length+"张图片！</span>"}},html:function(){return function(g,a,c,h,e,d,b,f){if(Ext.isEmpty(g)){return"<span style='color: #ccc;'>无</span>"}return g.replace(/<[^>]+>/g,"")}},link:function(b,c,a){return function(h,d,e){if(Ext.isEmpty(h)||h=="null"){return"<span style='color: #ccc;'>无</span>"}var f=e.get(b);var g="new "+c+"().showDetails(null, {'t."+a+"':'"+f+"'});";return'<a href="javascript:'+g+"\" target='_blank' >"+h+"</a>"}},target:function(a,c,b){return function(j,e,g){if(Ext.isEmpty(j)||j=="null"){return"<span style='color: #ccc;'>无</span>"}if(!b){b="getTargetEntity"}if(!Ext.isFunction(window[b])){return j}var d=g.get(c);var f=g.get(a);var h=window[b](d,c);var i="new "+h.entityCode+"().showDetails(null, {'t."+h.entityId+"':'"+f+"'});";return'<a href="javascript:'+i+"\" target='_blank' >"+j+"</a>"}},map:function(a,b){return function(i,d,e){if(Ext.isEmpty(i)||i=="null"){return"<span style='color: #ccc;'>无</span>"}var f=e.get(a);var g=e.get(b);if(f&&g){var c=f+","+g;var h="showAddressInMap(null,'"+c+"')";return'<a href="javascript:'+h+"\" target='_blank' >"+i+"</a>"}return i}},password:function(){return function(g,a,c,h,e,d,b,f){if(Ext.isEmpty(g)){return"<span style='color: #ccc;'>无</span>"}return"<span>******</span>"}}};renders["enum"]=function(a){return function(b){if(Ext.isEmpty(b)){return"<span style='color: #ccc;'>无</span>"}return getEnumText(a,b)}};server={logout:function(){$.post("manager/logout",function(){addScript({src:"base/login/login.js?v="+getExt("version").value})})},updateEntity:function(b,a){if(isPower()){a(false,"当前正在进行界面权限配置，不可修改数据！");return}$.post("entity/update",b,function(c){if(Ext.isFunction(a)){if(c.success){a(true)}else{a(false,c.message)}}})},deleteEntity:function(b,a){if(isPower()){a(false,"当前正在进行界面权限配置，不可删除数据！");return}$.post("entity/delete",b,function(c){if(Ext.isFunction(a)){a(c.success,c.message)}})},copyEntity:function(b,a){if(isPower()){a(false,"当前正在进行界面权限配置，不可复制数据！");return}$.post("entity/copy",b,function(c){if(Ext.isFunction(a)){if(c.success){a(true)}else{a(false,c.message)}}})},showExtConfig:function(a,b,c){if(isPower()){c(false);return}var d={configKey:a,configType:b};$.post("ext/config/showExtConfig",d,function(e){if(Ext.isFunction(c)){if(e.success){c(true,e.data.configValue)}else{c(false,null,e.message)}}})},saveExtConfig:function(b,c,e,d,a){if(isPower()){d(false);return}var f={configKey:b,configType:c,configValue:e};if(!Ext.isEmpty(a)){f=mergeJson(f,a)}$.post("ext/config/saveExtConfig",f,function(g){if(Ext.isFunction(d)){if(g.success){d(true)}else{d(false,g.message)}}})},deleteExtConfig:function(a,b,c){if(isPower()){c(false);return}var d={configKey:a,configType:b};$.post("ext/config/deleteExtConfig",d,function(e){if(Ext.isFunction(c)){if(e.success){c(true)}else{c(false,e.message)}}})},exportExcel:function(b,a){if(isPower()){a(false,"当前正在进行界面权限配置，不可导出数据！");return}$.post("entity/export",b,function(c){if(Ext.isFunction(a)){if(c.success){a(true,c.data)}else{a(false,null,c.message)}}})},excelModule:function(b,a){if(isPower()){a(false,"当前正在进行界面权限配置，不可生成模板！");return}$.post("entity/module",b,function(c){if(Ext.isFunction(a)){if(c.success){a(true,c.data)}else{a(false,null,c.message)}}})},showColumns:function(b,a){$.post("ext/config/showEntityColumn?entityCode="+b,function(c){if(Ext.isFunction(a)){if(c.success){a(true,c.data.configValue)}else{a(false,null,c.message)}}})},getIcon:function(c,a){var b="icons/"+c;if(Ext.isEmpty(a)){return b}if(a.startWith("#")){a=a.substring(1)}return"icon?path="+b+"&color="+a},showSystemConfig:function(a){$.post("ext/config/showSystemConfig",function(b){if(Ext.isFunction(a)){if(b.success){a(true,b.data)}else{a(false,null,b.message)}}})},deleteSystemConfig:function(a){$.post("ext/config/deleteSystemConfig",function(b){if(Ext.isFunction(a)){a(b.success,b.message)}})}};function commitStoreUpdate(a){return new Ext.Promise(function(k,m){if(!a.entity){return}if(a.commiting){return}var b=a.getUpdatedRecords();var g=a.getNewRecords();b=b.concat(g);if(b.length==0){return}a.commiting=true;var c={entityCode:a.entity.entityCode};if(a.entity.menu){c.menu=a.entity.menu.text}for(var e=0;e<b.length;e++){var f=b[e];for(var d=0;d<a.entity.idProperty.length;d++){var l=a.entity.idProperty[d];c["data["+e+"]."+l]=f.get(l)}for(var h in f.modified){c["data["+e+"]."+h]=f.get(h)}}server.updateEntity(c,function(j,i){k(j);if(j){toast("修改成功!");a.commitChanges();a.commiting=false}else{Ext.Msg.alert("系统提醒",i)}})})}function commitStoreDelete(a,b){return new Ext.Promise(function(h,g){if(!a.entity){return}var k={entityCode:a.entity.entityCode};if(a.entity.menu){k.menu=a.entity.menu.text}for(var f=0;f<b.length;f++){var c=b[f];for(var e=0;e<a.entity.idProperty.length;e++){var d=a.entity.idProperty[e];k["data["+f+"]."+d]=c.get(d)}}server.deleteEntity(k,function(l,j){h(l);if(l){toast("删除成功!");var i=a.currentPage;if(a.count()-b.length<=0){i=i-1}a.loadPage(Math.max(i,1))}else{Ext.Msg.alert("系统提醒",j)}})})}function commitStoreCopy(a,b){return new Ext.Promise(function(h,g){if(!a.entity){return}var k={entityCode:a.entity.entityCode};if(a.entity.menu){k.menu=a.entity.menu.text}for(var f=0;f<b.length;f++){var c=b[f];for(var e=0;e<a.entity.idProperty.length;e++){var d=a.entity.idProperty[e];k["data["+f+"]."+d]=c.get(d)}}server.copyEntity(k,function(l,j){h(l);if(l){toast("复制成功!");var i=a.currentPage;if(a.count()-b.length<=0){i=i-1}a.loadPage(Math.max(i,1))}else{Ext.Msg.alert("系统提醒",j)}})})}function isModified(a){for(var b in a.data){try{if(a.isModified(b)){return true}}catch(c){}}return false}function getEntityDataStore(entity,where,tree){if(Ext.isEmpty(entity)){showAlert("系统提醒","参数entity不可为空！");return}var config={fields:[],pageSize:10,where:where,entity:entity,remoteSort:true,proxy:{type:"ajax",url:"entity/list",actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(obj,request,operation,eOpts){var data=eval("("+request.responseText+")");if(!data.success){Ext.Msg.alert("数据获取失败",data.message)}}},reader:{type:"json",root:"list",totalProperty:"totalRow"}},listeners:{endupdate:function(eOpts){},beforeload:function(store,options){try{var params=store.proxy.extraParams;var newParams={entityCode:store.entity.entityCode,limit:store.pageSize};if(store.where){for(var w in store.where){newParams["where['"+w+"']"]=store.where[w]}}if(tree){if(Ext.isEmpty(tree.parentIdValue)){tree.parentIdValue=-1}newParams.page=-1;var parentValue=options.node.data[tree.idName];if(Ext.isEmpty(parentValue)){parentValue=tree.parentIdValue}if(store.grid){if(!hasSearchColumn(store.grid)){newParams["where['"+tree.parentIdName+"']"]=parentValue}else{newParams["where['"+tree.parentIdName+"']"]=null}}else{newParams["where['"+tree.parentIdName+"']"]=parentValue}}if(store.grid){if(store.grid.getSelection().length>0){store.grid.getSelectionModel().deselectAll()}else{store.grid.fireEvent("selectionchange",store.grid)}if(store.grid.where){for(var w in store.grid.where){newParams["where['"+w+"']"]=store.grid.where[w]}}store.getSorters().each(function(item){newParams["indexSort['"+item.getProperty()+"']"]=getColumn(store.grid,item.getProperty()).getIndex()})}Ext.apply(store.proxy.extraParams,mergeJson(params,newParams));return true}catch(e){showException(e,"store:beforeload")}}}};if(tree){return Ext.create("Ext.data.TreeStore",config)}config.autoLoad=false;return Ext.create("Ext.data.Store",config)}function getEnumDataStore(d){var c=$.md5(d);if(MemoryCache.hasOwnProperty(c)){var a=Ext.create("Ext.data.Store",{autoLoad:false,fields:["id","text"],enumName:d,data:MemoryCache[c]});return a}Ext.Ajax.request({url:"showEnums?enumName="+d,async:false,success:function(g,h){try{var f=Ext.decode(g.responseText);if(f.success){MemoryCache[c]=f.data}else{Ext.Msg.alert("枚举获取失败",f.message)}}catch(i){showException(i,"获取枚举数据源！[getEnumDataStore]")}}});var b=Ext.create("Ext.data.Store",{autoLoad:false,enumName:d,fields:["id","text"],data:MemoryCache[c]});return b}function getEnumText(b,a){return getEnumDataStore(b).findRecord("id",a).get("text")}function getPageDataStore(g,d){if(g==null||g.length==0){g=100}if(d==null||d.length==0){d=10}var a=new Array();for(var c=0;c<g/10;c++){var e=((c+1)*d)+"条";var f=((c+1)*d);a[c]={text:e,id:f}}var b=Ext.create("Ext.data.Store",{id:"pageSizeDataStore",fields:["id","text"],data:a});return b}function getCompareDataStore(){return Ext.create("Ext.data.Store",{data:[{id:0,text:"=",desc:"等于"},{id:1,text:"!=",desc:"不等于"},{id:2,text:"?",desc:"包含"},{id:3,text:"!?",desc:"不包含"},{id:4,text:">",desc:"大于"},{id:5,text:"<",desc:"小于"},{id:6,text:">=",desc:"大等于"},{id:7,text:"<=",desc:"小等于"}]})}function getYesOrNoDataStore(){return Ext.create("Ext.data.Store",{id:"yesOrNoDataStore",fields:["id","text"],data:[{text:"是",id:1},{text:"否",id:0}]})}Ext.override(Ext.Window,{initComponent:Ext.Function.createSequence(Ext.Window.prototype.initComponent,function(){try{if(!eval(getExt("window-anim").value)){this.animateTarget=null}}catch(e){console.error(e)}})});Ext.override(Ext.window.Window,{show:Ext.Function.createSequence(Ext.window.Window.prototype.show,function(){var a=this;a.toFront(true);a.focus()})});function showWait(d){Ext.MessageBox.show({alwaysOnTop:true,modal:true,title:"系统提醒",msg:d,progressText:"请耐心等待，即将完成操作",progress:true,closable:false});var b=0;var a=100;var c=function(){if(Ext.MessageBox.isHidden()){return}b=b+0.5;if(b==a+30){b=0}var e=b/a;Ext.MessageBox.updateProgress(e,"请耐心等待，即将完成操作");setTimeout(c,5)};setTimeout(c,5)}function hideWait(){if(Ext.MessageBox.isVisible()){Ext.MessageBox.hide()}}function toast(a){Ext.toast({html:a,closable:true,align:"t",slideInDuration:200,slideBackDuration:200,minWidth:120,slideBackAnimation:"easeOut",iconCls:"extIcon extInfo",title:"消息"})}function showHtml(c,d,a){var b=Ext.create("Ext.window.Window",{title:d,layout:"fit",height:500,width:600,resizable:false,maximizable:true,modal:true,maximized:false,iconCls:"extIcon extSee",draggable:true,scrollable:true,html:a,alwaysOnTop:true,toFrontOnShow:true});b.show()}function showText(c,a,e,d){var b=Ext.create("Ext.window.Window",{title:e,icon:a,maximizable:true,height:400,width:600,layout:"fit",animateTarget:c,items:[{xtype:"textarea",value:d}],modal:true,constrain:true,alwaysOnTop:true});b.show()}function showException(d,f){if(d==null){return}hideWait();console.error(d);var b=d;if(d instanceof Error){b=d.stack;b=b.replace(/\n/g,"<br/>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/ /g,"&nbsp;&nbsp;")}if(f!=null){f+="，来自"+f}else{f=""}var a=getExt("debug").value;if(a){var c=Ext.create("Ext.window.Window",{title:"系统异常"+f,height:180,width:270,layout:"fit",resizable:false,maximizable:false,fixed:true,modal:true,iconCls:"extIcon extError",html:"<div  style='padding:15px;background: #fff;' align='center'>系统发生异常，请及时告知系统管理员！</div>",buttons:[{text:"下次再说",flex:1,handler:function(){c.close()}},{text:"查看错误",flex:1,handler:function(){showHtml(this,"异常信息",b)}}]});c.show()}}function showAlert(c,a,b){Ext.Msg.alert(c,a,b)}function showImage(f,a,c,k){if(Ext.isEmpty(k)){k=false}var i=[{url:a}];var j=-1;if(Ext.getStore("ImageViewStore")!=null){var l=false;var d=Ext.getStore("ImageViewStore");d.each(function(m,n){if(m.get("url").split("?")[0]==a.split("?")[0]){l=true;Ext.getCmp("ImageViewGrid").getSelectionModel().select(n);return false}});if(!l){d.add(i);if(j==-1){j=d.count()-1}Ext.getCmp("ImageViewGrid").getSelectionModel().select(j)}return}else{if(j==-1){j=0}}var e=Ext.create("Ext.data.Store",{fields:["url"],autoLoad:false,id:"ImageViewStore",data:i});var b=Ext.create("Ext.grid.Panel",{store:e,region:"west",hideHeaders:true,id:"ImageViewGrid",width:100,disabled:true,border:1,scrollable:"y",columns:[{header:"文件",dataIndex:"url",flex:1,align:"center",renderer:function(m){if(Ext.isEmpty(m)){return"<span style='color: #ccc;'>无</span>"}return"<img width='30px' onerror=\"javascript:this.src='images/default_img.png';\" src='"+m+"'/>"}}],tbar:[{xtype:"button",border:1,text:"批量下载",handler:function(m){var n={};e.each(function(o,p){n["path"+p]=o.get("url")});console.log(n);buildForm("zipFile",n).submit()}}],listeners:{selectionchange:function(){try{var o=0;if(this.getStore().getCount()>1){this.setHidden(false);o=120}else{this.setHidden(true)}var m=this.getSelectionModel().getSelection();setTimeout(function(){imgViewFrame.window.showImage(system.formatUrl(m[0].get("url")),system.http)},o)}catch(n){showException(n,"showImage")}}}});window.imageViewerLoadDone=function(){Ext.getCmp("ImageViewGrid").setDisabled(false);try{var m=Ext.getStore("ImageViewStore").count()-1;Ext.getCmp("ImageViewGrid").getSelectionModel().select(m)}catch(n){showException(n,"showImage")}};window.imageViewerSize=function(n,m){Ext.getCmp("ImageViewWindow").setTitle("查看图片 "+n+"x"+m)};var h=Ext.create("Ext.panel.Panel",{layout:"fit",region:"center",border:1,height:"auto",html:'<div style="background: #000000;width: 100%;height: 100%;"></div>',listeners:{afterrender:function(n,m){if(e.getCount()<=1){b.setHidden(true)}else{b.setHidden(false)}n.update("<iframe name='imgViewFrame'  src='"+system.formatUrlVersion("base/image-view/index.html")+"' width='100%' height='100%' frameborder='0' scrolling='no' />")}},bbar:{xtype:"toolbar",dock:"bottom",layout:{type:"hbox",align:"middle",pack:"center"},items:[{xtype:"button",iconCls:"extIcon extZoomOut",handler:function(){imgViewFrame.window.zoomOut()}},{xtype:"button",iconCls:"extIcon extZoomIn",handler:function(){imgViewFrame.window.zoomIn()}},{xtype:"button",iconCls:"extIcon extOneOne",handler:function(){imgViewFrame.window.oneOne()}},{xtype:"button",iconCls:"extIcon extAround",handler:function(){imgViewFrame.window.rotate()}},{xtype:"button",iconCls:"extIcon extLeftRight",handler:function(){imgViewFrame.window.flipA()}},{xtype:"button",iconCls:"extIcon extTopBottom",handler:function(){imgViewFrame.window.flipB()}}]}});var g=Ext.create("Ext.window.Window",{title:"查看图片",height:500,width:600,id:"ImageViewWindow",layout:"border",iconCls:"extIcon extImage",resizable:true,alwaysOnTop:true,maximizable:true,modal:k,constrain:true,animateTarget:f,items:[b,h],listeners:{close:function(m){e.destroy();if(Ext.isFunction(c)){c()}}}});g.show()};